<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Di√°rio Emocional - TCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --bg-light: #f8f9fa;
            --text-dark: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #48bb78;
            --danger: #f56565;
            
            /* Vari√°veis para tema claro (padr√£o) */
            --bg-body: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode */
        body.dark-mode {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #8b5cf6;
            --bg-light: #1e293b;
            --text-dark: #f1f5f9;
            --text-light: #cbd5e1;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            
            --bg-body: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            padding-bottom: 80px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-card);
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s ease;
        }

        .header h1 {
            font-size: 24px;
            color: var(--primary);
            text-align: center;
            margin-bottom: 5px;
        }

        .header p {
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
        }

        .tabs {
            display: flex;
            background: var(--bg-card);
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .form-group label .emoji {
            font-size: 18px;
            margin-right: 5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .intensity-container {
            position: relative;
        }

        .intensity-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
            outline: none;
            -webkit-appearance: none;
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow);
            border: 3px solid var(--primary);
        }

        .intensity-value {
            text-align: center;
            margin-top: 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .emotions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .emotion-btn {
            padding: 15px 10px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .emotion-btn .emoji {
            display: block;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .emocao-nome {
            font-weight: 600;
            font-size: 14px;
            display: block;
            margin-bottom: 3px;
        }

        .emocao-explicacao {
            font-size: 10px;
            opacity: 0.85;
            line-height: 1.3;
            font-weight: 400;
            display: block;
            color: var(--text-dark);
        }

        .emotion-btn.selected {
            border-color: var(--primary);
            background: #f0f4ff;
            transform: scale(1.05);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px var(--shadow);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .btn-secondary:active {
            background: #e2e8f0;
            transform: scale(0.98);
        }

        .entries-list {
            margin-top: 10px;
        }

        .entry-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .entry-date {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .entry-field {
            margin-bottom: 15px;
        }

        .entry-field strong {
            display: block;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .entry-field p {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .emotion-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-light);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state .emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: var(--text-light);
            font-size: 16px;
        }

        .export-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            text-align: center;
            transition: background 0.3s ease;
        }

        .export-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        .footer-info {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            transition: background 0.3s ease;\n        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 1000;
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Cabe√ßalho de Boas-vindas */
        .welcome-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 25px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .greeting h2 {
            font-size: 28px;
            margin: 0;
            font-weight: 700;
        }

        .greeting p {
            font-size: 14px;
            margin: 5px 0 0 0;
            opacity: 0.95;
        }

        .welcome-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 380px) {
            .emotions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tela de Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 10000;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
            transition: background 0.3s ease;
        }

        .login-box h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-box p {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .signup-fields {
            margin-bottom: 20px;
        }

        .signup-fields input,
        .signup-fields select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .signup-fields input:focus,
        .signup-fields select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .terms-checkbox {
            margin: 15px 0;
            text-align: left;
        }

        .terms-checkbox label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
            color: var(--text-light);
            cursor: pointer;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .terms-checkbox a {
            color: var(--primary);
            text-decoration: none;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 10px;
        }

        .btn-login:hover {
            background: var(--primary-dark);
        }

        .btn-google {
            width: 100%;
            padding: 15px;
            background: white;
            color: var(--text-dark);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .divider {
            margin: 20px 0;
            color: var(--text-light);
            font-size: 14px;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .toggle-auth {
            margin-top: 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .toggle-auth a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .user-info {
            background: white;
            padding: 12px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .user-info .user-details {
            flex: 1;
        }

        .user-info .user-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .user-info .user-email {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 10001;
            color: white;
            font-size: 18px;
        }

        .loading.hidden,
        .hidden {
            display: none !important;
        }

        .sync-status {
            font-size: 10px;
            color: var(--success);
            margin-top: 2px;
        }

        .app-wrapper {
            display: none;
        }

        .app-wrapper.active {
            display: block;
        }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Tela de Loading -->
    <div id="loadingScreen" class="loading">
        <div>‚è≥ Carregando...</div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container hidden">
        <div class="login-box">
            <h1>üìî Di√°rio Emocional</h1>
            <p>Fa√ßa login para acessar seus registros</p>

            <div id="authError" class="error-message hidden"></div>

            <!-- Campos extras para cadastro -->
            <div id="signupFields" class="signup-fields hidden">
                <input type="text" id="nomeCompleto" placeholder="Nome completo *" required>
                <input type="date" id="dataNascimento" placeholder="Data de nascimento">
                <select id="genero">
                    <option value="">G√™nero (opcional)</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-informar">Prefiro n√£o informar</option>
                </select>
            </div>

            <div class="login-form">
                <input type="email" id="emailInput" placeholder="Email" autocomplete="email">
                <input type="password" id="passwordInput" placeholder="Senha (m√≠nimo 6 caracteres)" autocomplete="current-password">
                
                <!-- Checkbox de termos (s√≥ aparece no cadastro) -->
                <div id="termsCheckbox" class="terms-checkbox hidden">
                    <label>
                        <input type="checkbox" id="acceptTerms">
                        <span>Aceito os <a href="#" onclick="mostrarTermos(); return false;">termos de uso</a> e <a href="#" onclick="mostrarPrivacidade(); return false;">pol√≠tica de privacidade</a></span>
                    </label>
                </div>
                
                <button class="btn-login" onclick="handleEmailAuth()">
                    <span id="authButtonText">Entrar</span>
                </button>
            </div>

            <div class="divider">ou</div>

            <button class="btn-google" onclick="handleGoogleAuth()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar com Google
            </button>

            <div class="toggle-auth">
                <span id="toggleText">N√£o tem conta?</span>
                <a onclick="toggleAuthMode()"><span id="toggleLink">Criar conta</span></a>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="appScreen" class="app-wrapper">
        <!-- Cabe√ßalho com sauda√ß√£o personalizada -->
        <div class="welcome-header">
            <div class="greeting">
                <h2 id="greetingMessage">Ol√°!</h2>
                <p id="currentDateTime"></p>
            </div>
            <div class="welcome-actions">
                <button class="btn-theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <span id="themeIcon">üåô</span>
                </button>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>

        <div class="user-info">
            <div class="user-details">
                <div class="user-name" id="userName">Usu√°rio</div>
                <div class="user-email" id="userEmail">email@exemplo.com</div>
                <div class="sync-status" id="syncStatus">‚úì Sincronizado</div>
            </div>
        </div>


    <div class="header">
        <h1>üìî Di√°rio Emocional</h1>
        <p>Registro para Terapia Cognitivo-Comportamental</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('novo', event)">‚ûï Novo</button>
        <button class="tab" onclick="showTab('historico', event)">üìñ Hist√≥rico</button>
        <button class="tab" onclick="showTab('exportar', event)">üì§ Exportar</button>
    </div>

    <!-- TAB: NOVO REGISTRO -->
    <div id="novo" class="tab-content active">
        <div class="form-group">
            <label><span class="emoji">üìÖ</span> Data e Hora</label>
            <input type="datetime-local" id="dataHora">
        </div>

        <div class="form-group">
            <label><span class="emoji">üìç</span> Situa√ß√£o</label>
            <textarea id="situacao" placeholder="O que aconteceu? Onde voc√™ estava? Com quem?"></textarea>
        </div>

        <div class="form-group">
            <label><span class="emoji">üí≠</span> Pensamento Autom√°tico</label>
            <textarea id="pensamento" placeholder="O que passou pela sua cabe√ßa naquele momento?"></textarea>
        </div>

        <div class="form-group">
            <label><span class="emoji">‚ù§Ô∏è</span> Emo√ß√£o Principal</label>
            <div class="emotions-grid" id="emotionsGrid"></div>
        </div>

        <div id="intermediariasDiv"></div>
        <div id="especificasDiv"></div>

        <div class="form-group">
            <label><span class="emoji">üéöÔ∏è</span> Intensidade da Emo√ß√£o (0-10)</label>
            <div class="intensity-container">
                <input type="range" min="0" max="10" value="5" class="intensity-slider" id="intensidade">
                <div class="intensity-value" id="intensidadeValor">5</div>
            </div>
        </div>

        <div class="form-group">
            <label><span class="emoji">üé≠</span> Comportamento</label>
            <textarea id="comportamento" placeholder="Como voc√™ reagiu? O que fez depois?"></textarea>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="limparFormulario()">üîÑ Limpar</button>
            <button class="btn btn-primary" onclick="salvarRegistro()">üíæ Salvar</button>
        </div>
    </div>

    <!-- TAB: HIST√ìRICO -->
    <div id="historico" class="tab-content">
        <div class="entries-list" id="entriesList"></div>
    </div>

    <!-- TAB: EXPORTAR -->
    <div id="exportar" class="tab-content">
        <div class="stats-grid" id="statsGrid"></div>

        <div class="export-section">
            <h3>üìä Exportar Dados</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Baixe seus registros para compartilhar com seu terapeuta ou fazer backup
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportarPDF()">üìÑ PDF</button>
                <button class="btn btn-primary" onclick="exportarJSON()">JSON</button>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="exportarCSV()">CSV</button>
                <button class="btn btn-primary" onclick="exportarTexto()">Texto</button>
            </div>
        </div>

        <div class="export-section">
            <h3>‚öôÔ∏è Configura√ß√µes</h3>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="limparTodosDados()">üóëÔ∏è Limpar Tudo</button>
            </div>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const emocoesCores = {
            'Raiva': '#E18AB8',
            'Tristeza': '#4A63A5',
            'Surpresa': '#70C1CF',
            'Alegria': '#AFD799',
            'Amor': '#E7E26B',
            'Medo': '#E88C5B'
        };

        const emocoesCoresEspecificas = {
            '√ìdio': '#E18AB8',
            'Hostilidade': '#E18AB8',
            'Agita√ß√£o': '#E18AB8',
            'Frustra√ß√£o': '#E18AB8',
            'Irrita√ß√£o': '#E18AB8',
            'Provoca√ß√£o': '#E18AB8',
            'Ci√∫mes': '#E18AB8',
            'Ressentimento': '#E18AB8',
            'Desespero': '#E18AB8',
            'Revoltado': '#E18AB8',
            'Agoniado': '#4A63A5',
            'Machucado': '#4A63A5',
            'Depress√£o': '#4A63A5',
            'Pesar': '#4A63A5',
            'Consternado': '#4A63A5',
            'Desagradado': '#4A63A5',
            'Arrependimento': '#4A63A5',
            'Culpa': '#4A63A5',
            'Isolamento': '#4A63A5',
            'Solit√°rio': '#4A63A5',
            'Luto': '#4A63A5',
            'Impot√™ncia': '#4A63A5',
            'Chocado': '#70C1CF',
            'Desiludido': '#70C1CF',
            'Perplexo': '#70C1CF',
            'At√¥nito': '#70C1CF',
            'Impressionado': '#70C1CF',
            'Sem palavras': '#70C1CF',
            'Espantado': '#70C1CF',
            'Estimulado': '#70C1CF',
            'Tocado': '#70C1CF',
            'Gozo': '#AFD799',
            'Saciado': '#AFD799',
            'Divertido': '#AFD799',
            'Deleite': '#AFD799',
            'Jovial': '#AFD799',
            'Aben√ßoado': '#AFD799',
            'Triunfante': '#AFD799',
            'Famoso': '#AFD799',
            'Esperan√ßoso': '#AFD799',
            'Ansioso': '#AFD799',
            'Excitado': '#AFD799',
            'Zelo': '#AFD799',
            'J√∫bilo': '#AFD799',
            'Euforia': '#AFD799',
            '√äxtase': '#AFD799',
            'Sedu√ß√£o': '#AFD799',
            'Pleno': '#E7E26B',
            'Liberdade': '#E7E26B',
            'Compaix√£o': '#E7E26B',
            'Cuidado': '#E7E26B',
            'Fasc√≠nio': '#E7E26B',
            'Paix√£o': '#E7E26B',
            'Atra√ß√£o': '#E7E26B',
            'Sens√≠vel': '#E7E26B',
            'Carinho': '#E7E26B',
            'Rom√¢ntico': '#E7E26B',
            'Pavor': '#E88C5B',
            'Mortificado': '#E88C5B',
            'Ansiedade': '#E88C5B',
            'Preocupa√ß√£o': '#E88C5B',
            'Inadequa√ß√£o': '#E88C5B',
            'Inferioridade': '#E88C5B',
            'Histeria': '#E88C5B',
            'P√¢nico': '#E88C5B',
            'Amedrontado': '#E88C5B',
            'Abandono': '#E88C5B'
        };

        const emocoesExplicacoes = {
            // Raiva
            '√ìdio': 'Avers√£o intensa e profunda, desejo de afastar ou eliminar algo/algu√©m',
            'Hostilidade': 'Atitude antagonista e agressiva, postura de oposi√ß√£o',
            'Agita√ß√£o': 'Estado de inquieta√ß√£o e perturba√ß√£o, dificuldade de se acalmar',
            'Frustra√ß√£o': 'Sentimento de desapontamento quando expectativas n√£o s√£o atendidas',
            'Irrita√ß√£o': 'Inc√¥modo e impaci√™ncia com situa√ß√µes ou pessoas',
            'Provoca√ß√£o': 'Sensa√ß√£o de estar sendo testado ou desafiado de forma negativa',
            'Ci√∫mes': 'Receio de perder algo/algu√©m para outro, possessividade',
            'Ressentimento': 'M√°goa guardada, sentimento de injusti√ßa n√£o resolvido',
            'Desespero': 'Perda de esperan√ßa, sensa√ß√£o de n√£o haver sa√≠da',
            'Revoltado': 'Indigna√ß√£o extrema, rebeldia contra uma situa√ß√£o',

            // Tristeza
            'Agoniado': 'Sofrimento intenso, ang√∫stia emocional profunda',
            'Machucado': 'Ferido emocionalmente, dor emocional por algo que aconteceu',
            'Depress√£o': 'Estado de profunda tristeza e falta de energia/motiva√ß√£o',
            'Pesar': 'Sentimento de lamento e peso no cora√ß√£o',
            'Consternado': 'Perplexidade dolorosa, choque com algo negativo',
            'Desagradado': 'Descontentamento, falta de satisfa√ß√£o com situa√ß√£o',
            'Arrependimento': 'Remorso por algo que fez ou deixou de fazer',
            'Culpa': 'Sensa√ß√£o de responsabilidade por algo negativo, autocr√≠tica',
            'Isolamento': 'Sensa√ß√£o de estar separado dos outros, desconex√£o',
            'Solit√°rio': 'Sentimento de solid√£o, falta de companhia',
            'Luto': 'Dor pela perda de algu√©m ou algo importante',
            'Impot√™ncia': 'Sensa√ß√£o de n√£o ter poder para mudar a situa√ß√£o',

            // Surpresa
            'Chocado': 'Impacto emocional forte, dificuldade de processar o inesperado',
            'Desiludido': 'Decep√ß√£o ao perceber que algo n√£o era como parecia',
            'Perplexo': 'Confus√£o e incerteza diante do inesperado',
            'At√¥nito': 'Paralisado pela surpresa, estupefato',
            'Impressionado': 'Marcado positivamente por algo inesperado',
            'Sem palavras': 'Incapacidade de expressar o que sente diante da surpresa',
            'Espantado': 'Surpreso de forma intensa, admirado',
            'Estimulado': 'Energizado e motivado por algo novo',
            'Tocado': 'Emocionalmente afetado de forma sens√≠vel',

            // Alegria
            'Gozo': 'Prazer intenso, satisfa√ß√£o plena',
            'Saciado': 'Plenamente satisfeito, necessidades atendidas',
            'Divertido': 'Entretenimento e alegria por algo engra√ßado ou prazeroso',
            'Deleite': 'Prazer refinado, aprecia√ß√£o profunda',
            'Jovial': 'Alegria leve e descontra√≠da, bom humor',
            'Aben√ßoado': 'Gratid√£o por se sentir agraciado, sortudo',
            'Triunfante': 'Vit√≥ria e conquista, sensa√ß√£o de sucesso',
            'Famoso': 'Reconhecimento social, sentir-se valorizado por muitos',
            'Esperan√ßoso': 'Otimismo sobre o futuro, expectativa positiva',
            'Ansioso': 'Expectativa intensa (positiva) por algo desejado',
            'Excitado': 'Energia alta com antecipa√ß√£o positiva',
            'Zelo': 'Entusiasmo fervoroso, dedica√ß√£o apaixonada',
            'J√∫bilo': 'Alegria exuberante, celebra√ß√£o intensa',
            'Euforia': 'Felicidade extrema, √™xtase de alegria',
            '√äxtase': 'Estado m√°ximo de prazer e alegria',
            'Sedu√ß√£o': 'Atra√ß√£o magn√©tica, charme e encantamento',

            // Amor
            'Pleno': 'Completude interior, paz e satisfa√ß√£o profunda',
            'Liberdade': 'Sensa√ß√£o de autonomia e aus√™ncia de restri√ß√µes',
            'Compaix√£o': 'Empatia ativa, desejo de aliviar o sofrimento alheio',
            'Cuidado': 'Aten√ß√£o dedicada ao bem-estar de algu√©m',
            'Fasc√≠nio': 'Encantamento intenso, absor√ß√£o total',
            'Paix√£o': 'Amor intenso e ardente, desejo profundo',
            'Atra√ß√£o': 'Interesse magn√©tico por algu√©m, desejo de proximidade',
            'Sens√≠vel': 'Delicadeza emocional, receptividade afetiva',
            'Carinho': 'Afeto terno e gentil, ternura',
            'Rom√¢ntico': 'Amor idealizado, valoriza√ß√£o da beleza do relacionamento',

            // Medo
            'Pavor': 'Terror extremo, medo paralisante',
            'Mortificado': 'Constrangimento profundo misturado com medo',
            'Ansiedade': 'Apreens√£o com o futuro, preocupa√ß√£o antecipada',
            'Preocupa√ß√£o': 'Inquieta√ß√£o com poss√≠veis problemas',
            'Inadequa√ß√£o': 'Sensa√ß√£o de n√£o ser bom o suficiente',
            'Inferioridade': 'Sentir-se menor ou pior que os outros',
            'Histeria': 'Rea√ß√£o de medo descontrolada, perda de controle emocional',
            'P√¢nico': 'Medo s√∫bito e avassalador, rea√ß√£o de fuga',
            'Amedrontado': 'Estado de medo persistente, intimida√ß√£o',
            'Abandono': 'Medo de ser deixado sozinho, rejei√ß√£o'
        };

        const emocoesHierarquia = {
            'Raiva': {
                emoji: 'üò†',
                intermediarias: {
                    'Furioso': ['√ìdio', 'Hostilidade'],
                    'Exasperado': ['Agita√ß√£o', 'Frustra√ß√£o'],
                    'Irritado': ['Irrita√ß√£o', 'Provoca√ß√£o'],
                    'Inveja': ['Ci√∫mes', 'Ressentimento'],
                    'Desgosto': ['Desespero', 'Revoltado']
                }
            },
            'Tristeza': {
                emoji: 'üò¢',
                intermediarias: {
                    'Sofrimento': ['Agoniado', 'Machucado'],
                    'Tristeza': ['Depress√£o', 'Pesar'],
                    'Desapontamento': ['Consternado', 'Desagradado'],
                    'Vergonha': ['Arrependimento', 'Culpa'],
                    'Neglig√™ncia': ['Isolamento', 'Solit√°rio'],
                    'Desespero': ['Luto', 'Impot√™ncia']
                }
            },
            'Surpresa': {
                emoji: 'üò≤',
                intermediarias: {
                    'Atordoamento': ['Chocado', 'Consternado'],
                    'Confus√£o': ['Desiludido', 'Perplexo'],
                    'Espanto': ['At√¥nito', 'Impressionado'],
                    'Supera√ß√£o': ['Sem palavras', 'Espantado'],
                    'Abalado': ['Estimulado', 'Tocado']
                }
            },
            'Alegria': {
                emoji: 'üòä',
                intermediarias: {
                    'Satisfeito': ['Gozo', 'Saciado'],
                    'Feliz': ['Divertido', 'Deleite'],
                    'Animado': ['Aben√ßoado', 'Jovial'],
                    'Orgulhoso': ['Famoso', 'Triunfante'],
                    'Otimista': ['Esperan√ßoso', 'Ansioso'],
                    'Entusiasmo': ['Zelo', 'Excitado'],
                    'Exaltado': ['J√∫bilo', 'Euforia'],
                    'Encantado': ['√äxtase', 'Sedu√ß√£o']
                }
            },
            'Amor': {
                emoji: 'ü•∞',
                intermediarias: {
                    'Pac√≠fico': ['Pleno', 'Liberdade'],
                    'Afetuoso': ['Compaix√£o', 'Cuidado'],
                    'Desejoso': ['Fasc√≠nio', 'Paix√£o'],
                    'Nost√°lgico': ['Atra√ß√£o', 'Sens√≠vel'],
                    'Encantado': ['Carinho', 'Rom√¢ntico']
                }
            },
            'Medo': {
                emoji: 'üò®',
                intermediarias: {
                    'Horrorizado': ['Pavor', 'Mortificado'],
                    'Nervoso': ['Ansiedade', 'Preocupa√ß√£o'],
                    'Inseguro': ['Inadequa√ß√£o', 'Inferioridade'],
                    'Aterrorizado': ['Histeria', 'P√¢nico'],
                    'Assustado': ['Amedrontado', 'Abandono']
                }
            }
        };

        let emocaoSelecionada = {
            central: '',
            intermediaria: '',
            especifica: ''
        };

        function inicializarApp() {
            const agora = new Date();
            agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
            document.getElementById('dataHora').value = agora.toISOString().slice(0, 16);

            criarGridEmocoes();
            configurarSliderIntensidade();
            carregarHistorico();
            atualizarEstatisticas();
        }

        function criarGridEmocoes() {
            const grid = document.getElementById('emotionsGrid');
            const emocoesCentrais = Object.keys(emocoesHierarquia);

            grid.innerHTML = emocoesCentrais.map(nome => {
                const cor = emocoesCores[nome];
                return `
                    <button class="emotion-btn" onclick="selecionarEmocaoCentral('${nome}', this)"
                            style="border-color: ${cor}20; background: ${cor}10;">
                        <span class="emoji">${emocoesHierarquia[nome].emoji}</span>
                        ${nome}
                    </button>
                `;
            }).join('');
        }

        function selecionarEmocaoCentral(nome, btn) {
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.central = nome;
            emocaoSelecionada.intermediaria = '';
            emocaoSelecionada.especifica = '';

            // Mostrar emo√ß√µes intermedi√°rias
            const intermediariasDiv = document.getElementById('intermediariasDiv');
            const intermediarias = Object.keys(emocoesHierarquia[nome].intermediarias);
            const cor = emocoesCores[nome];

            intermediariasDiv.innerHTML = `
                <div class="form-group">
                    <label><span class="emoji">üéØ</span> Qual tipo de ${nome}?</label>
                    <div class="emotions-grid" id="intermediariasGrid">
                        ${intermediarias.map(inter => `
                            <button class="emotion-btn" onclick="selecionarIntermediaria('${inter}', this)"
                                    style="border-color: ${cor}40; background: ${cor}15;">
                                ${inter}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            // Limpar emo√ß√µes espec√≠ficas
            document.getElementById('especificasDiv').innerHTML = '';
        }

        function selecionarIntermediaria(nome, btn) {
            document.querySelectorAll('#intermediariasGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.intermediaria = nome;
            emocaoSelecionada.especifica = '';

            // Mostrar emo√ß√µes espec√≠ficas
            const especificasDiv = document.getElementById('especificasDiv');
            const especificas = emocoesHierarquia[emocaoSelecionada.central].intermediarias[nome];
            const cor = emocoesCores[emocaoSelecionada.central];

            especificasDiv.innerHTML = `
                <div class="form-group">
                    <label><span class="emoji">üîç</span> Mais especificamente:</label>
                    <div class="emotions-grid" id="especificasGrid">
                        ${especificas.map(esp => {
                            const corEspecifica = emocoesCoresEspecificas[esp] || cor;
                            const explicacao = emocoesExplicacoes[esp] || '';
                            return `
                                <button class="emotion-btn" onclick="selecionarEspecifica('${esp}', this)"
                                        style="border-color: ${corEspecifica}; background: ${corEspecifica}30;">
                                    <span class="emocao-nome">${esp}</span>
                                    <span class="emocao-explicacao">${explicacao}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function selecionarEspecifica(nome, btn) {
            document.querySelectorAll('#especificasGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.especifica = nome;
        }

        function configurarSliderIntensidade() {
            const slider = document.getElementById('intensidade');
            const valor = document.getElementById('intensidadeValor');
            slider.oninput = () => valor.textContent = slider.value;
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Se n√£o houver event, procurar a tab pelo onclick
                document.querySelectorAll('.tab').forEach(t => {
                    if (t.getAttribute('onclick')?.includes(tabName)) {
                        t.classList.add('active');
                    }
                });
            }

            document.getElementById(tabName).classList.add('active');

            if (tabName === 'historico') carregarHistorico();
            if (tabName === 'exportar') atualizarEstatisticas();
        }

        function salvarRegistro() {
            const dataHora = document.getElementById('dataHora').value;
            const situacao = document.getElementById('situacao').value.trim();
            const pensamento = document.getElementById('pensamento').value.trim();
            const intensidade = document.getElementById('intensidade').value;
            const comportamento = document.getElementById('comportamento').value.trim();

            if (!dataHora || !situacao || !pensamento || !emocaoSelecionada.central || !emocaoSelecionada.intermediaria || !emocaoSelecionada.especifica || !comportamento) {
                mostrarToast('‚ö†Ô∏è Preencha todos os campos, incluindo todos os n√≠veis da emo√ß√£o!');
                return;
            }

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado para salvar!');
                return;
            }

            const registro = {
                id: Date.now(),
                dataHora,
                situacao,
                pensamento,
                emocaoCentral: emocaoSelecionada.central,
                emocaoIntermediaria: emocaoSelecionada.intermediaria,
                emocaoEspecifica: emocaoSelecionada.especifica,
                intensidade,
                comportamento
            };

            // Salvar APENAS no Firebase
            console.log('‚òÅÔ∏è Salvando registro no Firebase...');
            salvarRegistroFirebase(registro).then(firebaseId => {
                if (firebaseId) {
                    // Adicionar √† mem√≥ria local
                    registro.firebaseId = firebaseId;
                    registrosEmMemoria.push(registro);
                    console.log('‚úÖ Registro salvo com sucesso! Firebase ID:', firebaseId);
                    document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                } else {
                    mostrarToast('‚ùå Erro ao salvar no Firebase');
                }
            }).catch(err => {
                console.error('‚ùå Erro ao salvar:', err);
                mostrarToast('‚ùå Erro ao salvar no Firebase');
                document.getElementById('syncStatus').textContent = '‚ö† Erro na sincroniza√ß√£o';
            });

            mostrarToast('‚úÖ Registro salvo com sucesso!');
            limparFormulario();
            setTimeout(() => showTab('historico'), 1500);
        }

        function limparFormulario() {
            document.getElementById('situacao').value = '';
            document.getElementById('pensamento').value = '';
            document.getElementById('comportamento').value = '';
            document.getElementById('intensidade').value = 5;
            document.getElementById('intensidadeValor').textContent = '5';
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            emocaoSelecionada = {
                central: '',
                intermediaria: '',
                especifica: ''
            };
            document.getElementById('intermediariasDiv').innerHTML = '';
            document.getElementById('especificasDiv').innerHTML = '';

            const agora = new Date();
            agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
            document.getElementById('dataHora').value = agora.toISOString().slice(0, 16);
        }

        // Armazena registros em mem√≥ria (carregados do Firebase)
        let registrosEmMemoria = [];

        function getRegistros() {
            return registrosEmMemoria.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
        }

        function carregarHistorico() {
            const registros = getRegistros().sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            const lista = document.getElementById('entriesList');

            if (registros.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üìù</div>
                        <p>Nenhum registro ainda.<br>Comece fazendo seu primeiro registro!</p>
                    </div>
                `;
                return;
            }

            lista.innerHTML = registros.map(r => {
                const data = new Date(r.dataHora);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                const horaFormatada = data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

                // Suporte para registros antigos e novos
                const emocaoCentral = r.emocaoCentral || r.emocao || 'N√£o especificada';
                const emocaoIntermediaria = r.emocaoIntermediaria || '';
                const emocaoEspecifica = r.emocaoEspecifica || '';
                const cor = emocoesCores[emocaoCentral] || '#667eea';
                const emojiEmocao = emocoesHierarquia[emocaoCentral]?.emoji || '‚ù§Ô∏è';

                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div class="entry-date">üìÖ ${dataFormatada} √†s ${horaFormatada}</div>
                            <div class="entry-actions">
                                <button class="icon-btn" onclick="deletarRegistro(${r.id})">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="entry-field">
                            <strong>Situa√ß√£o</strong>
                            <p>${r.situacao}</p>
                        </div>

                        <div class="entry-field">
                            <strong>Pensamento Autom√°tico</strong>
                            <p>${r.pensamento}</p>
                        </div>

                        <div class="entry-field">
                            <strong>Emo√ß√£o e Intensidade</strong>
                            <div class="emotion-badge" style="background: ${cor}15; border: 2px solid ${cor}40; flex-wrap: wrap;">
                                <span style="font-size: 20px;">${emojiEmocao}</span>
                                <span style="font-weight: bold; color: ${cor};">${emocaoCentral}</span>
                                ${emocaoIntermediaria ? `<span>‚Üí ${emocaoIntermediaria}</span>` : ''}
                                ${emocaoEspecifica ? `<span>‚Üí ${emocaoEspecifica}</span>` : ''}
                            </div>
                            <div style="margin-top: 8px; font-weight: bold; color: ${cor}; font-size: 18px;">
                                Intensidade: ${r.intensidade}/10
                            </div>
                        </div>

                        <div class="entry-field">
                            <strong>Comportamento</strong>
                            <p>${r.comportamento}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deletarRegistro(id) {
            if (!confirm('Tem certeza que deseja deletar este registro?')) return;

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            // Encontrar o registro para pegar o firebaseId
            const registro = registrosEmMemoria.find(r => r.id === id);
            const firebaseId = registro?.firebaseId;

            if (!firebaseId) {
                mostrarToast('‚ö†Ô∏è Erro: registro sem ID do Firebase');
                return;
            }

            // Deletar APENAS do Firebase
            console.log('‚òÅÔ∏è Excluindo registro do Firebase...', firebaseId);
            excluirRegistroFirebase(firebaseId).then(() => {
                // Remover da mem√≥ria
                registrosEmMemoria = registrosEmMemoria.filter(r => r.id !== id);
                console.log('‚úÖ Registro exclu√≠do do Firebase!');
                carregarHistorico();
                atualizarEstatisticas();
                mostrarToast('üóëÔ∏è Registro deletado');
            }).catch(err => {
                console.error('‚ùå Erro ao excluir do Firebase:', err);
                mostrarToast('‚ùå Erro ao excluir');
            });
        }

        function atualizarEstatisticas() {
            const registros = getRegistros();
            const total = registros.length;

            let somaIntensidade = 0;
            const contagemEmocoes = {};

            registros.forEach(r => {
                somaIntensidade += parseInt(r.intensidade);
                const emocao = r.emocaoCentral || r.emocao || 'N√£o especificada';
                contagemEmocoes[emocao] = (contagemEmocoes[emocao] || 0) + 1;
            });

            const mediaIntensidade = total > 0 ? (somaIntensidade / total).toFixed(1) : 0;
            const emocaoMaisFrequente = total > 0
                ? Object.keys(contagemEmocoes).reduce((a, b) => contagemEmocoes[a] > contagemEmocoes[b] ? a : b)
                : 'N/A';

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">REGISTROS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${mediaIntensidade}</div>
                    <div class="stat-label">INTENSIDADE M√âDIA</div>
                </div>
                <div class="stat-card" style="grid-column: 1 / -1;">
                    <div class="stat-value">${emocaoMaisFrequente}</div>
                    <div class="stat-label">EMO√á√ÉO MAIS FREQUENTE</div>
                </div>
            `;
        }

        function exportarPDF() {
            const registros = getRegistros();
            if (registros.length === 0) {
                mostrarToast('‚ö†Ô∏è Nenhum registro para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;
            const margemEsquerda = 15;
            const larguraPagina = 180;
            const alturaPagina = 280;

            // Cabe√ßalho
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('DI√ÅRIO EMOCIONAL - TCC', margemEsquerda, y);

            y += 8;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('KEITE FABIOLA - PSIC√ìLOGA 04/58498', margemEsquerda, y);
            y += 5;
            doc.text('@PSIKEITEFABIOLA | (31) 9 8681-4865', margemEsquerda, y);
            y += 5;
            doc.text(`Exportado em: ${new Date().toLocaleString('pt-BR')}`, margemEsquerda, y);
            y += 10;

            doc.setLineWidth(0.5);
            doc.line(margemEsquerda, y, margemEsquerda + larguraPagina, y);
            y += 10;

            // Registros
            registros.forEach((reg, index) => {
                // Verificar se precisa de nova p√°gina
                if (y > alturaPagina - 40) {
                    doc.addPage();
                    y = 20;
                }

                // N√∫mero do registro
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`Registro #${index + 1}`, margemEsquerda, y);
                y += 8;

                // Data/Hora
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Data/Hora:', margemEsquerda, y);
                doc.setFont('helvetica', 'normal');
                doc.text(new Date(reg.dataHora).toLocaleString('pt-BR'), margemEsquerda + 30, y);
                y += 7;

                // Situa√ß√£o
                doc.setFont('helvetica', 'bold');
                doc.text('Situa√ß√£o:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                const linhasSituacao = doc.splitTextToSize(reg.situacao, larguraPagina);
                doc.text(linhasSituacao, margemEsquerda, y);
                y += (linhasSituacao.length * 5) + 2;

                // Pensamento
                if (y > alturaPagina - 30) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Pensamento Autom√°tico:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                const linhasPensamento = doc.splitTextToSize(reg.pensamento, larguraPagina);
                doc.text(linhasPensamento, margemEsquerda, y);
                y += (linhasPensamento.length * 5) + 2;

                // Emo√ß√£o
                if (y > alturaPagina - 25) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Emo√ß√£o:', margemEsquerda, y);
                doc.setFont('helvetica', 'normal');
                const emocaoCentral = reg.emocaoCentral || reg.emocao || '';
                const emocaoInter = reg.emocaoIntermediaria || '';
                const emocaoEsp = reg.emocaoEspecifica || '';
                doc.text(`${emocaoCentral} > ${emocaoInter} > ${emocaoEsp}`, margemEsquerda + 25, y);
                y += 7;

                // Intensidade
                doc.setFont('helvetica', 'bold');
                doc.text('Intensidade:', margemEsquerda, y);
                doc.setFont('helvetica', 'normal');
                doc.text(`${reg.intensidade}/10`, margemEsquerda + 30, y);
                y += 7;

                // Comportamento
                if (y > alturaPagina - 25) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Comportamento:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                const linhasComportamento = doc.splitTextToSize(reg.comportamento, larguraPagina);
                doc.text(linhasComportamento, margemEsquerda, y);
                y += (linhasComportamento.length * 5) + 8;

                // Linha separadora
                if (index < registros.length - 1) {
                    if (y > alturaPagina - 15) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setLineWidth(0.3);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margemEsquerda, y, margemEsquerda + larguraPagina, y);
                    y += 10;
                }
            });

            // Salvar PDF
            const nomeArquivo = `diario-emocional-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(nomeArquivo);
            mostrarToast('‚úÖ PDF baixado com sucesso!');
        }

        function exportarJSON() {
            const registros = getRegistros();
            const blob = new Blob([JSON.stringify(registros, null, 2)], { type: 'application/json' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.json`);
            mostrarToast('üì• JSON baixado!');
        }

        function exportarCSV() {
            const registros = getRegistros();
            let csv = 'Data,Hora,Situa√ß√£o,Pensamento,Emo√ß√£o Central,Emo√ß√£o Intermedi√°ria,Emo√ß√£o Espec√≠fica,Intensidade,Comportamento\n';

            registros.forEach(r => {
                const data = new Date(r.dataHora);
                const linha = [
                    data.toLocaleDateString('pt-BR'),
                    data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                    `"${r.situacao.replace(/"/g, '""')}"`,
                    `"${r.pensamento.replace(/"/g, '""')}"`,
                    r.emocaoCentral || r.emocao || '',
                    r.emocaoIntermediaria || '',
                    r.emocaoEspecifica || '',
                    r.intensidade,
                    `"${r.comportamento.replace(/"/g, '""')}"`
                ].join(',');
                csv += linha + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.csv`);
            mostrarToast('üì• CSV baixado!');
        }

        function exportarTexto() {
            const registros = getRegistros();
            let texto = 'DI√ÅRIO EMOCIONAL - REGISTRO TCC\n';
            texto += '='.repeat(50) + '\n\n';

            registros.forEach((r, i) => {
                const data = new Date(r.dataHora);
                texto += `REGISTRO ${i + 1}\n`;
                texto += `Data: ${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}\n\n`;
                texto += `SITUA√á√ÉO:\n${r.situacao}\n\n`;
                texto += `PENSAMENTO AUTOM√ÅTICO:\n${r.pensamento}\n\n`;
                const emocaoCentral = r.emocaoCentral || r.emocao || 'N√£o especificada';
                const emocaoIntermediaria = r.emocaoIntermediaria || '';
                const emocaoEspecifica = r.emocaoEspecifica || '';
                texto += `EMO√á√ÉO: ${emocaoCentral}`;
                if (emocaoIntermediaria) texto += ` ‚Üí ${emocaoIntermediaria}`;
                if (emocaoEspecifica) texto += ` ‚Üí ${emocaoEspecifica}`;
                texto += ` (Intensidade: ${r.intensidade}/10)\n\n`;
                texto += `COMPORTAMENTO:\n${r.comportamento}\n\n`;
                texto += '-'.repeat(50) + '\n\n';
            });

            const blob = new Blob([texto], { type: 'text/plain;charset=utf-8;' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.txt`);
            mostrarToast('üì• TXT baixado!');
        }

        function baixarArquivo(blob, nomeArquivo) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function limparTodosDados() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai apagar TODOS os seus registros permanentemente do Firebase. Tem certeza?')) return;
            if (!confirm('√öltima confirma√ß√£o: Todos os dados ser√£o perdidos. Continuar?')) return;

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                // Deletar todos do Firebase
                const batch = db.batch();
                const snapshot = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').get();

                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                registrosEmMemoria = [];

                carregarHistorico();
                atualizarEstatisticas();
                mostrarToast('üóëÔ∏è Todos os dados foram apagados');
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                mostrarToast('‚ùå Erro ao apagar dados');
            }
        }

        function mostrarToast(mensagem) {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ===== CONFIGURA√á√ÉO DO FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyA5g7m_dOZ-ca707_ttxtX_NdQet5pKETg",
            authDomain: "diario-emocional-2c464.firebaseapp.com",
            projectId: "diario-emocional-2c464",
            storageBucket: "diario-emocional-2c464.firebasestorage.app",
            messagingSenderId: "306504477100",
            appId: "1:306504477100:web:655191303f79a95e13f209"
        };

        // Inicializar Firebase
        let app, auth, db;
        let isLoginMode = true;
        let currentUser = null;

        // Mostrar tela de login imediatamente se der erro
        function showLoginFallback() {
            console.log('üîì Mostrando tela de login');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Tentar inicializar Firebase
        try {
            console.log('üîÑ Tentando inicializar Firebase...');

            if (typeof firebase === 'undefined') {
                console.error('‚ùå Firebase n√£o dispon√≠vel');
                showLoginFallback();
            } else {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                console.log('‚úÖ Firebase inicializado com sucesso');

                // Verificar autentica√ß√£o - onAuthStateChanged √© chamado imediatamente
                auth.onAuthStateChanged(async user => {
                    console.log('üë§ Estado de autentica√ß√£o:', user ? 'Logado' : 'Deslogado');

                    // Garantir que esconde o loading
                    const loadingEl = document.getElementById('loadingScreen');
                    if (loadingEl) loadingEl.classList.add('hidden');

                    if (user) {
                        console.log('‚úÖ Usu√°rio autenticado:', user.email);
                        currentUser = user;

                        // Carregar perfil do usu√°rio
                        const perfil = await carregarPerfilUsuario(user.uid);
                        
                        // Atualizar informa√ß√µes do usu√°rio
                        const userName = document.getElementById('userName');
                        const userEmail = document.getElementById('userEmail');
                        
                        if (perfil && perfil.nomeCompleto) {
                            if (userName) userName.textContent = perfil.nomeCompleto;
                        } else if (user.displayName) {
                            if (userName) userName.textContent = user.displayName;
                        } else {
                            if (userName) userName.textContent = user.email.split('@')[0];
                        }
                        
                        if (userEmail) userEmail.textContent = user.email;

                        // Mostrar app imediatamente e carregar dados em background
                        showApp();
                        carregarDadosFirebase().catch(err => console.warn('Erro ao carregar dados:', err));
                    } else {
                        console.log('‚ùå Usu√°rio n√£o autenticado');
                        showLogin();
                    }
                });
            }
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Firebase:', error);
            showLoginFallback();
        }

        // Carregar perfil do usu√°rio do Firestore
        async function carregarPerfilUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const perfil = doc.data();
                    return perfil;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualizar sauda√ß√£o com nome do usu√°rio e per√≠odo do dia
        async function atualizarSaudacao() {
            const hora = new Date().getHours();
            let saudacao;

            if (hora >= 5 && hora < 12) {
                saudacao = 'üåÖ Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = '‚òÄÔ∏è Boa tarde';
            } else {
                saudacao = 'üåô Boa noite';
            }

            let nomeUsuario = 'Usu√°rio';

            // Tentar pegar o nome do perfil
            if (currentUser) {
                const perfil = await carregarPerfilUsuario(currentUser.uid);
                if (perfil && perfil.nomeCompleto) {
                    nomeUsuario = perfil.nomeCompleto.split(' ')[0]; // Primeiro nome
                } else if (currentUser.displayName) {
                    nomeUsuario = currentUser.displayName.split(' ')[0];
                } else if (currentUser.email) {
                    nomeUsuario = currentUser.email.split('@')[0];
                }
            }

            document.getElementById('greetingMessage').textContent = `${saudacao}, ${nomeUsuario}!`;
        }

        // Atualizar data e hora em tempo real
        function atualizarDataHora() {
            const atualizar = () => {
                const agora = new Date();
                const opcoes = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dataFormatada = agora.toLocaleDateString('pt-BR', opcoes);
                document.getElementById('currentDateTime').textContent = dataFormatada;
            };

            atualizar();
            // Atualizar a cada minuto
            setInterval(atualizar, 60000);
        }

        // Gerenciar tema (Dark Mode)
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            }
        }

        // Carregar prefer√™ncia de tema
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                if (themeIcon) themeIcon.textContent = 'üåô';
            }
        }

        function showApp() {
            console.log('üì± Mostrando app...');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('active');

            // Carregar tema preferido
            loadTheme();
            
            // Inicializar app imediatamente
            inicializarApp();
            atualizarSaudacao();
            atualizarDataHora();
            console.log('‚úÖ App inicializado!');
        }

        function showLogin() {
            console.log('üîê Mostrando tela de login...');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const buttonText = document.getElementById('authButtonText');
            const toggleText = document.getElementById('toggleText');
            const toggleLink = document.getElementById('toggleLink');
            const signupFields = document.getElementById('signupFields');
            const termsCheckbox = document.getElementById('termsCheckbox');

            if (isLoginMode) {
                buttonText.textContent = 'Entrar';
                toggleText.textContent = 'N√£o tem conta?';
                toggleLink.textContent = 'Criar conta';
                signupFields.classList.add('hidden');
                termsCheckbox.classList.add('hidden');
            } else {
                buttonText.textContent = 'Criar Conta';
                toggleText.textContent = 'J√° tem conta?';
                toggleLink.textContent = 'Fazer login';
                signupFields.classList.remove('hidden');
                termsCheckbox.classList.remove('hidden');
            }
        }

        async function handleEmailAuth() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            console.log('üîë Tentando autenticar...', { email, mode: isLoginMode ? 'login' : 'criar' });

            if (!email || !password) {
                showError('Preencha email e senha');
                return;
            }

            if (password.length < 6) {
                showError('Senha deve ter no m√≠nimo 6 caracteres');
                return;
            }

            // Se for cadastro, validar campos extras
            if (!isLoginMode) {
                const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
                const acceptTerms = document.getElementById('acceptTerms').checked;

                if (!nomeCompleto) {
                    showError('Preencha seu nome completo');
                    return;
                }

                if (!acceptTerms) {
                    showError('Voc√™ precisa aceitar os termos de uso');
                    return;
                }
            }

            try {
                // Garantir persist√™ncia LOCAL antes de fazer login
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                console.log('üîí Persist√™ncia LOCAL ativada');

                if (isLoginMode) {
                    console.log('üìß Fazendo login...');
                    const result = await auth.signInWithEmailAndPassword(email, password);
                    console.log('‚úÖ Login realizado:', result.user.email);
                } else {
                    console.log('üìù Criando conta...');
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    console.log('‚úÖ Conta criada:', result.user.email);

                    // Salvar informa√ß√µes adicionais do usu√°rio
                    await salvarPerfilUsuario(result.user.uid);
                }

                // onAuthStateChanged vai chamar showApp() automaticamente
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                console.error('C√≥digo:', error.code);
                console.error('Mensagem:', error.message);

                const messages = {
                    'auth/email-already-in-use': 'Email j√° cadastrado',
                    'auth/invalid-email': 'Email inv√°lido',
                    'auth/user-not-found': 'Usu√°rio n√£o encontrado',
                    'auth/wrong-password': 'Senha incorreta',
                    'auth/weak-password': 'Senha muito fraca',
                    'auth/network-request-failed': 'Erro de conex√£o',
                    'auth/operation-not-allowed': '‚ö†Ô∏è Configure Authentication no Firebase Console',
                    'auth/unauthorized-domain': '‚ö†Ô∏è Adicione "localhost" nos dom√≠nios autorizados do Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains'
                };

                let errorMsg = messages[error.code] || error.message || 'Erro ao autenticar';

                // Se for 400, pode ser dom√≠nio n√£o autorizado
                if (!error.code && error.message && error.message.includes('400')) {
                    errorMsg = '‚ö†Ô∏è ERRO 400: Verifique no Firebase Console:\n' +
                               '1. Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí Adicione "localhost"\n' +
                               '2. Ou teste usando o authDomain: diario-emocional-2c464.firebaseapp.com';
                    console.error('üí° Solu√ß√£o: Adicione localhost nos dom√≠nios autorizados ou teste via Firebase Hosting');
                }

                showError(errorMsg);
            }
        }

        async function handleGoogleAuth() {
            try {
                // Garantir persist√™ncia LOCAL antes de fazer login
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                console.log('üîí Persist√™ncia LOCAL ativada (Google)');

                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Erro Google:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showError('Erro ao fazer login com Google');
                }
            }
        }

        // Salvar perfil do usu√°rio no Firestore
        async function salvarPerfilUsuario(uid) {
            try {
                const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
                const dataNascimento = document.getElementById('dataNascimento').value;
                const genero = document.getElementById('genero').value;

                const perfil = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    email: currentUser?.email || auth.currentUser?.email,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('usuarios').doc(uid).set(perfil);
                
                // Atualizar displayName no Authentication
                if (auth.currentUser) {
                    await auth.currentUser.updateProfile({
                        displayName: nomeCompleto
                    });
                }

                console.log('‚úÖ Perfil do usu√°rio salvo com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao salvar perfil:', error);
                // N√£o bloquear o cadastro por falha ao salvar perfil
            }
        }

        // Carregar perfil do usu√°rio do Firestore
        async function carregarPerfilUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const perfil = doc.data();
                    return perfil;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualizar sauda√ß√£o com nome do usu√°rio e per√≠odo do dia
        async function atualizarSaudacao() {
            const hora = new Date().getHours();
            let saudacao;

            if (hora >= 5 && hora < 12) {
                saudacao = 'üåÖ Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = '‚òÄÔ∏è Boa tarde';
            } else {
                saudacao = 'üåô Boa noite';
            }

            let nomeUsuario = 'Usu√°rio';

            // Tentar pegar o nome do perfil
            if (currentUser) {
                const perfil = await carregarPerfilUsuario(currentUser.uid);
                if (perfil && perfil.nomeCompleto) {
                    nomeUsuario = perfil.nomeCompleto.split(' ')[0]; // Primeiro nome
                } else if (currentUser.displayName) {
                    nomeUsuario = currentUser.displayName.split(' ')[0];
                } else if (currentUser.email) {
                    nomeUsuario = currentUser.email.split('@')[0];
                }
            }

            document.getElementById('greetingMessage').textContent = `${saudacao}, ${nomeUsuario}!`;
        }

        // Atualizar data e hora em tempo real
        function atualizarDataHora() {
            const atualizar = () => {
                const agora = new Date();
                const opcoes = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dataFormatada = agora.toLocaleDateString('pt-BR', opcoes);
                document.getElementById('currentDateTime').textContent = dataFormatada;
            };

            atualizar();
            // Atualizar a cada minuto
            setInterval(atualizar, 60000);
        }

        // Mostrar termos de uso
        function mostrarTermos() {
            alert('TERMOS DE USO\n\n' +
                '1. Este aplicativo √© um di√°rio pessoal para registros emocionais.\n' +
                '2. Seus dados s√£o privados e protegidos por criptografia.\n' +
                '3. Apenas voc√™ tem acesso aos seus registros.\n' +
                '4. N√£o compartilhamos seus dados com terceiros.\n' +
                '5. Voc√™ pode excluir sua conta e dados a qualquer momento.\n' +
                '6. Este app n√£o substitui tratamento psicol√≥gico profissional.');
        }

        function mostrarPrivacidade() {
            alert('POL√çTICA DE PRIVACIDADE\n\n' +
                '1. Coletamos: email, nome e dados emocionais que voc√™ registra.\n' +
                '2. Uso: Apenas para funcionamento do aplicativo.\n' +
                '3. Armazenamento: Firebase (Google Cloud) com criptografia.\n' +
                '4. Compartilhamento: N√£o compartilhamos com terceiros.\n' +
                '5. Seus direitos: Acesso, corre√ß√£o e exclus√£o dos seus dados.\n' +
                '6. Seguran√ßa: Autentica√ß√£o, regras de seguran√ßa e isolamento de dados.\n' +
                '7. Contato: Para d√∫vidas sobre privacidade, entre em contato.');
        }

        async function handleLogout() {
            if (!confirm('Deseja realmente sair?')) return;

            try {
                console.log('üö™ Fazendo logout...');

                if (auth) {
                    await auth.signOut();
                    console.log('‚úÖ Logout realizado com sucesso');
                }

                // Limpar dados da mem√≥ria por seguran√ßa
                registrosEmMemoria = [];
                currentUser = null;
                showLogin();

            } catch (error) {
                console.error('‚ùå Erro ao sair:', error);
                registrosEmMemoria = [];
                currentUser = null;
                showLogin();
            }
        }

        // Salvar registro no Firestore (com valida√ß√£o de seguran√ßa)
        async function salvarRegistroFirebase(registro) {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de salvar sem autentica√ß√£o');
                return null;
            }

            try {
                // SEGURAN√áA: Salvar apenas na cole√ß√£o do usu√°rio autenticado
                const docRef = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').add({
                        ...registro,
                        criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                        // SEGURAN√áA: Adicionar UID do propriet√°rio
                        proprietario: currentUser.uid
                    });

                console.log('‚úÖ Registro salvo no Firebase com ID:', docRef.id);
                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                document.getElementById('syncStatus').style.color = 'var(--success)';

                return docRef.id; // Retornar ID do documento
            } catch (error) {
                console.error('Erro ao salvar:', error);
                document.getElementById('syncStatus').textContent = '‚ö† Erro na sincroniza√ß√£o';
                document.getElementById('syncStatus').style.color = 'var(--danger)';
                return null;
            }
        }

        // Carregar registros do Firestore (com valida√ß√£o de seguran√ßa)
        async function carregarDadosFirebase() {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de carregar dados sem autentica√ß√£o');
                registrosEmMemoria = [];
                return;
            }

            try {
                console.log('üì• Carregando dados do Firebase...');
                // SEGURAN√áA: Buscar apenas dados do usu√°rio autenticado
                const snapshot = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros')
                    .orderBy('criadoEm', 'desc')
                    .get();

                const registrosFirebase = snapshot.docs.map(doc => {
                    const data = doc.data();

                    // SEGURAN√áA: Validar propriet√°rio
                    if (data.proprietario && data.proprietario !== currentUser.uid) {
                        console.error('‚ùå SEGURAN√áA: Registro n√£o pertence ao usu√°rio atual');
                        return null;
                    }

                    return {
                        id: data.id, // ID local original
                        firebaseId: doc.id, // ID do documento do Firebase
                        dataHora: data.dataHora,
                        situacao: data.situacao,
                        pensamento: data.pensamento,
                        emocaoCentral: data.emocaoCentral,
                        emocaoIntermediaria: data.emocaoIntermediaria,
                        emocaoEspecifica: data.emocaoEspecifica,
                        intensidade: data.intensidade,
                        comportamento: data.comportamento
                    };
                });

                // SEGURAN√áA: Filtrar registros nulos (que n√£o passaram na valida√ß√£o)
                const registrosValidos = registrosFirebase.filter(r => r !== null);

                console.log(`‚úÖ ${registrosValidos.length} registros carregados do Firebase`);

                // Salvar na mem√≥ria
                registrosEmMemoria = registrosValidos;

                // Atualizar hist√≥rico se estiver na aba
                if (document.getElementById('historico').classList.contains('active')) {
                    carregarHistorico();
                }

                // Atualizar estat√≠sticas
                atualizarEstatisticas();

                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do Firebase:', error);
                document.getElementById('syncStatus').textContent = '‚ö† Erro ao sincronizar';
            }
        }

        // Excluir registro do Firestore (com valida√ß√£o de seguran√ßa)
        async function excluirRegistroFirebase(registroId) {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de excluir sem autentica√ß√£o');
                throw new Error('N√£o autorizado');
            }

            // SEGURAN√áA: Validar formato do ID
            if (!registroId || typeof registroId !== 'string') {
                console.error('‚ùå SEGURAN√áA: ID de registro inv√°lido');
                throw new Error('ID inv√°lido');
            }

            try {
                // SEGURAN√áA: Excluir apenas da cole√ß√£o do usu√°rio autenticado
                await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').doc(registroId).delete();

                document.getElementById('syncStatus').textContent = '‚úì Exclu√≠do';
            } catch (error) {
                console.error('Erro ao excluir:', error);
                throw error;
            }
        }

        // Permitir Enter para fazer login
        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleEmailAuth();
                });
            }
        });
    </script>

    </div>
</body>
</html>