<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Di√°rio Emocional - TCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --bg-light: #f8f9fa;
            --text-dark: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #48bb78;
            --danger: #f56565;

            /* Vari√°veis para tema claro (padr√£o) */
            --bg-body: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode */
        body.dark-mode {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #8b5cf6;
            --bg-light: #1e293b;
            --text-dark: #f1f5f9;
            --text-light: #cbd5e1;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);

            --bg-body: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            padding-bottom: 80px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-card);
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s ease;
        }

        .header h1 {
            font-size: 24px;
            color: var(--primary);
            text-align: center;
            margin-bottom: 5px;
        }

        .header p {
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
        }

        .tabs {
            display: flex;
            background: var(--bg-card);
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .form-group label .emoji {
            font-size: 18px;
            margin-right: 5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .intensity-container {
            position: relative;
        }

        .intensity-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .intensity-slider::-webkit-slider-track {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
        }

        .intensity-slider::-moz-range-track {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow);
            border: 3px solid var(--primary);
        }

        .intensity-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow);
            border: 3px solid var(--primary);
        }

        .intensity-value {
            text-align: center;
            margin-top: 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .emotions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .emotion-btn {
            padding: 15px 10px;
            border: 3px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .emotion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .emotion-btn .emoji {
            display: block;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .emocao-nome {
            font-weight: 600;
            font-size: 14px;
            display: block;
            margin-bottom: 3px;
        }

        .emocao-explicacao {
            font-size: 10px;
            opacity: 0.85;
            line-height: 1.3;
            font-weight: 400;
            display: block;
            color: var(--text-dark);
        }

        .emotion-btn.selected {
            border-color: var(--primary) !important;
            border-width: 4px !important;
            background: linear-gradient(135deg, #667eea15, #764ba220) !important;
            transform: scale(1.08);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3), 0 0 0 3px rgba(102, 126, 234, 0.1);
            font-weight: 600;
        }

        .emotion-btn.selected::before {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .emotion-btn.selected .emoji {
            transform: scale(1.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px var(--shadow);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .btn-secondary:active {
            background: #e2e8f0;
            transform: scale(0.98);
        }

        .entries-list {
            margin-top: 10px;
        }

        .entry-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .entry-date {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .entry-field {
            margin-bottom: 15px;
        }

        .entry-field strong {
            display: block;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .entry-field p {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .emotion-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-light);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state .emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: var(--text-light);
            font-size: 16px;
        }

        .export-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            text-align: center;
            transition: background 0.3s ease;
        }

        .export-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Perfil */
        .profile-info {
            text-align: left;
            margin-top: 20px;
        }

        .profile-field {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field strong {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .profile-field p {
            color: var(--text-primary);
            font-size: 16px;
            margin: 0;
        }

        /* Lista de Usu√°rios (Admin) */
        .user-item {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .user-item-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .user-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-user {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete-user:hover {
            opacity: 0.8;
        }

        .footer-info {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            transition: background 0.3s ease;\n        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 1000;
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Cabe√ßalho de Boas-vindas */
        .welcome-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 25px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .greeting h2 {
            font-size: 28px;
            margin: 0;
            font-weight: 700;
        }

        .greeting p {
            font-size: 14px;
            margin: 5px 0 0 0;
            opacity: 0.95;
        }

        .welcome-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 380px) {
            .emotions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tela de Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 10000;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
            transition: background 0.3s ease;
        }

        .login-box h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-box p {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .signup-fields {
            margin-bottom: 20px;
        }

        .signup-fields input,
        .signup-fields select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .signup-fields input:focus,
        .signup-fields select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .terms-checkbox {
            margin: 15px 0;
            text-align: left;
        }

        .terms-checkbox label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
            color: var(--text-light);
            cursor: pointer;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .terms-checkbox a {
            color: var(--primary);
            text-decoration: none;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 10px;
        }

        .btn-login:hover {
            background: var(--primary-dark);
        }

        .btn-google {
            width: 100%;
            padding: 15px;
            background: white;
            color: var(--text-dark);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .divider {
            margin: 20px 0;
            color: var(--text-light);
            font-size: 14px;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .toggle-auth {
            margin-top: 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .toggle-auth a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .user-info {
            background: white;
            padding: 12px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .user-info .user-details {
            flex: 1;
        }

        .user-info .user-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .user-info .user-email {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 10001;
            color: white;
            font-size: 18px;
        }

        .loading.hidden,
        .hidden {
            display: none !important;
        }

        .sync-status {
            font-size: 10px;
            color: var(--success);
            margin-top: 2px;
        }

        .app-wrapper {
            display: none;
        }

        .app-wrapper.active {
            display: block;
        }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Tela de Loading -->
    <div id="loadingScreen" class="loading">
        <div>‚è≥ Carregando...</div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container hidden">
        <div class="login-box">
            <h1>üìî Di√°rio Emocional</h1>
            <p>Fa√ßa login para acessar seus registros</p>

            <div id="authError" class="error-message hidden"></div>

            <!-- Campos extras para cadastro -->
            <div id="signupFields" class="signup-fields hidden">
                <input type="text" id="nomeCompleto" placeholder="Nome completo *" required>
                <input type="date" id="dataNascimento" placeholder="Data de nascimento">
                <select id="genero">
                    <option value="">G√™nero (opcional)</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-informar">Prefiro n√£o informar</option>
                </select>
            </div>

            <div class="login-form">
                <input type="email" id="emailInput" placeholder="Email" autocomplete="email">
                <input type="password" id="passwordInput" placeholder="Senha (m√≠nimo 6 caracteres)" autocomplete="current-password">

                <!-- Checkbox de termos (s√≥ aparece no cadastro) -->
                <div id="termsCheckbox" class="terms-checkbox hidden">
                    <label>
                        <input type="checkbox" id="acceptTerms">
                        <span>Aceito os <a href="#" onclick="mostrarTermos(); return false;">termos de uso</a> e <a href="#" onclick="mostrarPrivacidade(); return false;">pol√≠tica de privacidade</a></span>
                    </label>
                </div>

                <button class="btn-login" onclick="handleEmailAuth()">
                    <span id="authButtonText">Entrar</span>
                </button>
            </div>

            <div class="divider">ou</div>

            <button class="btn-google" onclick="handleGoogleAuth()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar com Google
            </button>

            <div class="toggle-auth">
                <span id="toggleText">N√£o tem conta?</span>
                <a onclick="toggleAuthMode()"><span id="toggleLink">Criar conta</span></a>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="appScreen" class="app-wrapper">
        <!-- Cabe√ßalho com sauda√ß√£o personalizada -->
        <div class="welcome-header">
            <div class="greeting">
                <h2 id="greetingMessage">Ol√°!</h2>
                <p id="currentDateTime"></p>
            </div>
            <div class="welcome-actions">
                <button class="btn-theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <span id="themeIcon">üåô</span>
                </button>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>

        <div class="user-info">
            <div class="user-details">
                <div class="user-name" id="userName">Usu√°rio</div>
                <div class="user-email" id="userEmail">email@exemplo.com</div>
                <div class="sync-status" id="syncStatus">‚úì Sincronizado</div>
            </div>
        </div>


    <div class="header">
        <h1>üìî Di√°rio Emocional</h1>
        <p>Registro para Terapia Cognitivo-Comportamental</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('novo', event)">‚ûï Novo</button>
        <button class="tab" onclick="showTab('historico', event)">üìñ Hist√≥rico</button>
        <button class="tab" onclick="showTab('exportar', event)">üì§ Exportar</button>
        <button class="tab" onclick="showTab('perfil', event)">üë§ Perfil</button>
        <button class="tab" id="adminTab" onclick="showTab('admin', event)" style="display: none;">üîê Admin</button>
    </div>

    <!-- TAB: NOVO REGISTRO -->
    <div id="novo" class="tab-content active">
        <div class="form-group">
            <label><span class="emoji">üìÖ</span> Data e Hora</label>
            <input type="datetime-local" id="dataHora">
        </div>

        <div class="form-group">
            <label><span class="emoji">üìç</span> Situa√ß√£o</label>
            <textarea id="situacao" placeholder="O que aconteceu? Onde voc√™ estava? Com quem?"></textarea>
        </div>

        <div class="form-group">
            <label><span class="emoji">üí≠</span> Pensamento Autom√°tico</label>
            <textarea id="pensamento" placeholder="O que passou pela sua cabe√ßa naquele momento?"></textarea>
        </div>

        <div class="form-group">
            <label><span class="emoji">‚ù§Ô∏è</span> Emo√ß√£o Principal</label>
            <div class="emotions-grid" id="emotionsGrid"></div>
        </div>

        <div id="intermediariasDiv"></div>
        <div id="especificasDiv"></div>

        <div class="form-group">
            <label><span class="emoji">üéöÔ∏è</span> Intensidade da Emo√ß√£o (0-10)</label>
            <div class="intensity-container">
                <input type="range" min="0" max="10" value="5" class="intensity-slider" id="intensidade">
                <div class="intensity-value" id="intensidadeValor">5</div>
            </div>
        </div>

        <div class="form-group">
            <label><span class="emoji">üé≠</span> Comportamento</label>
            <textarea id="comportamento" placeholder="Como voc√™ reagiu? O que fez depois?"></textarea>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="limparFormulario()">üîÑ Limpar</button>
            <button class="btn btn-primary" onclick="salvarRegistro()">üíæ Salvar</button>
        </div>
    </div>

    <!-- TAB: HIST√ìRICO -->
    <div id="historico" class="tab-content">
        <div class="entries-list" id="entriesList"></div>
    </div>

    <!-- TAB: EXPORTAR -->
    <div id="exportar" class="tab-content">
        <div class="stats-grid" id="statsGrid"></div>

        <div class="export-section">
            <h3>üìä Exportar Dados</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Baixe seus registros para compartilhar com seu terapeuta ou fazer backup
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportarPDF()">üìÑ PDF</button>
                <button class="btn btn-primary" onclick="exportarJSON()">JSON</button>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="exportarCSV()">CSV</button>
                <button class="btn btn-primary" onclick="exportarTexto()">Texto</button>
            </div>
        </div>

        <div class="export-section">
            <h3>‚öôÔ∏è Configura√ß√µes</h3>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="limparTodosDados()">üóëÔ∏è Limpar Tudo</button>
            </div>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <!-- TAB: PERFIL -->
    <div id="perfil" class="tab-content">
        <div class="export-section">
            <h3>üë§ Meu Perfil</h3>

            <!-- Modo Visualiza√ß√£o -->
            <div class="profile-info" id="profileViewMode">
                <div class="profile-field">
                    <strong>Nome Completo:</strong>
                    <p id="profileName">Carregando...</p>
                </div>
                <div class="profile-field">
                    <strong>Email:</strong>
                    <p id="profileEmail">Carregando...</p>
                    <small style="color: var(--text-secondary); font-size: 11px;">O email n√£o pode ser alterado</small>
                </div>
                <div class="profile-field">
                    <strong>Data de Nascimento:</strong>
                    <p id="profileBirthdate">N√£o informado</p>
                </div>
                <div class="profile-field">
                    <strong>G√™nero:</strong>
                    <p id="profileGender">N√£o informado</p>
                </div>
                <div class="profile-field">
                    <strong>Membro desde:</strong>
                    <p id="profileSince">Carregando...</p>
                </div>
            </div>

            <!-- Modo Edi√ß√£o -->
            <div class="profile-edit" id="profileEditMode" style="display: none;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>Nome Completo:</strong></label>
                    <input type="text" id="editNomeCompleto" placeholder="Seu nome completo">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>Email:</strong></label>
                    <input type="email" id="editEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
                    <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">O email n√£o pode ser alterado</small>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>Data de Nascimento:</strong></label>
                    <input type="date" id="editDataNascimento">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>G√™nero:</strong></label>
                    <select id="editGenero">
                        <option value="">Selecione...</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                        <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                    </select>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" id="btnEditProfile" onclick="habilitarEdicaoPerfil()">‚úèÔ∏è Editar Perfil</button>
                <button class="btn btn-secondary" id="btnCancelEdit" onclick="cancelarEdicaoPerfil()" style="display: none;">‚ùå Cancelar</button>
                <button class="btn btn-primary" id="btnSaveProfile" onclick="salvarEdicaoPerfil()" style="display: none;">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="export-section" style="border: 2px solid var(--danger);">
            <h3 style="color: var(--danger);">‚ö†Ô∏è Zona de Perigo</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Ao excluir sua conta, todos os seus dados ser√£o permanentemente removidos e n√£o poder√£o ser recuperados.
            </p>
            <button class="btn" style="background: var(--danger); color: white;" onclick="confirmarExclusaoConta()">
                üóëÔ∏è Excluir Minha Conta
            </button>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <!-- TAB: ADMIN -->
    <div id="admin" class="tab-content">
        <!-- Dashboard com Estat√≠sticas -->
        <div class="export-section" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none;">
            <h3 style="color: white; margin-bottom: 20px;">üìä Dashboard Administrativo</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="totalUsuarios">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Total de Usu√°rios</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="usuariosAtivos">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Ativos (7 dias)</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="totalRegistros">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Total de Registros</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="usuariosInativos">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Usu√°rios Inativos</div>
                </div>
            </div>
        </div>

        <div class="export-section">
            <h3>üîê Gerenciar Usu√°rios</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Gerencie usu√°rios cadastrados no sistema
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="carregarDashboardAdmin()">üìä Atualizar Dashboard</button>
                <button class="btn btn-primary" onclick="carregarListaUsuarios()">üîÑ Atualizar Lista</button>
                <button class="btn btn-primary" onclick="mostrarFormularioNovoUsuario()">‚ûï Criar Novo Usu√°rio</button>
            </div>
        </div>

        <!-- Formul√°rio para Criar Novo Usu√°rio -->
        <div class="export-section" id="novoUsuarioForm" style="display: none; border: 2px solid var(--primary);">
            <h3>‚ûï Criar Novo Usu√°rio</h3>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Nome Completo: *</strong></label>
                <input type="text" id="novoNomeCompleto" placeholder="Nome completo do usu√°rio">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Email: *</strong></label>
                <input type="email" id="novoEmail" placeholder="email@exemplo.com">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Senha Tempor√°ria: *</strong></label>
                <input type="password" id="novoSenha" placeholder="M√≠nimo 6 caracteres">
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    O usu√°rio poder√° alterar a senha ap√≥s o primeiro login
                </small>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Data de Nascimento:</strong></label>
                <input type="date" id="novoDataNascimento">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>G√™nero:</strong></label>
                <select id="novoGenero">
                    <option value="">Selecione...</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Permiss√£o: *</strong></label>
                <select id="novoRole">
                    <option value="user">Usu√°rio</option>
                    <option value="admin">Administrador</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    Administradores podem gerenciar todos os usu√°rios
                </small>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="ocultarFormularioNovoUsuario()">‚ùå Cancelar</button>
                <button class="btn btn-primary" onclick="criarNovoUsuario()">‚úÖ Criar Usu√°rio</button>
            </div>
        </div>

        <!-- Formul√°rio para Editar Usu√°rio Existente -->
        <div class="export-section" id="editarUsuarioForm" style="display: none; border: 2px solid var(--primary);">
            <h3>‚úèÔ∏è Editar Usu√°rio</h3>
            <input type="hidden" id="editarUsuarioUid">
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Nome Completo: *</strong></label>
                <input type="text" id="editarNomeCompleto" placeholder="Nome completo do usu√°rio">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Email:</strong></label>
                <input type="email" id="editarEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    O email n√£o pode ser alterado
                </small>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Data de Nascimento:</strong></label>
                <input type="date" id="editarDataNascimento">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>G√™nero:</strong></label>
                <select id="editarGenero">
                    <option value="">Selecione...</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Permiss√£o: *</strong></label>
                <select id="editarRole">
                    <option value="user">Usu√°rio</option>
                    <option value="admin">Administrador</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    Administradores podem gerenciar todos os usu√°rios
                </small>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Status: *</strong></label>
                <select id="editarStatus">
                    <option value="ativo">‚úÖ Ativo</option>
                    <option value="inativo">üö´ Inativo</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    Usu√°rios inativos n√£o podem fazer login
                </small>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="cancelarEdicaoUsuarioAdmin()">‚ùå Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEdicaoUsuarioAdmin()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="export-section">
            <h3>üë• Usu√°rios Cadastrados</h3>
            <div id="usersList" style="text-align: left;">
                <p style="text-align: center; color: var(--text-secondary);">Clique em "Atualizar Lista" para carregar os usu√°rios</p>
            </div>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const emocoesCores = {
            'Raiva': '#E18AB8',
            'Tristeza': '#4A63A5',
            'Surpresa': '#70C1CF',
            'Alegria': '#AFD799',
            'Amor': '#E7E26B',
            'Medo': '#E88C5B'
        };

        const emocoesCoresEspecificas = {
            '√ìdio': '#E18AB8',
            'Hostilidade': '#E18AB8',
            'Agita√ß√£o': '#E18AB8',
            'Frustra√ß√£o': '#E18AB8',
            'Irrita√ß√£o': '#E18AB8',
            'Provoca√ß√£o': '#E18AB8',
            'Ci√∫mes': '#E18AB8',
            'Ressentimento': '#E18AB8',
            'Desespero': '#E18AB8',
            'Revoltado': '#E18AB8',
            'Agoniado': '#4A63A5',
            'Machucado': '#4A63A5',
            'Depress√£o': '#4A63A5',
            'Pesar': '#4A63A5',
            'Consternado': '#4A63A5',
            'Desagradado': '#4A63A5',
            'Arrependimento': '#4A63A5',
            'Culpa': '#4A63A5',
            'Isolamento': '#4A63A5',
            'Solit√°rio': '#4A63A5',
            'Luto': '#4A63A5',
            'Impot√™ncia': '#4A63A5',
            'Chocado': '#70C1CF',
            'Desiludido': '#70C1CF',
            'Perplexo': '#70C1CF',
            'At√¥nito': '#70C1CF',
            'Impressionado': '#70C1CF',
            'Sem palavras': '#70C1CF',
            'Espantado': '#70C1CF',
            'Estimulado': '#70C1CF',
            'Tocado': '#70C1CF',
            'Gozo': '#AFD799',
            'Saciado': '#AFD799',
            'Divertido': '#AFD799',
            'Deleite': '#AFD799',
            'Jovial': '#AFD799',
            'Aben√ßoado': '#AFD799',
            'Triunfante': '#AFD799',
            'Famoso': '#AFD799',
            'Esperan√ßoso': '#AFD799',
            'Ansioso': '#AFD799',
            'Excitado': '#AFD799',
            'Zelo': '#AFD799',
            'J√∫bilo': '#AFD799',
            'Euforia': '#AFD799',
            '√äxtase': '#AFD799',
            'Sedu√ß√£o': '#AFD799',
            'Pleno': '#E7E26B',
            'Liberdade': '#E7E26B',
            'Compaix√£o': '#E7E26B',
            'Cuidado': '#E7E26B',
            'Fasc√≠nio': '#E7E26B',
            'Paix√£o': '#E7E26B',
            'Atra√ß√£o': '#E7E26B',
            'Sens√≠vel': '#E7E26B',
            'Carinho': '#E7E26B',
            'Rom√¢ntico': '#E7E26B',
            'Pavor': '#E88C5B',
            'Mortificado': '#E88C5B',
            'Ansiedade': '#E88C5B',
            'Preocupa√ß√£o': '#E88C5B',
            'Inadequa√ß√£o': '#E88C5B',
            'Inferioridade': '#E88C5B',
            'Histeria': '#E88C5B',
            'P√¢nico': '#E88C5B',
            'Amedrontado': '#E88C5B',
            'Abandono': '#E88C5B'
        };

        const emocoesExplicacoes = {
            // Raiva
            '√ìdio': 'Avers√£o intensa e profunda, desejo de afastar ou eliminar algo/algu√©m',
            'Hostilidade': 'Atitude antagonista e agressiva, postura de oposi√ß√£o',
            'Agita√ß√£o': 'Estado de inquieta√ß√£o e perturba√ß√£o, dificuldade de se acalmar',
            'Frustra√ß√£o': 'Sentimento de desapontamento quando expectativas n√£o s√£o atendidas',
            'Irrita√ß√£o': 'Inc√¥modo e impaci√™ncia com situa√ß√µes ou pessoas',
            'Provoca√ß√£o': 'Sensa√ß√£o de estar sendo testado ou desafiado de forma negativa',
            'Ci√∫mes': 'Receio de perder algo/algu√©m para outro, possessividade',
            'Ressentimento': 'M√°goa guardada, sentimento de injusti√ßa n√£o resolvido',
            'Desespero': 'Perda de esperan√ßa, sensa√ß√£o de n√£o haver sa√≠da',
            'Revoltado': 'Indigna√ß√£o extrema, rebeldia contra uma situa√ß√£o',

            // Tristeza
            'Agoniado': 'Sofrimento intenso, ang√∫stia emocional profunda',
            'Machucado': 'Ferido emocionalmente, dor emocional por algo que aconteceu',
            'Depress√£o': 'Estado de profunda tristeza e falta de energia/motiva√ß√£o',
            'Pesar': 'Sentimento de lamento e peso no cora√ß√£o',
            'Consternado': 'Perplexidade dolorosa, choque com algo negativo',
            'Desagradado': 'Descontentamento, falta de satisfa√ß√£o com situa√ß√£o',
            'Arrependimento': 'Remorso por algo que fez ou deixou de fazer',
            'Culpa': 'Sensa√ß√£o de responsabilidade por algo negativo, autocr√≠tica',
            'Isolamento': 'Sensa√ß√£o de estar separado dos outros, desconex√£o',
            'Solit√°rio': 'Sentimento de solid√£o, falta de companhia',
            'Luto': 'Dor pela perda de algu√©m ou algo importante',
            'Impot√™ncia': 'Sensa√ß√£o de n√£o ter poder para mudar a situa√ß√£o',

            // Surpresa
            'Chocado': 'Impacto emocional forte, dificuldade de processar o inesperado',
            'Desiludido': 'Decep√ß√£o ao perceber que algo n√£o era como parecia',
            'Perplexo': 'Confus√£o e incerteza diante do inesperado',
            'At√¥nito': 'Paralisado pela surpresa, estupefato',
            'Impressionado': 'Marcado positivamente por algo inesperado',
            'Sem palavras': 'Incapacidade de expressar o que sente diante da surpresa',
            'Espantado': 'Surpreso de forma intensa, admirado',
            'Estimulado': 'Energizado e motivado por algo novo',
            'Tocado': 'Emocionalmente afetado de forma sens√≠vel',

            // Alegria
            'Gozo': 'Prazer intenso, satisfa√ß√£o plena',
            'Saciado': 'Plenamente satisfeito, necessidades atendidas',
            'Divertido': 'Entretenimento e alegria por algo engra√ßado ou prazeroso',
            'Deleite': 'Prazer refinado, aprecia√ß√£o profunda',
            'Jovial': 'Alegria leve e descontra√≠da, bom humor',
            'Aben√ßoado': 'Gratid√£o por se sentir agraciado, sortudo',
            'Triunfante': 'Vit√≥ria e conquista, sensa√ß√£o de sucesso',
            'Famoso': 'Reconhecimento social, sentir-se valorizado por muitos',
            'Esperan√ßoso': 'Otimismo sobre o futuro, expectativa positiva',
            'Ansioso': 'Expectativa intensa (positiva) por algo desejado',
            'Excitado': 'Energia alta com antecipa√ß√£o positiva',
            'Zelo': 'Entusiasmo fervoroso, dedica√ß√£o apaixonada',
            'J√∫bilo': 'Alegria exuberante, celebra√ß√£o intensa',
            'Euforia': 'Felicidade extrema, √™xtase de alegria',
            '√äxtase': 'Estado m√°ximo de prazer e alegria',
            'Sedu√ß√£o': 'Atra√ß√£o magn√©tica, charme e encantamento',

            // Amor
            'Pleno': 'Completude interior, paz e satisfa√ß√£o profunda',
            'Liberdade': 'Sensa√ß√£o de autonomia e aus√™ncia de restri√ß√µes',
            'Compaix√£o': 'Empatia ativa, desejo de aliviar o sofrimento alheio',
            'Cuidado': 'Aten√ß√£o dedicada ao bem-estar de algu√©m',
            'Fasc√≠nio': 'Encantamento intenso, absor√ß√£o total',
            'Paix√£o': 'Amor intenso e ardente, desejo profundo',
            'Atra√ß√£o': 'Interesse magn√©tico por algu√©m, desejo de proximidade',
            'Sens√≠vel': 'Delicadeza emocional, receptividade afetiva',
            'Carinho': 'Afeto terno e gentil, ternura',
            'Rom√¢ntico': 'Amor idealizado, valoriza√ß√£o da beleza do relacionamento',

            // Medo
            'Pavor': 'Terror extremo, medo paralisante',
            'Mortificado': 'Constrangimento profundo misturado com medo',
            'Ansiedade': 'Apreens√£o com o futuro, preocupa√ß√£o antecipada',
            'Preocupa√ß√£o': 'Inquieta√ß√£o com poss√≠veis problemas',
            'Inadequa√ß√£o': 'Sensa√ß√£o de n√£o ser bom o suficiente',
            'Inferioridade': 'Sentir-se menor ou pior que os outros',
            'Histeria': 'Rea√ß√£o de medo descontrolada, perda de controle emocional',
            'P√¢nico': 'Medo s√∫bito e avassalador, rea√ß√£o de fuga',
            'Amedrontado': 'Estado de medo persistente, intimida√ß√£o',
            'Abandono': 'Medo de ser deixado sozinho, rejei√ß√£o'
        };

        const emocoesHierarquia = {
            'Raiva': {
                emoji: 'üò†',
                intermediarias: {
                    'Furioso': ['√ìdio', 'Hostilidade'],
                    'Exasperado': ['Agita√ß√£o', 'Frustra√ß√£o'],
                    'Irritado': ['Irrita√ß√£o', 'Provoca√ß√£o'],
                    'Inveja': ['Ci√∫mes', 'Ressentimento'],
                    'Desgosto': ['Desespero', 'Revoltado']
                }
            },
            'Tristeza': {
                emoji: 'üò¢',
                intermediarias: {
                    'Sofrimento': ['Agoniado', 'Machucado'],
                    'Tristeza': ['Depress√£o', 'Pesar'],
                    'Desapontamento': ['Consternado', 'Desagradado'],
                    'Vergonha': ['Arrependimento', 'Culpa'],
                    'Neglig√™ncia': ['Isolamento', 'Solit√°rio'],
                    'Desespero': ['Luto', 'Impot√™ncia']
                }
            },
            'Surpresa': {
                emoji: 'üò≤',
                intermediarias: {
                    'Atordoamento': ['Chocado', 'Consternado'],
                    'Confus√£o': ['Desiludido', 'Perplexo'],
                    'Espanto': ['At√¥nito', 'Impressionado'],
                    'Supera√ß√£o': ['Sem palavras', 'Espantado'],
                    'Abalado': ['Estimulado', 'Tocado']
                }
            },
            'Alegria': {
                emoji: 'üòä',
                intermediarias: {
                    'Satisfeito': ['Gozo', 'Saciado'],
                    'Feliz': ['Divertido', 'Deleite'],
                    'Animado': ['Aben√ßoado', 'Jovial'],
                    'Orgulhoso': ['Famoso', 'Triunfante'],
                    'Otimista': ['Esperan√ßoso', 'Ansioso'],
                    'Entusiasmo': ['Zelo', 'Excitado'],
                    'Exaltado': ['J√∫bilo', 'Euforia'],
                    'Encantado': ['√äxtase', 'Sedu√ß√£o']
                }
            },
            'Amor': {
                emoji: 'ü•∞',
                intermediarias: {
                    'Pac√≠fico': ['Pleno', 'Liberdade'],
                    'Afetuoso': ['Compaix√£o', 'Cuidado'],
                    'Desejoso': ['Fasc√≠nio', 'Paix√£o'],
                    'Nost√°lgico': ['Atra√ß√£o', 'Sens√≠vel'],
                    'Encantado': ['Carinho', 'Rom√¢ntico']
                }
            },
            'Medo': {
                emoji: 'üò®',
                intermediarias: {
                    'Horrorizado': ['Pavor', 'Mortificado'],
                    'Nervoso': ['Ansiedade', 'Preocupa√ß√£o'],
                    'Inseguro': ['Inadequa√ß√£o', 'Inferioridade'],
                    'Aterrorizado': ['Histeria', 'P√¢nico'],
                    'Assustado': ['Amedrontado', 'Abandono']
                }
            }
        };

        let emocaoSelecionada = {
            central: '',
            intermediaria: '',
            especifica: ''
        };

        function inicializarApp() {
            const agora = new Date();
            agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
            document.getElementById('dataHora').value = agora.toISOString().slice(0, 16);

            criarGridEmocoes();
            configurarSliderIntensidade();
            carregarHistorico();
            atualizarEstatisticas();

            // Verificar se usu√°rio √© admin e mostrar aba
            verificarAdminSilencioso();
        }

        function criarGridEmocoes() {
            const grid = document.getElementById('emotionsGrid');
            const emocoesCentrais = Object.keys(emocoesHierarquia);

            grid.innerHTML = emocoesCentrais.map(nome => {
                const cor = emocoesCores[nome];
                return `
                    <button class="emotion-btn" onclick="selecionarEmocaoCentral('${nome}', this)"
                            style="border-color: ${cor}20; background: ${cor}10;">
                        <span class="emoji">${emocoesHierarquia[nome].emoji}</span>
                        ${nome}
                    </button>
                `;
            }).join('');
        }

        function selecionarEmocaoCentral(nome, btn) {
            document.querySelectorAll('#emotionsGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.central = nome;
            emocaoSelecionada.intermediaria = '';
            emocaoSelecionada.especifica = '';
                
            // Mostrar emo√ß√µes intermedi√°rias
            const intermediariasDiv = document.getElementById('intermediariasDiv');
            const intermediarias = Object.keys(emocoesHierarquia[nome].intermediarias);
            const cor = emocoesCores[nome];

            intermediariasDiv.innerHTML = `
                <div class="form-group">
                    <label><span class="emoji">üéØ</span> Qual tipo de ${nome}? (opcional)</label>
                    <div class="emotions-grid" id="intermediariasGrid">
                        ${intermediarias.map(inter => `
                            <button class="emotion-btn" onclick="selecionarIntermediaria('${inter}', this)"
                                    style="border-color: ${cor}40; background: ${cor}15;">
                                ${inter}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Limpar emo√ß√µes espec√≠ficas
            document.getElementById('especificasDiv').innerHTML = '';
        }

        function selecionarIntermediaria(nome, btn) {
            document.querySelectorAll('#intermediariasGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.intermediaria = nome;
            emocaoSelecionada.especifica = '';

            // Mostrar emo√ß√µes espec√≠ficas
            const especificasDiv = document.getElementById('especificasDiv');
            const especificas = emocoesHierarquia[emocaoSelecionada.central].intermediarias[nome];
            const cor = emocoesCores[emocaoSelecionada.central];

            especificasDiv.innerHTML = `
                <div class="form-group">
                    <label><span class="emoji">üîç</span> Mais especificamente: (opcional)</label>
                    <div class="emotions-grid" id="especificasGrid">
                        ${especificas.map(esp => {
                            const corEspecifica = emocoesCoresEspecificas[esp] || cor;
                            const explicacao = emocoesExplicacoes[esp] || '';
                            return `
                                <button class="emotion-btn" onclick="selecionarEspecifica('${esp}', this)"
                                        style="border-color: ${corEspecifica}; background: ${corEspecifica}30;">
                                    <span class="emocao-nome">${esp}</span>
                                    <span class="emocao-explicacao">${explicacao}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function selecionarEspecifica(nome, btn) {
            document.querySelectorAll('#especificasGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.especifica = nome;
        }

        function configurarSliderIntensidade() {
            const slider = document.getElementById('intensidade');
            const valor = document.getElementById('intensidadeValor');
            if (slider && valor) {
                slider.oninput = () => valor.textContent = slider.value;
            }
        }

        function atualizarSlidersIntensidade() {
            const intensidadesDiv = document.getElementById('intensidadesDiv');
            
            if (emocoesSelecionadas.length === 0) {
                intensidadesDiv.innerHTML = '';
                return;
            }
            
            intensidadesDiv.innerHTML = `
                <label><span class="emoji">üèöÔ∏è</span> Intensidade de cada emo√ß√£o (0-10)</label>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-bottom: 12px;">
                    üí° Ajuste a intensidade individualmente para cada emo√ß√£o selecionada
                </small>
                ${emocoesSelecionadas.map((emocao, index) => {
                    const cor = emocoesCores[emocao.central] || '#667eea';
                    const emoji = emocoesHierarquia[emocao.central]?.emoji || '‚ù§Ô∏è';
                    return `
                        <div style="margin-bottom: 15px; padding: 12px; background: ${cor}10; border-left: 4px solid ${cor}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: ${cor};"><span style="font-size: 18px;">${emoji}</span> ${emocao.central}</span>
                                <span style="font-weight: bold; font-size: 18px; color: ${cor};" id="intensidadeValor${index}">${emocao.intensidade || 5}</span>
                            </div>
                            <input type="range" min="0" max="10" value="${emocao.intensidade || 5}" 
                                   class="intensity-slider" 
                                   style="width: 100%;" 
                                   oninput="atualizarIntensidadeEmocao(${index}, this.value)">
                        </div>
                    `;
                }).join('')}
            `;
        }

        function atualizarIntensidadeEmocao(index, valor) {
            if (emocoesSelecionadas[index]) {
                emocoesSelecionadas[index].intensidade = parseInt(valor);
                document.getElementById(`intensidadeValor${index}`).textContent = valor;
            }
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Se n√£o houver event, procurar a tab pelo onclick
                document.querySelectorAll('.tab').forEach(t => {
                    if (t.getAttribute('onclick')?.includes(tabName)) {
                        t.classList.add('active');
                    }
                });
            }

            document.getElementById(tabName).classList.add('active');

            if (tabName === 'historico') carregarHistorico();
            if (tabName === 'exportar') atualizarEstatisticas();
            if (tabName === 'perfil') carregarPerfilUsuarioNaTela();
            if (tabName === 'admin') verificarAdmin();
        }

        function salvarRegistro() {
            const dataHora = document.getElementById('dataHora').value;
            const situacao = document.getElementById('situacao').value.trim();
            const pensamento = document.getElementById('pensamento').value.trim();
            const intensidade = document.getElementById('intensidade').value;
            const comportamento = document.getElementById('comportamento').value.trim();

            if (!dataHora || !situacao || !pensamento || !emocaoSelecionada.central || !comportamento) {
                mostrarToast('‚ö†Ô∏è Preencha todos os campos e selecione uma emo√ß√£o!');
                return;
            }

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado para salvar!');
                return;
            }

            const registro = {
                id: Date.now(),
                dataHora,
                situacao,
                pensamento,
                emocaoCentral: emocaoSelecionada.central,
                emocaoIntermediaria: emocaoSelecionada.intermediaria || '',
                emocaoEspecifica: emocaoSelecionada.especifica || '',
                intensidade,
                comportamento
            };

            // Salvar APENAS no Firebase
            console.log('‚òÅÔ∏è Salvando registro no Firebase...');
            salvarRegistroFirebase(registro).then(firebaseId => {
                if (firebaseId) {
                    // Adicionar √† mem√≥ria local
                    registro.firebaseId = firebaseId;
                    registrosEmMemoria.push(registro);
                    console.log('‚úÖ Registro salvo com sucesso! Firebase ID:', firebaseId);
                    document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                } else {
                    mostrarToast('‚ùå Erro ao salvar no Firebase');
                }
            }).catch(err => {
                console.error('‚ùå Erro ao salvar:', err);
                mostrarToast('‚ùå Erro ao salvar no Firebase');
                document.getElementById('syncStatus').textContent = '‚ö† Erro na sincroniza√ß√£o';
            });

            mostrarToast('‚úÖ Registro salvo com sucesso!');
            limparFormulario();
            setTimeout(() => showTab('historico'), 1500);
        }

        function limparFormulario() {
            document.getElementById('situacao').value = '';
            document.getElementById('pensamento').value = '';
            document.getElementById('comportamento').value = '';
            document.getElementById('intensidade').value = 5;
            document.getElementById('intensidadeValor').textContent = '5';
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            emocaoSelecionada = {
                central: '',
                intermediaria: '',
                especifica: ''
            };
            emocoesSelecionadas = [];
            document.getElementById('intermediariasDiv').innerHTML = '';
            document.getElementById('especificasDiv').innerHTML = '';

            const agora = new Date();
            agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
            document.getElementById('dataHora').value = agora.toISOString().slice(0, 16);
        }

        // Armazena registros em mem√≥ria (carregados do Firebase)
        let registrosEmMemoria = [];

        function getRegistros() {
            return registrosEmMemoria.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
        }

        function carregarHistorico() {
            const registros = getRegistros().sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            const lista = document.getElementById('entriesList');

            if (registros.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üìù</div>
                        <p>Nenhum registro ainda.<br>Comece fazendo seu primeiro registro!</p>
                    </div>
                `;
                return;
            }

            lista.innerHTML = registros.map(r => {
                const data = new Date(r.dataHora);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                const horaFormatada = data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

                const emocao = r.emocaoCentral || r.emocao || 'N√£o especificada';
                const cor = emocoesCores[emocao] || '#667eea';
                const emojiEmocao = emocoesHierarquia[emocao]?.emoji || '‚ù§Ô∏è';

                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <div class="entry-date">üìÖ ${dataFormatada} √†s ${horaFormatada}</div>
                            <div class="entry-actions">
                                <button class="icon-btn" onclick="deletarRegistro(${r.id})">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="entry-field">
                            <strong>Situa√ß√£o</strong>
                            <p>${r.situacao}</p>
                        </div>

                        <div class="entry-field">
                            <strong>Pensamento Autom√°tico</strong>
                            <p>${r.pensamento}</p>
                        </div>

                        <div class="entry-field">
                            <strong>Emo√ß√£o</strong>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <div style="background: ${cor}15; border: 2px solid ${cor}40; display: inline-flex; padding: 8px 12px; border-radius: 20px; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${emojiEmocao}</span>
                                    <span style="font-weight: bold; color: ${cor};">${emocao}</span>
                                    ${r.emocaoIntermediaria ? `<span>‚Üí ${r.emocaoIntermediaria}</span>` : ''}
                                    ${r.emocaoEspecifica ? `<span>‚Üí ${r.emocaoEspecifica}</span>` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-weight: bold; color: var(--primary); font-size: 18px;">
                                Intensidade: ${r.intensidade}/10
                            </div>
                        </div>

                        <div class="entry-field">
                            <strong>Comportamento</strong>
                            <p>${r.comportamento}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deletarRegistro(id) {
            if (!confirm('Tem certeza que deseja deletar este registro?')) return;

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            // Encontrar o registro para pegar o firebaseId
            const registro = registrosEmMemoria.find(r => r.id === id);
            const firebaseId = registro?.firebaseId;

            if (!firebaseId) {
                mostrarToast('‚ö†Ô∏è Erro: registro sem ID do Firebase');
                return;
            }

            // Deletar APENAS do Firebase
            console.log('‚òÅÔ∏è Excluindo registro do Firebase...', firebaseId);
            excluirRegistroFirebase(firebaseId).then(() => {
                // Remover da mem√≥ria
                registrosEmMemoria = registrosEmMemoria.filter(r => r.id !== id);
                console.log('‚úÖ Registro exclu√≠do do Firebase!');
                carregarHistorico();
                atualizarEstatisticas();
                mostrarToast('üóëÔ∏è Registro deletado');
            }).catch(err => {
                console.error('‚ùå Erro ao excluir do Firebase:', err);
                mostrarToast('‚ùå Erro ao excluir');
            });
        }

        function atualizarEstatisticas() {
            const registros = getRegistros();
            const total = registros.length;

            let somaIntensidade = 0;
            const contagemEmocoes = {};

            registros.forEach(r => {
                somaIntensidade += parseInt(r.intensidade);
                const emocao = r.emocaoCentral || r.emocao || 'N√£o especificada';
                contagemEmocoes[emocao] = (contagemEmocoes[emocao] || 0) + 1;
            });

            const mediaIntensidade = total > 0 ? (somaIntensidade / total).toFixed(1) : 0;
            const emocaoMaisFrequente = total > 0
                ? Object.keys(contagemEmocoes).reduce((a, b) => contagemEmocoes[a] > contagemEmocoes[b] ? a : b)
                : 'N/A';

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">REGISTROS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${mediaIntensidade}</div>
                    <div class="stat-label">INTENSIDADE M√âDIA</div>
                </div>
                <div class="stat-card" style="grid-column: 1 / -1;">
                    <div class="stat-value">${emocaoMaisFrequente}</div>
                    <div class="stat-label">EMO√á√ÉO MAIS FREQUENTE</div>
                </div>
            `;
        }

        function exportarPDF() {
            const registros = getRegistros();
            if (registros.length === 0) {
                mostrarToast('‚ö†Ô∏è Nenhum registro para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;
            const margemEsquerda = 15;
            const larguraPagina = 180;
            const alturaPagina = 280;

            // Cabe√ßalho com fundo colorido
            doc.setFillColor(102, 126, 234); // Cor prim√°ria
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('DI√ÅRIO EMOCIONAL', 105, 15, { align: 'center' });
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('KEITE FABIOLA - PSIC√ìLOGA 04/58498', 105, 22, { align: 'center' });
            doc.text('@PSIKEITEFABIOLA | (31) 9 8681-4865', 105, 28, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            y = 45;
            
            // Info de exporta√ß√£o
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`Exportado em: ${new Date().toLocaleString('pt-BR')}`, margemEsquerda, y);
            y += 10;

            // Registros
            registros.forEach((reg, index) => {
                // Verificar se precisa de nova p√°gina
                if (y > alturaPagina - 50) {
                    doc.addPage();
                    y = 20;
                }

                // Box do registro com fundo claro
                const yInicio = y;
                doc.setFillColor(248, 249, 250);
                doc.roundedRect(margemEsquerda - 3, y - 3, larguraPagina + 6, 18, 2, 2, 'F');
                
                // N√∫mero do registro
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text(`üìù Registro #${index + 1}`, margemEsquerda, y + 5);
                
                // Data/Hora no lado direito
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                const dataTexto = new Date(reg.dataHora).toLocaleString('pt-BR');
                doc.text(dataTexto, margemEsquerda + larguraPagina, y + 5, { align: 'right' });
                
                y += 18;
                doc.setTextColor(0, 0, 0);

                // Situa√ß√£o com box
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(52, 58, 64);
                doc.text('üìç Situa√ß√£o:', margemEsquerda, y);
                y += 6;
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(33, 37, 41);
                const linhasSituacao = doc.splitTextToSize(reg.situacao, larguraPagina - 6);
                doc.setFillColor(255, 252, 231);
                const alturaSituacao = (linhasSituacao.length * 5) + 4;
                doc.roundedRect(margemEsquerda, y - 2, larguraPagina, alturaSituacao, 1, 1, 'F');
                doc.text(linhasSituacao, margemEsquerda + 3, y + 2);
                y += alturaSituacao + 3;

                // Pensamento
                if (y > alturaPagina - 30) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(52, 58, 64);
                doc.text('üí≠ Pensamento Autom√°tico:', margemEsquerda, y);
                y += 6;
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(33, 37, 41);
                const linhasPensamento = doc.splitTextToSize(reg.pensamento, larguraPagina - 6);
                doc.setFillColor(232, 244, 253);
                const alturaPensamento = (linhasPensamento.length * 5) + 4;
                doc.roundedRect(margemEsquerda, y - 2, larguraPagina, alturaPensamento, 1, 1, 'F');
                doc.text(linhasPensamento, margemEsquerda + 3, y + 2);
                y += alturaPensamento + 3;

                // Emo√ß√£o(√µes)
                if (y > alturaPagina - 25) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(52, 58, 64);
                doc.text('‚ù§Ô∏è Emo√ß√£o:', margemEsquerda, y);
                y += 6;
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(33, 37, 41);
                let textoEmocao = reg.emocaoCentral || 'N√£o especificada';
                if (reg.emocaoIntermediaria) textoEmocao += ' ‚Üí ' + reg.emocaoIntermediaria;
                if (reg.emocaoEspecifica) textoEmocao += ' ‚Üí ' + reg.emocaoEspecifica;
                const linhasEmocao = doc.splitTextToSize(textoEmocao, larguraPagina - 6);
                doc.setFillColor(253, 237, 237);
                const alturaEmocao = (linhasEmocao.length * 5) + 4;
                doc.roundedRect(margemEsquerda, y - 2, larguraPagina, alturaEmocao, 1, 1, 'F');
                doc.text(linhasEmocao, margemEsquerda + 3, y + 2);
                y += alturaEmocao + 5;

                // Intensidade
                doc.setFillColor(220, 53, 69);
                doc.roundedRect(margemEsquerda, y - 2, 35, 8, 2, 2, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(`‚ö° ${reg.intensidade}/10`, margemEsquerda + 3, y + 3);
                doc.setTextColor(0, 0, 0);
                y += 10;

                // Comportamento
                if (y > alturaPagina - 25) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(52, 58, 64);
                doc.text('üé≠ Comportamento:', margemEsquerda, y);
                y += 6;
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(33, 37, 41);
                const linhasComportamento = doc.splitTextToSize(reg.comportamento, larguraPagina - 6);
                doc.setFillColor(237, 247, 237);
                const alturaComportamento = (linhasComportamento.length * 5) + 4;
                doc.roundedRect(margemEsquerda, y - 2, larguraPagina, alturaComportamento, 1, 1, 'F');
                doc.text(linhasComportamento, margemEsquerda + 3, y + 2);
                y += alturaComportamento + 10;

                // Linha separadora mais sutil
                if (index < registros.length - 1) {
                    if (y > alturaPagina - 15) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(margemEsquerda, y, margemEsquerda + larguraPagina, y);
                    y += 12;
                }
            });

            // Salvar PDF
            const nomeArquivo = `diario-emocional-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(nomeArquivo);
            mostrarToast('‚úÖ PDF baixado com sucesso!');
        }

        function exportarJSON() {
            const registros = getRegistros();
            const blob = new Blob([JSON.stringify(registros, null, 2)], { type: 'application/json' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.json`);
            mostrarToast('üì• JSON baixado!');
        }

        function exportarCSV() {
            const registros = getRegistros();
            let csv = 'Data,Hora,Situa√ß√£o,Pensamento,Emo√ß√£o,Intensidade,Comportamento\n';

            registros.forEach(r => {
                const data = new Date(r.dataHora);
                let emocaoTexto = r.emocaoCentral || '';
                if (r.emocaoIntermediaria) emocaoTexto += ' > ' + r.emocaoIntermediaria;
                if (r.emocaoEspecifica) emocaoTexto += ' > ' + r.emocaoEspecifica;
                
                const linha = [
                    data.toLocaleDateString('pt-BR'),
                    data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                    `"${r.situacao.replace(/"/g, '""')}"`,
                    `"${r.pensamento.replace(/"/g, '""')}"`,
                    `"${emocaoTexto}"`,
                    r.intensidade,
                    `"${r.comportamento.replace(/"/g, '""')}"`
                ].join(',');
                csv += linha + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.csv`);
            mostrarToast('üì• CSV baixado!');
        }

        function exportarTexto() {
            const registros = getRegistros();
            let texto = 'DI√ÅRIO EMOCIONAL - REGISTRO TCC\n';
            texto += '='.repeat(50) + '\n\n';

            registros.forEach((r, i) => {
                const data = new Date(r.dataHora);
                texto += `REGISTRO ${i + 1}\n`;
                texto += `Data: ${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}\n\n`;
                texto += `SITUA√á√ÉO:\n${r.situacao}\n\n`;
                texto += `PENSAMENTO AUTOM√ÅTICO:\n${r.pensamento}\n\n`;
                texto += `EMO√á√ÉO:\n${r.emocaoCentral || 'N√£o especificada'}`;
                if (r.emocaoIntermediaria) texto += ` ‚Üí ${r.emocaoIntermediaria}`;
                if (r.emocaoEspecifica) texto += ` ‚Üí ${r.emocaoEspecifica}`;
                texto += `\n\nINTENSIDADE: ${r.intensidade}/10\n\n`;
                texto += `COMPORTAMENTO:\n${r.comportamento}\n\n`;
                texto += '-'.repeat(50) + '\n\n';
            });

            const blob = new Blob([texto], { type: 'text/plain;charset=utf-8;' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.txt`);
            mostrarToast('üì• TXT baixado!');
        }

        function baixarArquivo(blob, nomeArquivo) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function limparTodosDados() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai apagar TODOS os seus registros permanentemente do Firebase. Tem certeza?')) return;
            if (!confirm('√öltima confirma√ß√£o: Todos os dados ser√£o perdidos. Continuar?')) return;

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                // Deletar todos do Firebase
                const batch = db.batch();
                const snapshot = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').get();

                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                registrosEmMemoria = [];

                carregarHistorico();
                atualizarEstatisticas();
                mostrarToast('üóëÔ∏è Todos os dados foram apagados');
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                mostrarToast('‚ùå Erro ao apagar dados');
            }
        }

        function mostrarToast(mensagem) {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ===== CONFIGURA√á√ÉO DO FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyA5g7m_dOZ-ca707_ttxtX_NdQet5pKETg",
            authDomain: "diario-emocional-2c464.firebaseapp.com",
            projectId: "diario-emocional-2c464",
            storageBucket: "diario-emocional-2c464.firebasestorage.app",
            messagingSenderId: "306504477100",
            appId: "1:306504477100:web:655191303f79a95e13f209"
        };

        // Inicializar Firebase
        let app, auth, db;
        let isLoginMode = true;
        let currentUser = null;

        // Mostrar tela de login imediatamente se der erro
        function showLoginFallback() {
            console.log('üîì Mostrando tela de login');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Tentar inicializar Firebase
        try {
            console.log('üîÑ Tentando inicializar Firebase...');

            if (typeof firebase === 'undefined') {
                console.error('‚ùå Firebase n√£o dispon√≠vel');
                showLoginFallback();
            } else {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                console.log('‚úÖ Firebase inicializado com sucesso');

                // Verificar autentica√ß√£o - onAuthStateChanged √© chamado imediatamente
                auth.onAuthStateChanged(async user => {
                    console.log('üë§ Estado de autentica√ß√£o:', user ? 'Logado' : 'Deslogado');

                    // Garantir que esconde o loading
                    const loadingEl = document.getElementById('loadingScreen');
                    if (loadingEl) loadingEl.classList.add('hidden');

                    if (user) {
                        console.log('‚úÖ Usu√°rio autenticado:', user.email);
                        currentUser = user;

                        // Carregar perfil do usu√°rio
                        let perfil = await carregarPerfilUsuario(user.uid);

                        // Se o perfil n√£o existir, criar um perfil b√°sico
                        if (!perfil) {
                            console.log('‚ö†Ô∏è Perfil n√£o encontrado, criando perfil b√°sico...');
                            const perfilBasico = {
                                email: user.email,
                                nomeCompleto: user.displayName || user.email.split('@')[0],
                                role: 'user',
                                status: 'ativo',
                                criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                                ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            try {
                                await db.collection('usuarios').doc(user.uid).set(perfilBasico);
                                perfil = perfilBasico;
                                console.log('‚úÖ Perfil b√°sico criado');
                            } catch (error) {
                                console.error('‚ùå Erro ao criar perfil b√°sico:', error);
                            }
                        } else {
                            // Atualizar √∫ltima atividade
                            try {
                                await db.collection('usuarios').doc(user.uid).update({
                                    ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                console.log('‚úÖ √öltima atividade atualizada');
                            } catch (error) {
                                console.error('‚ö†Ô∏è Erro ao atualizar √∫ltima atividade:', error);
                            }
                        }

                        // Atualizar informa√ß√µes do usu√°rio
                        const userName = document.getElementById('userName');
                        const userEmail = document.getElementById('userEmail');

                        if (perfil && perfil.nomeCompleto) {
                            if (userName) userName.textContent = perfil.nomeCompleto;
                        } else if (user.displayName) {
                            if (userName) userName.textContent = user.displayName;
                        } else {
                            if (userName) userName.textContent = user.email.split('@')[0];
                        }

                        if (userEmail) userEmail.textContent = user.email;

                        // Mostrar app imediatamente e carregar dados em background
                        showApp();
                        carregarDadosFirebase().catch(err => console.warn('Erro ao carregar dados:', err));
                    } else {
                        console.log('‚ùå Usu√°rio n√£o autenticado');
                        showLogin();
                    }
                });
            }
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Firebase:', error);
            showLoginFallback();
        }

        // Carregar perfil do usu√°rio do Firestore
        async function carregarPerfilUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const perfil = doc.data();
                    return perfil;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualizar sauda√ß√£o com nome do usu√°rio e per√≠odo do dia
        async function atualizarSaudacao() {
            const hora = new Date().getHours();
            let saudacao;

            if (hora >= 5 && hora < 12) {
                saudacao = 'üåÖ Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = '‚òÄÔ∏è Boa tarde';
            } else {
                saudacao = 'üåô Boa noite';
            }

            let nomeUsuario = 'Usu√°rio';

            // Tentar pegar o nome do perfil
            if (currentUser) {
                const perfil = await carregarPerfilUsuario(currentUser.uid);
                if (perfil && perfil.nomeCompleto) {
                    nomeUsuario = perfil.nomeCompleto.split(' ')[0]; // Primeiro nome
                } else if (currentUser.displayName) {
                    nomeUsuario = currentUser.displayName.split(' ')[0];
                } else if (currentUser.email) {
                    nomeUsuario = currentUser.email.split('@')[0];
                }
            }

            document.getElementById('greetingMessage').textContent = `${saudacao}, ${nomeUsuario}!`;
        }

        // Atualizar data e hora em tempo real
        function atualizarDataHora() {
            const atualizar = () => {
                const agora = new Date();
                const opcoes = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dataFormatada = agora.toLocaleDateString('pt-BR', opcoes);
                document.getElementById('currentDateTime').textContent = dataFormatada;
            };

            atualizar();
            // Atualizar a cada minuto
            setInterval(atualizar, 60000);
        }

        // Gerenciar tema (Dark Mode)
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');

            body.classList.toggle('dark-mode');

            if (body.classList.contains('dark-mode')) {
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            }
        }

        // Carregar prefer√™ncia de tema
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                if (themeIcon) themeIcon.textContent = 'üåô';
            }
        }

        function showApp() {
            console.log('üì± Mostrando app...');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('active');

            // IMPORTANTE: Esconder aba admin por padr√£o (s√≥ mostra se for admin)
            document.getElementById('adminTab').style.display = 'none';

            // Limpar dados de sess√£o anterior
            window.perfilAtual = null;

            // Carregar tema preferido
            loadTheme();

            // Inicializar app imediatamente
            inicializarApp();
            atualizarSaudacao();
            atualizarDataHora();
            console.log('‚úÖ App inicializado!');
        }

        function showLogin() {
            console.log('üîê Mostrando tela de login...');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const buttonText = document.getElementById('authButtonText');
            const toggleText = document.getElementById('toggleText');
            const toggleLink = document.getElementById('toggleLink');
            const signupFields = document.getElementById('signupFields');
            const termsCheckbox = document.getElementById('termsCheckbox');

            if (isLoginMode) {
                buttonText.textContent = 'Entrar';
                toggleText.textContent = 'N√£o tem conta?';
                toggleLink.textContent = 'Criar conta';
                signupFields.classList.add('hidden');
                termsCheckbox.classList.add('hidden');
            } else {
                buttonText.textContent = 'Criar Conta';
                toggleText.textContent = 'J√° tem conta?';
                toggleLink.textContent = 'Fazer login';
                signupFields.classList.remove('hidden');
                termsCheckbox.classList.remove('hidden');
            }
        }

        async function handleEmailAuth() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            console.log('üîë Tentando autenticar...', { email, mode: isLoginMode ? 'login' : 'criar' });

            if (!email || !password) {
                showError('Preencha email e senha');
                return;
            }

            if (password.length < 6) {
                showError('Senha deve ter no m√≠nimo 6 caracteres');
                return;
            }

            // Se for cadastro, validar campos extras
            if (!isLoginMode) {
                const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
                const acceptTerms = document.getElementById('acceptTerms').checked;

                if (!nomeCompleto) {
                    showError('Preencha seu nome completo');
                    return;
                }

                if (!acceptTerms) {
                    showError('Voc√™ precisa aceitar os termos de uso');
                    return;
                }
            }

            try {
                // Garantir persist√™ncia LOCAL antes de fazer login
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                console.log('üîí Persist√™ncia LOCAL ativada');

                if (isLoginMode) {
                    console.log('üìß Fazendo login...');
                    const result = await auth.signInWithEmailAndPassword(email, password);
                    console.log('‚úÖ Login realizado:', result.user.email);

                    // Verificar se usu√°rio est√° ativo
                    const perfilDoc = await db.collection('usuarios').doc(result.user.uid).get();
                    if (perfilDoc.exists) {
                        const perfil = perfilDoc.data();
                        if (perfil.status === 'inativo') {
                            // Fazer logout imediatamente
                            await auth.signOut();
                            showError('‚ùå Sua conta est√° inativa. Entre em contato com o administrador.');
                            return;
                        }
                    }
                } else {
                    console.log('üìù Criando conta...');
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    console.log('‚úÖ Conta criada:', result.user.email);

                    // Salvar informa√ß√µes adicionais do usu√°rio
                    await salvarPerfilUsuario(result.user.uid);
                }

                // onAuthStateChanged vai chamar showApp() automaticamente
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                console.error('C√≥digo:', error.code);
                console.error('Mensagem:', error.message);

                const messages = {
                    'auth/email-already-in-use': 'Email j√° cadastrado',
                    'auth/invalid-email': 'Email inv√°lido',
                    'auth/user-not-found': 'Usu√°rio n√£o encontrado',
                    'auth/wrong-password': 'Senha incorreta',
                    'auth/weak-password': 'Senha muito fraca',
                    'auth/network-request-failed': 'Erro de conex√£o',
                    'auth/operation-not-allowed': '‚ö†Ô∏è Configure Authentication no Firebase Console',
                    'auth/unauthorized-domain': '‚ö†Ô∏è Adicione "localhost" nos dom√≠nios autorizados do Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains'
                };

                let errorMsg = messages[error.code] || error.message || 'Erro ao autenticar';

                // Se for 400, pode ser dom√≠nio n√£o autorizado
                if (!error.code && error.message && error.message.includes('400')) {
                    errorMsg = '‚ö†Ô∏è ERRO 400: Verifique no Firebase Console:\n' +
                               '1. Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí Adicione "localhost"\n' +
                               '2. Ou teste usando o authDomain: diario-emocional-2c464.firebaseapp.com';
                    console.error('üí° Solu√ß√£o: Adicione localhost nos dom√≠nios autorizados ou teste via Firebase Hosting');
                }

                showError(errorMsg);
            }
        }

        async function handleGoogleAuth() {
            try {
                // Garantir persist√™ncia LOCAL antes de fazer login
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                console.log('üîí Persist√™ncia LOCAL ativada (Google)');

                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Erro Google:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showError('Erro ao fazer login com Google');
                }
            }
        }

        // Salvar perfil do usu√°rio no Firestore
        async function salvarPerfilUsuario(uid) {
            try {
                const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
                const dataNascimento = document.getElementById('dataNascimento').value;
                const genero = document.getElementById('genero').value;

                const perfil = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    email: currentUser?.email || auth.currentUser?.email,
                    role: 'user', // Novo usu√°rio sempre come√ßa como 'user'
                    status: 'ativo',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('usuarios').doc(uid).set(perfil);

                // Atualizar displayName no Authentication
                if (auth.currentUser) {
                    await auth.currentUser.updateProfile({
                        displayName: nomeCompleto
                    });
                }

                console.log('‚úÖ Perfil do usu√°rio salvo com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao salvar perfil:', error);
                // N√£o bloquear o cadastro por falha ao salvar perfil
            }
        }

        // Carregar perfil do usu√°rio do Firestore
        async function carregarPerfilUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const perfil = doc.data();
                    return perfil;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualizar sauda√ß√£o com nome do usu√°rio e per√≠odo do dia
        async function atualizarSaudacao() {
            const hora = new Date().getHours();
            let saudacao;

            if (hora >= 5 && hora < 12) {
                saudacao = 'üåÖ Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = '‚òÄÔ∏è Boa tarde';
            } else {
                saudacao = 'üåô Boa noite';
            }

            let nomeUsuario = 'Usu√°rio';

            // Tentar pegar o nome do perfil
            if (currentUser) {
                const perfil = await carregarPerfilUsuario(currentUser.uid);
                if (perfil && perfil.nomeCompleto) {
                    nomeUsuario = perfil.nomeCompleto.split(' ')[0]; // Primeiro nome
                } else if (currentUser.displayName) {
                    nomeUsuario = currentUser.displayName.split(' ')[0];
                } else if (currentUser.email) {
                    nomeUsuario = currentUser.email.split('@')[0];
                }
            }

            document.getElementById('greetingMessage').textContent = `${saudacao}, ${nomeUsuario}!`;
        }

        // Atualizar data e hora em tempo real
        function atualizarDataHora() {
            const atualizar = () => {
                const agora = new Date();
                const opcoes = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dataFormatada = agora.toLocaleDateString('pt-BR', opcoes);
                document.getElementById('currentDateTime').textContent = dataFormatada;
            };

            atualizar();
            // Atualizar a cada minuto
            setInterval(atualizar, 60000);
        }

        // Mostrar termos de uso
        function mostrarTermos() {
            alert('TERMOS DE USO\n\n' +
                '1. Este aplicativo √© um di√°rio pessoal para registros emocionais.\n' +
                '2. Seus dados s√£o privados e protegidos por criptografia.\n' +
                '3. Apenas voc√™ tem acesso aos seus registros.\n' +
                '4. N√£o compartilhamos seus dados com terceiros.\n' +
                '5. Voc√™ pode excluir sua conta e dados a qualquer momento.\n' +
                '6. Este app n√£o substitui tratamento psicol√≥gico profissional.');
        }

        function mostrarPrivacidade() {
            alert('POL√çTICA DE PRIVACIDADE\n\n' +
                '1. Coletamos: email, nome e dados emocionais que voc√™ registra.\n' +
                '2. Uso: Apenas para funcionamento do aplicativo.\n' +
                '3. Armazenamento: Firebase (Google Cloud) com criptografia.\n' +
                '4. Compartilhamento: N√£o compartilhamos com terceiros.\n' +
                '5. Seus direitos: Acesso, corre√ß√£o e exclus√£o dos seus dados.\n' +
                '6. Seguran√ßa: Autentica√ß√£o, regras de seguran√ßa e isolamento de dados.\n' +
                '7. Contato: Para d√∫vidas sobre privacidade, entre em contato.');
        }

        async function handleLogout() {
            if (!confirm('Deseja realmente sair?')) return;

            try {
                console.log('üö™ Fazendo logout...');

                if (auth) {
                    await auth.signOut();
                    console.log('‚úÖ Logout realizado com sucesso');
                }

                // Limpar dados da mem√≥ria por seguran√ßa
                registrosEmMemoria = [];
                currentUser = null;
                window.perfilAtual = null;

                // Esconder aba admin
                document.getElementById('adminTab').style.display = 'none';

                showLogin();

            } catch (error) {
                console.error('‚ùå Erro ao sair:', error);
                registrosEmMemoria = [];
                currentUser = null;
                window.perfilAtual = null;
                document.getElementById('adminTab').style.display = 'none';
                showLogin();
            }
        }

        // ===== FUN√á√ïES DE PERFIL =====

        // Carregar perfil do usu√°rio na tela
        async function carregarPerfilUsuarioNaTela() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const perfil = await carregarPerfilUsuario(currentUser.uid);

                document.getElementById('profileName').textContent = perfil?.nomeCompleto || currentUser.displayName || 'N√£o informado';
                document.getElementById('profileEmail').textContent = currentUser.email || 'N√£o informado';

                if (perfil?.dataNascimento) {
                    // Converter data sem problemas de timezone
                    const [ano, mes, dia] = perfil.dataNascimento.split('-');
                    const data = new Date(ano, mes - 1, dia);
                    document.getElementById('profileBirthdate').textContent = data.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById('profileBirthdate').textContent = 'N√£o informado';
                }

                const generos = {
                    'masculino': 'Masculino',
                    'feminino': 'Feminino',
                    'outro': 'Outro',
                    'prefiro-nao-dizer': 'Prefiro n√£o dizer'
                };
                document.getElementById('profileGender').textContent = generos[perfil?.genero] || 'N√£o informado';

                if (currentUser.metadata?.creationTime) {
                    const dataCriacao = new Date(currentUser.metadata.creationTime);
                    document.getElementById('profileSince').textContent = dataCriacao.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById('profileSince').textContent = 'N√£o dispon√≠vel';
                }

                // Armazenar dados do perfil para edi√ß√£o COM O UID DO USU√ÅRIO
                window.perfilAtual = {
                    ...perfil,
                    uid: currentUser.uid,
                    email: currentUser.email
                };

                console.log('‚úÖ Perfil carregado para usu√°rio:', currentUser.email, 'UID:', currentUser.uid);
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                mostrarToast('‚ùå Erro ao carregar perfil');
            }
        }

        // Habilitar modo de edi√ß√£o do perfil
        function habilitarEdicaoPerfil() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            console.log('üîç Tentando editar perfil. CurrentUser:', currentUser.email, currentUser.uid);
            console.log('üîç PerfilAtual:', window.perfilAtual);

            // Validar que o perfilAtual pertence ao usu√°rio logado
            if (window.perfilAtual && window.perfilAtual.uid && window.perfilAtual.uid !== currentUser.uid) {
                console.error('‚ö†Ô∏è SEGURAN√áA: Tentativa de editar perfil de outro usu√°rio!');
                console.error('   CurrentUser UID:', currentUser.uid);
                console.error('   PerfilAtual UID:', window.perfilAtual.uid);
                mostrarToast('‚ùå Erro de seguran√ßa detectado. Recarregando perfil...');
                window.perfilAtual = null; // Limpar dados incorretos
                carregarPerfilUsuarioNaTela(); // Recarregar perfil correto
                return;
            }

            // Se n√£o tem perfilAtual ou n√£o tem UID, recarregar
            if (!window.perfilAtual || !window.perfilAtual.uid) {
                console.warn('‚ö†Ô∏è PerfilAtual inv√°lido ou sem UID. Recarregando...');
                carregarPerfilUsuarioNaTela();
                return;
            }

            // Preencher campos de edi√ß√£o com dados atuais DO USU√ÅRIO LOGADO
            const perfil = window.perfilAtual || {};

            document.getElementById('editNomeCompleto').value = perfil.nomeCompleto || currentUser?.displayName || '';
            document.getElementById('editEmail').value = currentUser?.email || '';
            document.getElementById('editDataNascimento').value = perfil.dataNascimento || '';
            document.getElementById('editGenero').value = perfil.genero || '';

            console.log('‚úÖ Modo de edi√ß√£o habilitado para:', currentUser.email);

            // Alternar visualiza√ß√£o
            document.getElementById('profileViewMode').style.display = 'none';
            document.getElementById('profileEditMode').style.display = 'block';

            // Alternar bot√µes
            document.getElementById('btnEditProfile').style.display = 'none';
            document.getElementById('btnCancelEdit').style.display = 'inline-block';
            document.getElementById('btnSaveProfile').style.display = 'inline-block';
        }

        // Cancelar edi√ß√£o do perfil
        function cancelarEdicaoPerfil() {
            // Voltar para modo visualiza√ß√£o
            document.getElementById('profileViewMode').style.display = 'block';
            document.getElementById('profileEditMode').style.display = 'none';

            // Alternar bot√µes
            document.getElementById('btnEditProfile').style.display = 'inline-block';
            document.getElementById('btnCancelEdit').style.display = 'none';
            document.getElementById('btnSaveProfile').style.display = 'none';
        }

        // Salvar edi√ß√µes do perfil
        async function salvarEdicaoPerfil() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const nomeCompleto = document.getElementById('editNomeCompleto').value.trim();
                const dataNascimento = document.getElementById('editDataNascimento').value;
                const genero = document.getElementById('editGenero').value;

                // Valida√ß√£o
                if (!nomeCompleto) {
                    mostrarToast('‚ö†Ô∏è O nome completo √© obrigat√≥rio');
                    return;
                }

                console.log('üìù Atualizando perfil...');

                // Carregar perfil atual para preservar o role
                const perfilAtual = await carregarPerfilUsuario(currentUser.uid);

                // Atualizar no Firestore (usando set com merge para criar se n√£o existir)
                const perfilAtualizado = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    email: currentUser.email,
                    role: perfilAtual?.role || 'user', // Preservar role existente ou usar 'user' como padr√£o
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Usar set com merge para criar o documento se n√£o existir
                await db.collection('usuarios').doc(currentUser.uid).set(perfilAtualizado, { merge: true });

                // Atualizar displayName no Authentication
                if (currentUser) {
                    await currentUser.updateProfile({
                        displayName: nomeCompleto
                    });
                }

                console.log('‚úÖ Perfil atualizado com sucesso');
                mostrarToast('‚úÖ Perfil atualizado com sucesso!');

                // Recarregar perfil na tela
                await carregarPerfilUsuarioNaTela();

                // Voltar para modo visualiza√ß√£o
                cancelarEdicaoPerfil();

                // Atualizar sauda√ß√£o se o nome mudou
                atualizarSaudacao();

            } catch (error) {
                console.error('‚ùå Erro ao atualizar perfil:', error);
                mostrarToast('‚ùå Erro ao atualizar perfil: ' + error.message);
            }
        }

        // Confirmar exclus√£o da conta
        function confirmarExclusaoConta() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o √© IRREVERS√çVEL!\n\nTodos os seus dados (perfil e registros emocionais) ser√£o permanentemente exclu√≠dos.\n\nDeseja realmente excluir sua conta?')) {
                if (confirm('√öltima confirma√ß√£o: Tem certeza absoluta?')) {
                    excluirMinhaConta();
                }
            }
        }

        // Excluir conta do usu√°rio
        async function excluirMinhaConta() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                console.log('üóëÔ∏è Excluindo conta...');
                const uid = currentUser.uid;

                // 1. Deletar todos os registros do usu√°rio
                const registrosRef = db.collection('usuarios').doc(uid).collection('registros');
                const snapshot = await registrosRef.get();

                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log('‚úÖ Registros exclu√≠dos');

                // 2. Deletar perfil do usu√°rio
                await db.collection('usuarios').doc(uid).delete();
                console.log('‚úÖ Perfil exclu√≠do');

                // 3. Deletar conta do Firebase Auth
                await currentUser.delete();
                console.log('‚úÖ Conta exclu√≠da do Firebase Auth');

                // Limpar dados locais
                registrosEmMemoria = [];
                currentUser = null;

                alert('‚úÖ Sua conta foi exclu√≠da com sucesso. Sentiremos sua falta!');
                showLogin();

            } catch (error) {
                console.error('‚ùå Erro ao excluir conta:', error);

                if (error.code === 'auth/requires-recent-login') {
                    alert('‚ö†Ô∏è Por seguran√ßa, voc√™ precisa fazer login novamente antes de excluir sua conta.\n\nFa√ßa logout e login novamente, depois tente excluir.');
                } else {
                    mostrarToast('‚ùå Erro ao excluir conta: ' + error.message);
                }
            }
        }

        // ===== FUN√á√ïES ADMINISTRATIVAS =====

        // Verificar se usu√°rio √© admin
        async function verificarAdmin() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                // Buscar role do usu√°rio no Firestore
                const doc = await db.collection('usuarios').doc(currentUser.uid).get();

                if (!doc.exists) {
                    mostrarToast('‚ö†Ô∏è Perfil n√£o encontrado');
                    showTab('novo', null);
                    return;
                }

                const perfil = doc.data();
                const isAdmin = perfil.role === 'admin';

                if (isAdmin) {
                    document.getElementById('adminTab').style.display = 'block';
                } else {
                    mostrarToast('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o de administrador');
                    showTab('novo', null);
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar admin:', error);
            }
        }

        // Verificar se usu√°rio √© admin (sem mensagem de erro)
        async function verificarAdminSilencioso() {
            if (!currentUser) return;

            try {
                // Buscar role do usu√°rio no Firestore
                const doc = await db.collection('usuarios').doc(currentUser.uid).get();

                if (!doc.exists) return;

                const perfil = doc.data();
                const isAdmin = perfil.role === 'admin';

                if (isAdmin) {
                    document.getElementById('adminTab').style.display = 'block';
                    // Carregar dashboard automaticamente
                    carregarDashboardAdmin();
                    console.log('‚úÖ Usu√°rio √© admin - aba administrativa habilitada');
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar admin:', error);
            }
        }

        // ===== DASHBOARD ADMINISTRATIVO =====

        // Carregar estat√≠sticas do dashboard
        async function carregarDashboardAdmin() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                console.log('üìä Carregando dashboard administrativo...');

                // Buscar todos os usu√°rios
                const usuariosSnapshot = await db.collection('usuarios').get();
                const totalUsuarios = usuariosSnapshot.size;

                // Calcular usu√°rios ativos (√∫ltimos 7 dias)
                const seteDiasAtras = new Date();
                seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);

                let usuariosAtivos = 0;
                let usuariosInativos = 0;
                let totalRegistros = 0;

                // Processar cada usu√°rio
                for (const userDoc of usuariosSnapshot.docs) {
                    const userData = userDoc.data();

                    // Verificar status
                    if (userData.status === 'inativo') {
                        usuariosInativos++;
                    }

                    // Verificar √∫ltima atividade
                    if (userData.ultimaAtividade) {
                        const ultimaAtividade = userData.ultimaAtividade.toDate();
                        if (ultimaAtividade >= seteDiasAtras) {
                            usuariosAtivos++;
                        }
                    }

                    // Contar registros do usu√°rio
                    const registrosSnapshot = await db.collection('usuarios')
                        .doc(userDoc.id)
                        .collection('registros')
                        .get();
                    totalRegistros += registrosSnapshot.size;
                }

                // Atualizar interface
                document.getElementById('totalUsuarios').textContent = totalUsuarios;
                document.getElementById('usuariosAtivos').textContent = usuariosAtivos;
                document.getElementById('totalRegistros').textContent = totalRegistros;
                document.getElementById('usuariosInativos').textContent = usuariosInativos;

                console.log('‚úÖ Dashboard carregado:', {
                    total: totalUsuarios,
                    ativos: usuariosAtivos,
                    registros: totalRegistros,
                    inativos: usuariosInativos
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                mostrarToast('‚ùå Erro ao carregar estat√≠sticas');
            }
        }

        // Carregar lista de usu√°rios (admin)
        async function carregarListaUsuarios() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                console.log('üìã Carregando lista de usu√°rios...');
                const usuariosRef = db.collection('usuarios');
                const snapshot = await usuariosRef.get();

                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';

                if (snapshot.empty) {
                    usersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum usu√°rio cadastrado</p>';
                    return;
                }

                const usuarios = [];

                // Buscar usu√°rios e contar seus registros
                for (const doc of snapshot.docs) {
                    const userData = doc.data();

                    // Contar registros do usu√°rio
                    const registrosSnapshot = await db.collection('usuarios')
                        .doc(doc.id)
                        .collection('registros')
                        .get();

                    usuarios.push({
                        uid: doc.id,
                        ...userData,
                        totalRegistros: registrosSnapshot.size
                    });
                }

                // Ordenar por data de cria√ß√£o (mais recentes primeiro)
                usuarios.sort((a, b) => {
                    const dateA = a.criadoEm?.toDate() || new Date(0);
                    const dateB = b.criadoEm?.toDate() || new Date(0);
                    return dateB - dateA;
                });

                usuarios.forEach(usuario => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';

                    const dataCriacao = usuario.criadoEm?.toDate()
                        ? usuario.criadoEm.toDate().toLocaleDateString('pt-BR')
                        : 'Data desconhecida';

                    // Formatar √∫ltima atividade
                    let ultimaAtividadeTexto = 'Nunca';
                    if (usuario.ultimaAtividade) {
                        const dataAtividade = usuario.ultimaAtividade.toDate();
                        const diasAtras = Math.floor((new Date() - dataAtividade) / (1000 * 60 * 60 * 24));
                        if (diasAtras === 0) {
                            ultimaAtividadeTexto = 'Hoje';
                        } else if (diasAtras === 1) {
                            ultimaAtividadeTexto = 'Ontem';
                        } else if (diasAtras < 7) {
                            ultimaAtividadeTexto = `${diasAtras} dias atr√°s`;
                        } else if (diasAtras < 30) {
                            ultimaAtividadeTexto = `${Math.floor(diasAtras / 7)} semanas atr√°s`;
                        } else {
                            ultimaAtividadeTexto = dataAtividade.toLocaleDateString('pt-BR');
                        }
                    }

                    // Badge de role
                    const roleBadge = usuario.role === 'admin'
                        ? '<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">üîê ADMIN</span>'
                        : '';

                    // Badge de status
                    const statusBadge = usuario.status === 'inativo'
                        ? '<span style="background: #e74c3c; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">üö´ INATIVO</span>'
                        : '<span style="background: #27ae60; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">‚úÖ ATIVO</span>';

                    userItem.innerHTML = `
                        <div class="user-item-info">
                            <div class="user-item-name">
                                ${usuario.nomeCompleto || 'Nome n√£o informado'}
                                ${roleBadge}
                                ${statusBadge}
                            </div>
                            <div class="user-item-email">${usuario.email || 'Email n√£o informado'}</div>
                            <div class="user-item-email">
                                üìÖ Membro desde: ${dataCriacao} |
                                üïí √öltima atividade: ${ultimaAtividadeTexto} |
                                üìù ${usuario.totalRegistros} registro(s)
                            </div>
                        </div>
                        <div class="user-item-actions">
                            <button class="btn-delete-user" style="background: var(--primary);" onclick="editarUsuarioAdmin('${usuario.uid}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn-delete-user" onclick="excluirUsuarioAdmin('${usuario.uid}', '${usuario.email}')">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    `;

                    usersList.appendChild(userItem);
                });

                mostrarToast(`‚úÖ ${usuarios.length} usu√°rio(s) carregado(s)`);

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                mostrarToast('‚ùå Erro ao carregar usu√°rios');
            }
        }

        // Excluir usu√°rio (admin)
        async function excluirUsuarioAdmin(uid, email) {
            if (!confirm(`‚ö†Ô∏è Deseja realmente excluir o usu√°rio:\n\n${email}\n\nTodos os dados ser√£o permanentemente removidos!`)) {
                return;
            }

            try {
                console.log('üóëÔ∏è Excluindo usu√°rio:', uid);

                // 1. Deletar todos os registros do usu√°rio
                const registrosRef = db.collection('usuarios').doc(uid).collection('registros');
                const snapshot = await registrosRef.get();

                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log('‚úÖ Registros do usu√°rio exclu√≠dos');

                // 2. Deletar perfil do usu√°rio
                await db.collection('usuarios').doc(uid).delete();
                console.log('‚úÖ Perfil do usu√°rio exclu√≠do');

                // NOTA: N√£o podemos deletar a conta do Firebase Auth pelo lado do cliente
                // Isso requer Firebase Admin SDK no servidor
                console.log('‚ö†Ô∏è IMPORTANTE: A conta no Firebase Auth n√£o foi removida.');
                console.log('   Para remover completamente, use o Console do Firebase ou Admin SDK');

                mostrarToast('‚úÖ Dados do usu√°rio exclu√≠dos do Firestore');

                // Recarregar lista
                carregarListaUsuarios();

            } catch (error) {
                console.error('‚ùå Erro ao excluir usu√°rio:', error);
                mostrarToast('‚ùå Erro ao excluir usu√°rio');
            }
        }

        // Mostrar formul√°rio de novo usu√°rio
        function mostrarFormularioNovoUsuario() {
            document.getElementById('novoUsuarioForm').style.display = 'block';
            // Limpar campos
            document.getElementById('novoNomeCompleto').value = '';
            document.getElementById('novoEmail').value = '';
            document.getElementById('novoSenha').value = '';
            document.getElementById('novoDataNascimento').value = '';
            document.getElementById('novoGenero').value = '';

            // Scroll at√© o formul√°rio
            document.getElementById('novoUsuarioForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Ocultar formul√°rio de novo usu√°rio
        function ocultarFormularioNovoUsuario() {
            document.getElementById('novoUsuarioForm').style.display = 'none';
        }

        // Criar novo usu√°rio (admin)
        async function criarNovoUsuario() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const nomeCompleto = document.getElementById('novoNomeCompleto').value.trim();
                const email = document.getElementById('novoEmail').value.trim();
                const senha = document.getElementById('novoSenha').value;
                const dataNascimento = document.getElementById('novoDataNascimento').value;
                const genero = document.getElementById('novoGenero').value;
                const role = document.getElementById('novoRole').value;

                // Valida√ß√£o
                if (!nomeCompleto || !email || !senha) {
                    mostrarToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios (Nome, Email e Senha)');
                    return;
                }

                if (senha.length < 6) {
                    mostrarToast('‚ö†Ô∏è A senha deve ter no m√≠nimo 6 caracteres');
                    return;
                }

                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    mostrarToast('‚ö†Ô∏è Email inv√°lido');
                    return;
                }

                console.log('üë§ Criando novo usu√°rio...');

                // IMPORTANTE: Como admin n√£o pode criar usu√°rios diretamente no Firebase Auth do lado do cliente,
                // vamos criar apenas o perfil no Firestore
                // O usu√°rio ter√° que se registrar normalmente na primeira vez

                // Gerar um ID √∫nico para o novo usu√°rio (tempor√°rio at√© ele se registrar)
                const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                const perfil = {
                    nomeCompleto,
                    email,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    role: role || 'user',
                    status: 'ativo',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    criadoPorAdmin: true,
                    senhaTemporaria: senha, // Apenas para refer√™ncia do admin
                    aguardandoPrimeiroLogin: true
                };

                await db.collection('usuarios').doc(tempUserId).set(perfil);

                console.log('‚úÖ Perfil criado com sucesso');

                alert(`‚úÖ Usu√°rio criado com sucesso!\n\nInforme ao usu√°rio:\n\nEmail: ${email}\nSenha: ${senha}\n\nO usu√°rio deve fazer o cadastro normal usando esses dados.`);

                // Limpar formul√°rio e ocultar
                ocultarFormularioNovoUsuario();

                // Recarregar lista
                carregarListaUsuarios();

            } catch (error) {
                console.error('‚ùå Erro ao criar usu√°rio:', error);
                mostrarToast('‚ùå Erro ao criar usu√°rio: ' + error.message);
            }
        }

        // Editar usu√°rio existente (admin)
        async function editarUsuarioAdmin(uid) {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                console.log('üìù Carregando dados do usu√°rio:', uid);

                // Carregar dados do usu√°rio
                const doc = await db.collection('usuarios').doc(uid).get();

                if (!doc.exists) {
                    mostrarToast('‚ùå Usu√°rio n√£o encontrado');
                    return;
                }

                const usuario = doc.data();

                // Preencher formul√°rio
                document.getElementById('editarUsuarioUid').value = uid;
                document.getElementById('editarNomeCompleto').value = usuario.nomeCompleto || '';
                document.getElementById('editarEmail').value = usuario.email || '';
                document.getElementById('editarDataNascimento').value = usuario.dataNascimento || '';
                document.getElementById('editarGenero').value = usuario.genero || '';
                document.getElementById('editarRole').value = usuario.role || 'user';
                document.getElementById('editarStatus').value = usuario.status || 'ativo';

                // Mostrar formul√°rio e esconder outros
                document.getElementById('editarUsuarioForm').style.display = 'block';
                document.getElementById('novoUsuarioForm').style.display = 'none';

                // Scroll at√© o formul√°rio
                document.getElementById('editarUsuarioForm').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rio:', error);
                mostrarToast('‚ùå Erro ao carregar usu√°rio');
            }
        }

        // Cancelar edi√ß√£o de usu√°rio (admin)
        function cancelarEdicaoUsuarioAdmin() {
            document.getElementById('editarUsuarioForm').style.display = 'none';
        }

        // Salvar edi√ß√£o de usu√°rio (admin)
        async function salvarEdicaoUsuarioAdmin() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const uid = document.getElementById('editarUsuarioUid').value;
                const nomeCompleto = document.getElementById('editarNomeCompleto').value.trim();
                const dataNascimento = document.getElementById('editarDataNascimento').value;
                const genero = document.getElementById('editarGenero').value;
                const role = document.getElementById('editarRole').value;
                const status = document.getElementById('editarStatus').value;

                // Valida√ß√£o
                if (!nomeCompleto) {
                    mostrarToast('‚ö†Ô∏è O nome completo √© obrigat√≥rio');
                    return;
                }

                console.log('üíæ Salvando altera√ß√µes do usu√°rio:', uid);

                // Atualizar no Firestore
                const perfilAtualizado = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    role: role || 'user',
                    status: status || 'ativo',
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoPorAdmin: currentUser.email
                };

                await db.collection('usuarios').doc(uid).update(perfilAtualizado);

                console.log('‚úÖ Usu√°rio atualizado com sucesso');
                mostrarToast('‚úÖ Usu√°rio atualizado com sucesso!');

                // Ocultar formul√°rio
                cancelarEdicaoUsuarioAdmin();

                // Recarregar lista e dashboard
                carregarListaUsuarios();
                carregarDashboardAdmin();

            } catch (error) {
                console.error('‚ùå Erro ao atualizar usu√°rio:', error);
                mostrarToast('‚ùå Erro ao atualizar usu√°rio: ' + error.message);
            }
        }

        // Salvar registro no Firestore (com valida√ß√£o de seguran√ßa)
        async function salvarRegistroFirebase(registro) {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de salvar sem autentica√ß√£o');
                return null;
            }

            try {
                // SEGURAN√áA: Salvar apenas na cole√ß√£o do usu√°rio autenticado
                const docRef = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').add({
                        ...registro,
                        criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                        // SEGURAN√áA: Adicionar UID do propriet√°rio
                        proprietario: currentUser.uid
                    });

                console.log('‚úÖ Registro salvo no Firebase com ID:', docRef.id);
                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                document.getElementById('syncStatus').style.color = 'var(--success)';

                return docRef.id; // Retornar ID do documento
            } catch (error) {
                console.error('Erro ao salvar:', error);
                document.getElementById('syncStatus').textContent = '‚ö† Erro na sincroniza√ß√£o';
                document.getElementById('syncStatus').style.color = 'var(--danger)';
                return null;
            }
        }

        // Carregar registros do Firestore (com valida√ß√£o de seguran√ßa)
        async function carregarDadosFirebase() {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de carregar dados sem autentica√ß√£o');
                registrosEmMemoria = [];
                return;
            }

            try {
                console.log('üì• Carregando dados do Firebase...');
                // SEGURAN√áA: Buscar apenas dados do usu√°rio autenticado
                const snapshot = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros')
                    .orderBy('criadoEm', 'desc')
                    .get();

                const registrosFirebase = snapshot.docs.map(doc => {
                    const data = doc.data();

                    // SEGURAN√áA: Validar propriet√°rio
                    if (data.proprietario && data.proprietario !== currentUser.uid) {
                        console.error('‚ùå SEGURAN√áA: Registro n√£o pertence ao usu√°rio atual');
                        return null;
                    }

                    return {
                        id: data.id, // ID local original
                        firebaseId: doc.id, // ID do documento do Firebase
                        dataHora: data.dataHora,
                        situacao: data.situacao,
                        pensamento: data.pensamento,
                        emocaoCentral: data.emocaoCentral,
                        emocaoIntermediaria: data.emocaoIntermediaria,
                        emocaoEspecifica: data.emocaoEspecifica,
                        intensidade: data.intensidade,
                        comportamento: data.comportamento
                    };
                });

                // SEGURAN√áA: Filtrar registros nulos (que n√£o passaram na valida√ß√£o)
                const registrosValidos = registrosFirebase.filter(r => r !== null);

                console.log(`‚úÖ ${registrosValidos.length} registros carregados do Firebase`);

                // Salvar na mem√≥ria
                registrosEmMemoria = registrosValidos;

                // Atualizar hist√≥rico se estiver na aba
                if (document.getElementById('historico').classList.contains('active')) {
                    carregarHistorico();
                }

                // Atualizar estat√≠sticas
                atualizarEstatisticas();

                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do Firebase:', error);
                document.getElementById('syncStatus').textContent = '‚ö† Erro ao sincronizar';
            }
        }

        // Excluir registro do Firestore (com valida√ß√£o de seguran√ßa)
        async function excluirRegistroFirebase(registroId) {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de excluir sem autentica√ß√£o');
                throw new Error('N√£o autorizado');
            }

            // SEGURAN√áA: Validar formato do ID
            if (!registroId || typeof registroId !== 'string') {
                console.error('‚ùå SEGURAN√áA: ID de registro inv√°lido');
                throw new Error('ID inv√°lido');
            }

            try {
                // SEGURAN√áA: Excluir apenas da cole√ß√£o do usu√°rio autenticado
                await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').doc(registroId).delete();

                document.getElementById('syncStatus').textContent = '‚úì Exclu√≠do';
            } catch (error) {
                console.error('Erro ao excluir:', error);
                throw error;
            }
        }

        // Permitir Enter para fazer login
        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleEmailAuth();
                });
            }
        });
    </script>

    </div>
</body>
</html>