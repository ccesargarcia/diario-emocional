<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Di√°rio Emocional - TCC</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
                                                                        /* Cores personalizadas para √≠cones do menu inferior */
                                                                        .bottom-nav-btn .material-icons {
                                                                            color: var(--primary);
                                                                            transition: color 0.2s;
                                                                        }
                                                                        .bottom-nav-btn.active .material-icons {
                                                                            color: var(--secondary);
                                                                        }
                                                                        #navNovo .material-icons { color: #48bb78; }
                                                                        #navHistorico .material-icons { color: #764ba2; }
                                                                        #navAnsiedade .material-icons { color: #ed8936; }
                                                                        #navExportar .material-icons { color: #ecc94b; }
                                                                        #navPerfil .material-icons { color: #667eea; }
                                                                        #navAdmin .material-icons { color: #f56565; }
                                                                        #navConfig .material-icons { color: #5568d3; }
                                                                /* Material Icons para bot√µes */
                                                                .material-icons {
                                                                    font-size: 24px;
                                                                    vertical-align: middle;
                                                                }
                                                                /* Feedback visual para mensagens */
                                                                .toast {
                                                                    position: fixed;
                                                                    bottom: 100px;
                                                                    left: 50%;
                                                                    transform: translateX(-50%) translateY(100px);
                                                                    background: var(--primary);
                                                                    color: white;
                                                                    padding: 15px 25px;
                                                                    border-radius: 25px;
                                                                    box-shadow: 0 4px 15px var(--shadow);
                                                                    z-index: 1000;
                                                                    opacity: 0;
                                                                    visibility: hidden;
                                                                    transition: all 0.3s ease-in-out;
                                                                    font-size: 16px;
                                                                    display: flex;
                                                                    align-items: center;
                                                                    gap: 10px;
                                                                }
                                                                .toast.show {
                                                                    transform: translateX(-50%) translateY(0);
                                                                    opacity: 1;
                                                                    visibility: visible;
                                                                }
                                                                /* Tipografia para t√≠tulos */
                                                                h1, h2, h3 {
                                                                    font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
                                                                    font-weight: 800;
                                                                    letter-spacing: 1px;
                                                                    color: var(--primary);
                                                                    margin-bottom: 12px;
                                                                    text-shadow: 0 2px 8px rgba(102,126,234,0.08);
                                                                }
                                                                /* Responsividade aprimorada */
                                                                @media (max-width: 500px) {
                                                                    .tab, .btn, .form-group {
                                                                        font-size: 15px !important;
                                                                        padding: 14px 8px !important;
                                                                    }
                                                                    h1, h2, h3 {
                                                                        font-size: 20px !important;
                                                                    }
                                                                }
                                                        /* Bottom navigation para mobile */
                                                        @media (max-width: 700px) {
                                                            .tabs, .hamburger-btn, .side-menu { display: none !important; }
                                                            .bottom-nav {
                                                                display: flex;
                                                                position: fixed;
                                                                left: 0; right: 0; bottom: 0;
                                                                height: 64px;
                                                                background: var(--bg-card);
                                                                box-shadow: 0 -2px 10px var(--shadow-color);
                                                                z-index: 1200;
                                                                border-top-left-radius: 16px;
                                                                border-top-right-radius: 16px;
                                                                justify-content: space-around;
                                                                align-items: center;
                                                                padding: 0 2vw;
                                                            }
                                                            .bottom-nav-btn {
                                                                flex: 1;
                                                                display: flex;
                                                                flex-direction: column;
                                                                align-items: center;
                                                                justify-content: center;
                                                                background: none;
                                                                border: none;
                                                                color: var(--text-secondary);
                                                                font-size: 11px;
                                                                font-weight: 600;
                                                                padding: 0;
                                                                height: 100%;
                                                                cursor: pointer;
                                                                transition: color 0.2s;
                                                                min-width: 0;
                                                            }
                                                            .bottom-nav-btn span:last-child {
                                                                font-size: 10px;
                                                                white-space: nowrap;
                                                                overflow: hidden;
                                                                text-overflow: ellipsis;
                                                                max-width: 100%;
                                                            }
                                                            .bottom-nav-btn.active {
                                                                color: var(--primary);
                                                            }
                                                            .bottom-nav-btn .icon {
                                                                font-size: 22px;
                                                                margin-bottom: 2px;
                                                            }
                                                        }
                                                        @media (min-width: 701px) {
                                                            .bottom-nav { display: none !important; }
                                                        }
                                                /* Menu hamb√∫rguer lateral para mobile */
                                                @media (max-width: 700px) {
                                                    .tabs {
                                                        display: none !important;
                                                    }
                                                    .hamburger-btn {
                                                        display: block;
                                                        position: fixed;
                                                        top: 18px;
                                                        left: 18px;
                                                        z-index: 1200;
                                                        background: var(--primary);
                                                        color: #fff;
                                                        border: none;
                                                        border-radius: 8px;
                                                        width: 44px;
                                                        height: 44px;
                                                        font-size: 28px;
                                                        box-shadow: 0 2px 8px var(--shadow-color);
                                                        cursor: pointer;
                                                    }
                                                    .side-menu {
                                                        display: flex;
                                                        flex-direction: column;
                                                        position: fixed;
                                                        top: 0;
                                                        left: 0;
                                                        width: 220px;
                                                        height: 100vh;
                                                        background: var(--bg-card);
                                                        box-shadow: 2px 0 12px var(--shadow-color);
                                                        z-index: 1300;
                                                        transform: translateX(-100%);
                                                        transition: transform 0.3s;
                                                        padding-top: 60px;
                                                    }
                                                    .side-menu.open {
                                                        transform: translateX(0);
                                                    }
                                                    .side-menu .tab {
                                                        display: block;
                                                        width: 100%;
                                                        border: none;
                                                        border-radius: 0;
                                                        text-align: left;
                                                        padding: 18px 24px;
                                                        font-size: 18px;
                                                        color: var(--text-secondary);
                                                        background: none;
                                                        border-bottom: 1px solid var(--border-color);
                                                        margin: 0;
                                                        transition: background 0.2s, color 0.2s;
                                                    }
                                                    .side-menu .tab.active {
                                                        color: var(--primary);
                                                        background: #f0f4ff;
                                                    }
                                                    .side-menu .tab:last-child {
                                                        border-bottom: none;
                                                    }
                                                    .side-menu .close-btn {
                                                        position: absolute;
                                                        top: 10px;
                                                        right: 10px;
                                                        background: none;
                                                        border: none;
                                                        font-size: 28px;
                                                        color: var(--primary);
                                                        cursor: pointer;
                                                    }
                                                }
                                                @media (min-width: 701px) {
                                                    .hamburger-btn, .side-menu { display: none !important; }
                                                }
                                        /* Responsividade para o menu de abas (tabs) no mobile */
                                        @media (max-width: 700px) {
                                            .tabs {
                                                display: flex;
                                                overflow-x: auto;
                                                -webkit-overflow-scrolling: touch;
                                                background: var(--bg-card);
                                                border-radius: 0 0 15px 15px;
                                                box-shadow: 0 2px 5px var(--shadow-color);
                                                scrollbar-width: thin;
                                                scrollbar-color: var(--primary) var(--bg-card);
                                            }
                                            .tab {
                                                min-width: 120px;
                                                flex: 0 0 auto;
                                                font-size: 16px;
                                                padding: 12px 8px;
                                                white-space: nowrap;
                                            }
                                            .tabs::-webkit-scrollbar {
                                                height: 4px;
                                            }
                                            .tabs::-webkit-scrollbar-thumb {
                                                background: var(--primary);
                                                border-radius: 2px;
                                            }
                                            .tabs::-webkit-scrollbar-track {
                                                background: var(--bg-card);
                                            }
                                        }
                                /* Responsividade m√°xima para aba de configura√ß√µes/admin no mobile */
                                @media (max-width: 700px) {
                                    #config, #config .export-section, #configForm {
                                        width: 100% !important;
                                        min-width: 0 !important;
                                        max-width: 100% !important;
                                        box-sizing: border-box;
                                        padding: 0 2vw !important;
                                        margin: 0 !important;
                                    }
                                    #configForm label,
                                    #configForm input,
                                    #configForm button,
                                    #configForm small {
                                        width: 100% !important;
                                        display: block !important;
                                        margin: 0 0 12px 0 !important;
                                        box-sizing: border-box;
                                        font-size: 18px !important;
                                    }
                                    #configForm input {
                                        font-size: 18px !important;
                                        padding: 12px !important;
                                    }
                                    #configForm button {
                                        font-size: 17px !important;
                                        padding: 14px 0 !important;
                                    }
                                    #configForm {
                                        flex-direction: column !important;
                                        align-items: stretch !important;
                                    }
                                }
                        /* Espa√ßo extra para n√£o esconder conte√∫do atr√°s da barra de abas em telas pequenas */
                        @media (max-width: 700px) {
                            body {
                                padding-bottom: 90px !important;
                            }
                        }
                /* Responsividade para aba de configura√ß√µes/admin */
                @media (max-width: 600px) {
                    #config .export-section,
                    #configForm {
                        width: 100% !important;
                        min-width: 0 !important;
                        max-width: 100% !important;
                        box-sizing: border-box;
                        padding: 0 5vw;
                    }
                    #configForm label,
                    #configForm input,
                    #configForm button,
                    #configForm small {
                        width: 100% !important;
                        display: block;
                        margin: 0 0 10px 0;
                        box-sizing: border-box;
                    }
                    #configForm input {
                        font-size: 18px;
                    }
                    #configForm button {
                        font-size: 16px;
                        padding: 12px 0;
                    }
                }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --bg-light: #f8f9fa;
            --text-dark: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #48bb78;
            --danger: #f56565;

            /* Vari√°veis para tema claro (padr√£o) */
            --bg-body: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode */
        body.dark-mode {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #8b5cf6;
            --bg-light: #1e293b;
            --text-dark: #f1f5f9;
            --text-light: #cbd5e1;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);

            --bg-body: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            padding-bottom: 80px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-card);
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s ease;
        }

        .header h1 {
            font-size: 24px;
            color: var(--primary);
            text-align: center;
            margin-bottom: 5px;
        }

        .header p {
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
        }

        .tabs {
            display: flex;
            background: var(--bg-card);
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            margin: 0 6px;
            text-align: center;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-bottom 0.2s;
            border-bottom: 3px solid transparent;
            border-radius: 10px 10px 0 0;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            padding: 28px 18px;
            animation: fadeInTab 0.4s;
        }

        .tab-content.active {
            display: block;
            animation: fadeInTab 0.4s;
        }
        @keyframes fadeInTab {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 28px 22px;
            margin-bottom: 22px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .form-group label .emoji {
            font-size: 18px;
            margin-right: 5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .intensity-container {
            position: relative;
        }

        .intensity-slider {
            width: 100%;
            height: 10px;
            border-radius: 6px;
            background: linear-gradient(to right, #48bb78 0%, #ecc94b 50%, #f56565 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            transition: background 0.3s;
        }

        .intensity-slider::-webkit-slider-track {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
        }

        .intensity-slider::-moz-range-track {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--thumb-color, white);
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow);
            border: 3px solid var(--primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .intensity-slider:active::-webkit-slider-thumb {
            border-color: #764ba2;
            box-shadow: 0 6px 18px var(--primary);
        }

        .intensity-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--thumb-color, white);
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow);
            border: 3px solid var(--primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .intensity-slider:active::-moz-range-thumb {
            border-color: #764ba2;
            box-shadow: 0 6px 18px var(--primary);
        }

        .intensity-value {
            text-align: center;
            margin-top: 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .emotions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .emotion-btn {
            padding: 15px 10px;
            border: 3px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .emotion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .emotion-btn .emoji {
            display: block;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .emocao-nome {
            font-weight: 600;
            font-size: 14px;
            display: block;
            margin-bottom: 3px;
        }

        .emocao-explicacao {
            font-size: 10px;
            opacity: 0.85;
            line-height: 1.3;
            font-weight: 400;
            display: block;
            color: var(--text-dark);
        }

        .emotion-btn.selected {
            border-color: var(--primary) !important;
            border-width: 4px !important;
            background: linear-gradient(135deg, #667eea15, #764ba220) !important;
            transform: scale(1.08);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3), 0 0 0 3px rgba(102, 126, 234, 0.1);
            font-weight: 600;
        }

        .emotion-btn.selected::before {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .emotion-btn.selected .emoji {
            transform: scale(1.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 20px 0;
            margin: 0 6px;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px var(--shadow);
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn:hover {
            filter: brightness(1.08);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .btn-secondary:active {
            background: #e2e8f0;
            transform: scale(0.98);
        }

        .entries-list {
            margin-top: 10px;
        }

        .entry-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .entry-date {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .entry-field {
            margin-bottom: 15px;
        }

        .entry-field strong {
            display: block;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .entry-field p {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .emotion-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-light);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state .emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: var(--text-light);
            font-size: 16px;
        }

        .export-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
            text-align: center;
            transition: background 0.3s ease;
        }

        .export-section h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Perfil */
        .profile-info {
            text-align: left;
            margin-top: 20px;
        }

        .profile-field {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field strong {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .profile-field p {
            color: var(--text-primary);
            font-size: 16px;
            margin: 0;
        }

        /* Lista de Usu√°rios (Admin) */
        .user-item {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .user-item-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .user-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete-user {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete-user:hover {
            opacity: 0.8;
        }


        .footer-info {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            transition: background 0.3s ease;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        /* Cabe√ßalho de Boas-vindas */
        .welcome-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 25px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .greeting h2 {
            font-size: 28px;
            margin: 0;
            font-weight: 700;
        }

        .greeting p {
            font-size: 14px;
            margin: 5px 0 0 0;
            opacity: 0.95;
        }

        .welcome-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 380px) {
            .emotions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Responsividade para aba de Escala de Ansiedade */
        @media (max-width: 700px) {
            #ansiedade table {
                font-size: 13px;
            }
            
            #ansiedade td {
                padding: 6px 4px !important;
            }
            
            #ansiedade th {
                padding: 6px 4px !important;
                font-size: 12px;
            }
            
            #ansiedade .ans-level {
                width: 100% !important;
                padding: 4px !important;
                font-size: 14px;
            }
            
            #ansiedade .ans-notes {
                width: 100% !important;
                padding: 4px !important;
                min-height: 40px !important;
                font-size: 13px;
            }
            
            #ansiedade .btn-group {
                flex-direction: column;
                gap: 8px;
            }
            
            #ansiedade .btn-group button {
                width: 100%;
            }
        }
        
        @media (max-width: 500px) {
            #ansiedade h3 {
                font-size: 16px;
            }
            
            #ansiedade h4 {
                font-size: 14px;
            }
            
            #ansiedade table {
                font-size: 12px;
            }
            
            #ansiedade .ans-level {
                font-size: 13px;
            }
            
            #ansiedade .ans-notes {
                font-size: 12px;
                min-height: 35px !important;
            }
        }

        /* Tela de Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 10000;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
            transition: background 0.3s ease;
        }

        .login-box h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-box p {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .signup-fields {
            margin-bottom: 20px;
        }

        .signup-fields input,
        .signup-fields select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .signup-fields input:focus,
        .signup-fields select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .terms-checkbox {
            margin: 15px 0;
            text-align: left;
        }

        .terms-checkbox label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
            color: var(--text-light);
            cursor: pointer;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .terms-checkbox a {
            color: var(--primary);
            text-decoration: none;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 10px;
        }

        .btn-login:hover {
            background: var(--primary-dark);
        }

        .btn-google {
            width: 100%;
            padding: 15px;
            background: white;
            color: var(--text-dark);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .divider {
            margin: 20px 0;
            color: var(--text-light);
            font-size: 14px;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .toggle-auth {
            margin-top: 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .toggle-auth a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .user-info {
            background: white;
            padding: 12px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .user-info .user-details {
            flex: 1;
        }

        .user-info .user-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .user-info .user-email {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 10001;
            color: white;
            font-size: 18px;
        }

        .loading.hidden,
        .hidden {
            display: none !important;
        }

        .sync-status {
            font-size: 10px;
            color: var(--success);
            margin-top: 2px;
        }

        .app-wrapper {
            display: none;
        }

        .app-wrapper.active {
            display: block;
        }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
            <!-- Bottom navigation para mobile -->
            <nav class="bottom-nav" id="bottomNav" style="display:none;">
                <button class="bottom-nav-btn" id="navNovo" onclick="showTab('novo', event)"><span class="material-icons">add_circle</span><span>Novo</span></button>
                <button class="bottom-nav-btn" id="navHistorico" onclick="showTab('historico', event)"><span class="material-icons">history</span><span>Hist√≥rico</span></button>
                <button class="bottom-nav-btn" id="navAnsiedade" onclick="showTab('ansiedade', event)"><span class="material-icons">psychology</span><span>Ansiedade</span></button>
                <button class="bottom-nav-btn" id="navExportar" onclick="showTab('exportar', event)"><span class="material-icons">file_upload</span><span>Exportar</span></button>
                <button class="bottom-nav-btn" id="navPerfil" onclick="showTab('perfil', event)"><span class="material-icons">person</span><span>Perfil</span></button>
                <button class="bottom-nav-btn" id="navAdmin" onclick="showTab('admin', event)" style="display:none;visibility:hidden;"><span class="material-icons">admin_panel_settings</span><span>Admin</span></button>
                <button class="bottom-nav-btn" id="navConfig" onclick="showTab('config', event)" style="display:none;visibility:hidden;"><span class="material-icons">settings</span><span>Config</span></button>
            </nav>
        <!-- Bot√£o hamb√∫rguer para mobile -->
        <button class="hamburger-btn" id="hamburgerBtn" aria-label="Abrir menu" style="display:none;">‚ò∞</button>
        <!-- Menu lateral -->
        <nav class="side-menu" id="sideMenu">
            <button class="close-btn" id="closeMenuBtn" aria-label="Fechar menu">√ó</button>
            <button class="tab" onclick="showTab('novo', event)">‚ûï Novo</button>
            <button class="tab" onclick="showTab('historico', event)">üìñ Hist√≥rico</button>
            <button class="tab" onclick="showTab('exportar', event)">üì§ Exportar</button>
            <button class="tab" onclick="showTab('perfil', event)">üë§ Perfil</button>
            <button class="tab" onclick="showTab('ansiedade', event)">üìù Escala Ansiedade</button>
            <button class="tab" id="adminTabSide" onclick="showTab('admin', event)" style="display: none;">üîê Admin</button>
            <button class="tab" id="configTabSide" onclick="showTab('config', event)" style="display: none;">‚öôÔ∏è Configura√ß√µes</button>
        </nav>
    <!-- Tela de Loading -->
    <div id="loadingScreen" class="loading">
        <div>‚è≥ Carregando...</div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container hidden">
        <div class="login-box">
            <h1>üìî Di√°rio Emocional</h1>
            <p>Fa√ßa login para acessar seus registros</p>

            <div id="authError" class="error-message hidden"></div>

            <!-- Campos extras para cadastro -->
            <div id="signupFields" class="signup-fields hidden">
                <input type="text" id="nomeCompleto" placeholder="Nome completo *" required>
                <input type="date" id="dataNascimento" placeholder="Data de nascimento">
                <select id="genero">
                    <option value="">G√™nero (opcional)</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-informar">Prefiro n√£o informar</option>
                </select>
            </div>

            <div class="login-form">
                <input type="email" id="emailInput" placeholder="Email" autocomplete="email">
                <input type="password" id="passwordInput" placeholder="Senha (m√≠nimo 6 caracteres)" autocomplete="current-password">

                <!-- Checkbox de termos (s√≥ aparece no cadastro) -->
                <div id="termsCheckbox" class="terms-checkbox hidden">
                    <label>
                        <input type="checkbox" id="acceptTerms">
                        <span>Aceito os <a href="#" onclick="mostrarTermos(); return false;">termos de uso</a> e <a href="#" onclick="mostrarPrivacidade(); return false;">pol√≠tica de privacidade</a></span>
                    </label>
                </div>

                <button class="btn-login" onclick="handleEmailAuth()">
                    <span id="authButtonText">Entrar</span>
                </button>
            </div>

            <div class="divider">ou</div>

            <button class="btn-google" onclick="handleGoogleAuth()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar com Google
            </button>

            <div class="toggle-auth">
                <span id="toggleText">N√£o tem conta?</span>
                <a onclick="toggleAuthMode()"><span id="toggleLink">Criar conta</span></a>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="appScreen" class="app-wrapper">
        <!-- Cabe√ßalho com sauda√ß√£o personalizada -->
        <div class="welcome-header">
            <div class="greeting">
                <h2 id="greetingMessage">Ol√°!</h2>
                <p id="currentDateTime"></p>
            </div>
            <div class="welcome-actions">
                <button class="btn-theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <span id="themeIcon">üåô</span>
                </button>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>

        <div class="user-info">
            <div class="user-details">
                <div class="user-name" id="userName">Usu√°rio</div>
                <div class="user-email" id="userEmail">email@exemplo.com</div>
                <div class="user-role" id="userRole" style="font-size:13px;color:var(--text-secondary);">Perfil: ‚Äî</div>
                <div class="sync-status" id="syncStatus">‚úì Sincronizado</div>
            </div>
        </div>


    <div class="header">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
            <div>
                <h1>üìî Di√°rio Emocional</h1>
                <p>Registro para Terapia Cognitivo-Comportamental</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <!-- Bot√µes de passphrase removidos -->
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('novo', event)">‚ûï Novo</button>
        <button class="tab" onclick="showTab('historico', event)">üìñ Hist√≥rico</button>
        <button class="tab" onclick="showTab('exportar', event)">üì§ Exportar</button>
        <button class="tab" onclick="showTab('perfil', event)">üë§ Perfil</button>
        <button class="tab" onclick="showTab('ansiedade', event)">üìù Escala Ansiedade</button>
        <button class="tab" id="adminTab" onclick="showTab('admin', event)" style="display: none;">üîê Admin</button>
        <button class="tab" id="configTab" onclick="showTab('config', event)" style="display: none;">‚öôÔ∏è Configura√ß√µes</button>
    </div>

    <!-- TAB: NOVO REGISTRO -->
    <div id="novo" class="tab-content active">
        <div class="form-group">
            <label><span class="emoji">üìÖ</span> Data e Hora</label>
            <input type="datetime-local" id="dataHora">
        </div>

        <div class="form-group">
            <label><span class="emoji">üìç</span> Situa√ß√£o</label>
            <textarea id="situacao" placeholder="O que aconteceu? Onde voc√™ estava? Com quem?"></textarea>
        </div>

        <div class="form-group">
            <label><span class="emoji">üí≠</span> Pensamento Autom√°tico</label>
            <textarea id="pensamento" placeholder="O que passou pela sua cabe√ßa naquele momento?"></textarea>
        </div>

        <div class="form-group">
            <label><span class="emoji">‚ù§Ô∏è</span> Emo√ß√£o Principal</label>
            <div class="emotions-grid" id="emotionsGrid"></div>
        </div>

        <div id="intermediariasDiv"></div>
        <div id="especificasDiv"></div>

        <div class="form-group">
            <label><span class="emoji">üéöÔ∏è</span> Intensidade da Emo√ß√£o (0-10)</label>
            <div class="intensity-container">
                <input type="range" min="0" max="10" value="5" class="intensity-slider" id="intensidade">
                <div class="intensity-value" id="intensidadeValor">5</div>
            </div>
        </div>

        <div class="form-group">
            <label><span class="emoji">üé≠</span> Comportamento</label>
            <textarea id="comportamento" placeholder="Como voc√™ reagiu? O que fez depois?"></textarea>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="limparFormulario()">üîÑ Limpar</button>
            <button class="btn btn-primary" onclick="salvarRegistro()">üíæ Salvar</button>
        </div>
    </div>

    <!-- TAB: ESCALA ANSIEDADE -->
    <div id="ansiedade" class="tab-content">
        <div class="export-section">
            <h3>üìù Escala: Classificando sua Ansiedade Di√°ria</h3>
            <p style="color: var(--text-light); margin-bottom: 12px;">
                Use a escala (0‚Äì100) para registrar o n√≠vel m√©dio de ansiedade de cada dia da semana e descreva gatilhos ou observa√ß√µes.
            </p>

            <div class="form-group" style="margin-bottom: 16px;">
                <label><span class="emoji">üìÖ</span> Semana de Refer√™ncia (in√≠cio da semana)</label>
                <input type="date" id="dataReferenciaEscala" style="width: 100%; max-width: 300px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary);">
                <button class="btn btn-secondary" onclick="carregarHistoricoEscalas()" style="margin-left: 8px; padding: 8px 16px;">üìã Hist√≥rico</button>
            </div>

            <div id="historicoEscalas" style="display: none; margin-bottom: 16px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0;">üìã Hist√≥rico de Escalas</h4>
                    <button class="btn btn-secondary" onclick="fecharHistoricoEscalas()" style="padding: 4px 12px; font-size: 12px;">‚úï Fechar</button>
                </div>
                <div id="listaHistoricoEscalas" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: var(--text-light); text-align: center;">Carregando...</p>
                </div>
            </div>

            <div style="overflow:auto; -webkit-overflow-scrolling: touch;">
                <table style="width:100%; border-collapse: collapse; min-width: 320px;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Dia</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border); width:100px; white-space: nowrap;">N√≠vel (0-100)</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Gatilhos / Observa√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="ansiedadeTableBody">
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Domingo</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="Domingo" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="Domingo" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Segunda-feira</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="Segunda-feira" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="Segunda-feira" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Ter√ßa-feira</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="Ter√ßa-feira" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="Ter√ßa-feira" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Quarta-feira</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="Quarta-feira" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="Quarta-feira" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Quinta-feira</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="Quinta-feira" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="Quinta-feira" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">Sexta-feira</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="Sexta-feira" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="Sexta-feira" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid var(--border); white-space: nowrap;">S√°bado</td>
                            <td style="padding:8px; border-bottom:1px solid var(--border); width:100px;"><input type="number" min="0" max="100" class="ans-level" data-dia="S√°bado" style="width:100%; padding:6px;" placeholder="0-100" /></td>
                            <td style="padding:8px; border-bottom:1px solid var(--border);"><textarea class="ans-notes" data-dia="S√°bado" style="width:100%; padding:6px; min-height:48px;" placeholder="Descreva gatilhos ou observa√ß√µes..."></textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="btn-group" style="margin-top:12px;">
                <button class="btn btn-secondary" onclick="carregarEscala()">üîÑ Carregar</button>
                <button class="btn btn-primary" onclick="salvarEscala()">üíæ Salvar</button>
            </div>
            <h4 style="margin-top:24px; margin-bottom:12px;">üìä Exportar Escala</h4>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportarEscalaPDF()">üìÑ PDF</button>
                <button class="btn btn-primary" onclick="exportarEscalaJSON()">JSON</button>
            </div>
            <div class="btn-group" style="margin-top:10px;">
                <button class="btn btn-primary" onclick="exportarEscalaCSV()">CSV</button>
                <button class="btn btn-primary" onclick="exportarEscalaTexto()">Texto</button>
            </div>
        </div>
        <div style="margin-top:16px; color: var(--text-light); font-size:13px;">Os dados s√£o salvos localmente no seu navegador.</div>

        <script>
            function _escalaKey() {
                try { if (window.currentUser && currentUser.uid) return 'escalaAnsiedade_'+currentUser.uid; } catch(e) {}
                return 'escalaAnsiedade_public';
            }

            function getSegundaFeiraAtual() {
                const hoje = new Date();
                const diaSemana = hoje.getDay(); // 0 = Domingo, 1 = Segunda, ..., 6 = S√°bado
                const diff = diaSemana === 0 ? -6 : 1 - diaSemana; // Se domingo, volta 6 dias; sen√£o, volta at√© segunda
                const segundaFeira = new Date(hoje);
                segundaFeira.setDate(hoje.getDate() + diff);
                return segundaFeira.toISOString().split('T')[0];
            }

            function inicializarDataReferencia() {
                const campo = document.getElementById('dataReferenciaEscala');
                if (campo && !campo.value) {
                    campo.value = getSegundaFeiraAtual();
                }
            }

            function salvarEscala() {
                const rows = document.querySelectorAll('#ansiedadeTableBody tr');
                const dataReferencia = document.getElementById('dataReferenciaEscala').value || getSegundaFeiraAtual();
                const dados = Array.from(rows).map(r => {
                    const dia = r.querySelector('.ans-level').dataset.dia;
                    const nivel = parseInt(r.querySelector('.ans-level').value || '0');
                    const notas = r.querySelector('.ans-notes').value || '';
                    return { dia, nivel, notas };
                });
                const payload = { savedAt: new Date().toISOString(), dataReferencia, dados };

                console.log('üîç salvarEscala - Iniciando...');
                console.log('Data de Refer√™ncia:', dataReferencia);
                console.log('currentUser:', currentUser);
                console.log('db dispon√≠vel:', typeof db !== 'undefined');
                console.log('Payload:', payload);

                // Se usu√°rio logado, salvar no Firestore usando data como ID; caso contr√°rio, salvar localmente
                if (typeof currentUser !== 'undefined' && currentUser && currentUser.uid && typeof db !== 'undefined') {
                    const uid = currentUser.uid;
                    const docId = dataReferencia.replace(/-/g, ''); // Remove h√≠fens: 2026-02-03 -> 20260203
                    console.log('üíæ Salvando no Firebase para usu√°rio:', uid, 'documento:', docId);
                    db.collection('usuarios').doc(uid).collection('escalas').doc(docId)
                        .set({ ...payload, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true })
                        .then(() => { 
                            // Tamb√©m salvar no localStorage como backup
                            const key = _escalaKey() + '_' + dataReferencia;
                            localStorage.setItem(key, JSON.stringify(payload));
                            console.log('‚úÖ Salvo no Firebase com sucesso!');
                            mostrarToast('‚úÖ Escala da semana ' + new Date(dataReferencia + 'T00:00:00').toLocaleDateString('pt-BR') + ' salva!'); 
                        })
                        .catch(err => { 
                            console.error('‚ùå Erro ao salvar escala no Firebase:', err); 
                            mostrarToast('‚ùå Erro ao salvar no Firebase ‚Äî salvando localmente'); 
                            localStorage.setItem(_escalaKey(), JSON.stringify(payload)); 
                        });
                } else {
                    console.log('üíæ Salvando apenas no localStorage (usu√°rio n√£o logado ou Firebase indispon√≠vel)');
                    localStorage.setItem(_escalaKey(), JSON.stringify(payload));
                    try { mostrarToast('‚úÖ Escala salva localmente'); } catch(e) { alert('Escala salva'); }
                }
            }

            function carregarEscala(dataEspecifica) {
                const dataReferencia = dataEspecifica || document.getElementById('dataReferenciaEscala').value || getSegundaFeiraAtual();
                console.log('üîç carregarEscala - Carregando dados da semana:', dataReferencia);
                console.log('currentUser:', currentUser);
                console.log('db dispon√≠vel:', typeof db !== 'undefined');
                
                // Se usu√°rio logado, tentar carregar do Firebase primeiro
                if (typeof currentUser !== 'undefined' && currentUser && currentUser.uid && typeof db !== 'undefined') {
                    const uid = currentUser.uid;
                    const docId = dataReferencia.replace(/-/g, '');
                    console.log('üîÑ Carregando do Firebase documento:', docId);
                    db.collection('usuarios').doc(uid).collection('escalas').doc(docId)
                        .get()
                        .then(doc => {
                            if (doc.exists) {
                                console.log('‚úÖ Dados encontrados no Firebase:', doc.data());
                                const obj = doc.data();
                                
                                // Carregar data de refer√™ncia
                                if (obj.dataReferencia) {
                                    document.getElementById('dataReferenciaEscala').value = obj.dataReferencia;
                                }
                                
                                (obj.dados || []).forEach(item => {
                                    const el = document.querySelector(`.ans-level[data-dia="${item.dia}"]`);
                                    const note = document.querySelector(`.ans-notes[data-dia="${item.dia}"]`);
                                    if (el) el.value = item.nivel;
                                    if (note) note.value = item.notas;
                                });
                                // Tamb√©m salvar no localStorage como cache
                                const key = _escalaKey() + '_' + dataReferencia;
                                localStorage.setItem(key, JSON.stringify(obj));
                                try { mostrarToast('‚úÖ Escala de ' + new Date(dataReferencia + 'T00:00:00').toLocaleDateString('pt-BR') + ' carregada'); } catch(e) {}
                            } else {
                                console.log('‚ÑπÔ∏è Nenhum dado no Firebase para esta data, tentando localStorage');
                                // N√£o existe no Firebase, tentar localStorage
                                carregarEscalaLocal(dataReferencia);
                            }
                        })
                        .catch(err => {
                            console.error('‚ùå Erro ao carregar do Firebase:', err);
                            mostrarToast('‚ö†Ô∏è Erro no Firebase ‚Äî tentando carregar localmente');
                            carregarEscalaLocal(dataReferencia);
                        });
                } else {
                    console.log('üíæ Carregando do localStorage (usu√°rio n√£o logado)');
                    // Usu√°rio n√£o logado, usar localStorage
                    carregarEscalaLocal(dataReferencia);
                }
            }
            
            function carregarEscalaLocal(dataReferencia) {
                const data = dataReferencia || document.getElementById('dataReferenciaEscala').value;
                const key = data ? _escalaKey() + '_' + data : _escalaKey();
                const raw = localStorage.getItem(key);
                if (!raw) { try { mostrarToast('‚ÑπÔ∏è Nenhum dado salvo para esta data'); } catch(e) {} ; return; }
                try {
                    const obj = JSON.parse(raw);
                    
                    // Carregar data de refer√™ncia
                    if (obj.dataReferencia) {
                        document.getElementById('dataReferenciaEscala').value = obj.dataReferencia;
                    }
                    
                    (obj.dados || []).forEach(item => {
                        const el = document.querySelector(`.ans-level[data-dia="${item.dia}"]`);
                        const note = document.querySelector(`.ans-notes[data-dia="${item.dia}"]`);
                        if (el) el.value = item.nivel;
                        if (note) note.value = item.notas;
                    });
                    try { mostrarToast('‚úÖ Escala carregada localmente'); } catch(e) {}
                } catch (e) { console.error(e); }
            }

            async function carregarHistoricoEscalas() {
                document.getElementById('historicoEscalas').style.display = 'block';
                const lista = document.getElementById('listaHistoricoEscalas');
                lista.innerHTML = '<p style="text-align:center;color:#666;">Carregando hist√≥rico...</p>';

                try {
                    const currentUser = firebase.auth().currentUser;
                    if (!currentUser) {
                        lista.innerHTML = '<p style="text-align:center;color:#e53e3e;">Usu√°rio n√£o autenticado</p>';
                        return;
                    }

                    const db = firebase.firestore();
                    const escalasRef = db.collection('usuarios').doc(currentUser.uid).collection('escalas');
                    const snapshot = await escalasRef.get();

                    if (snapshot.empty) {
                        lista.innerHTML = '<p style="text-align:center;color:#666;">Nenhuma escala salva ainda</p>';
                        return;
                    }

                    const escalas = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // doc.id est√° no formato YYYYMMDD, converter para YYYY-MM-DD
                        const docId = doc.id;
                        const dataRef = docId.length === 8 
                            ? `${docId.substr(0,4)}-${docId.substr(4,2)}-${docId.substr(6,2)}`
                            : docId;
                        
                        escalas.push({
                            dataReferencia: dataRef,
                            dados: data.dados || [],
                            timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                        });
                    });

                    // Ordenar por data de refer√™ncia (mais recente primeiro)
                    escalas.sort((a, b) => new Date(b.dataReferencia) - new Date(a.dataReferencia));

                    // Criar HTML da lista
                    let html = '<ul style="list-style:none;padding:0;margin:0;">';
                    escalas.forEach(escala => {
                        const dataFormatada = new Date(escala.dataReferencia + 'T00:00:00').toLocaleDateString('pt-BR');
                        const timestampFormatado = escala.timestamp.toLocaleString('pt-BR');
                        const numRegistros = escala.dados.length;
                        
                        html += `
                            <li style="border-bottom:1px solid #e2e8f0;padding:10px;cursor:pointer;transition:background 0.2s;"
                                onmouseover="this.style.background='#f7fafc'" 
                                onmouseout="this.style.background='white'"
                                onclick="carregarEscalaDoHistorico('${escala.dataReferencia}')">
                                <div style="font-weight:600;color:#2d3748;margin-bottom:4px;">
                                    üìÖ Semana de ${dataFormatada}
                                </div>
                                <div style="font-size:12px;color:#718096;">
                                    ${numRegistros} registro${numRegistros !== 1 ? 's' : ''} ‚Ä¢ Salvo em ${timestampFormatado}
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    
                    lista.innerHTML = html;

                } catch (error) {
                    console.error('Erro ao carregar hist√≥rico:', error);
                    lista.innerHTML = '<p style="text-align:center;color:#e53e3e;">Erro ao carregar hist√≥rico</p>';
                }
            }

            function carregarEscalaDoHistorico(dataReferencia) {
                fecharHistoricoEscalas();
                document.getElementById('dataReferenciaEscala').value = dataReferencia;
                carregarEscala(dataReferencia);
            }

            function fecharHistoricoEscalas() {
                document.getElementById('historicoEscalas').style.display = 'none';
            }

            function exportarEscalaPDF() {
                const rows = document.querySelectorAll('#ansiedadeTableBody tr');
                const dataReferencia = document.getElementById('dataReferenciaEscala').value;
                const dados = Array.from(rows).map(r => ({
                    dia: r.querySelector('.ans-level').dataset.dia,
                    nivel: parseInt(r.querySelector('.ans-level').value || '0'),
                    notas: r.querySelector('.ans-notes').value || ''
                })).filter(d => d.nivel > 0 || d.notas);

                if (dados.length === 0) { mostrarToast('‚ö†Ô∏è Nenhum dado para exportar'); return; }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 20;
                const margemEsquerda = 15;
                const larguraPagina = 180;

                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('ESCALA DE ANSIEDADE DIARIA', margemEsquerda, y);
                y += 8;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('KEITE FABIOLA - PSICOLOGA 04/58498', margemEsquerda, y);
                y += 5;
                doc.text('@PSIKEITEFABIOLA | (31) 9 8681-4865', margemEsquerda, y);
                y += 5;
                if (dataReferencia) {
                    const dataFormatada = new Date(dataReferencia + 'T00:00:00').toLocaleDateString('pt-BR');
                    doc.text('Semana de: ' + dataFormatada, margemEsquerda, y);
                    y += 5;
                }
                doc.text('Exportado em: ' + new Date().toLocaleString('pt-BR'), margemEsquerda, y);
                y += 10;
                doc.setLineWidth(0.5);
                doc.line(margemEsquerda, y, margemEsquerda + larguraPagina, y);
                y += 10;

                doc.setFontSize(10);
                doc.text('Escala: 0 (Nenhuma ansiedade) a 100 (Extremo/Insuportavel)', margemEsquerda, y);
                y += 10;

                dados.forEach(d => {
                    if (y > 260) { doc.addPage(); y = 20; }
                    doc.setFont('helvetica', 'bold');
                    doc.text(d.dia + ':', margemEsquerda, y);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Nivel: ' + d.nivel, margemEsquerda + 35, y);
                    y += 6;
                    if (d.notas) {
                        doc.text('Gatilhos/Observacoes:', margemEsquerda, y);
                        y += 5;
                        const linhas = doc.splitTextToSize(d.notas, larguraPagina);
                        doc.text(linhas, margemEsquerda, y);
                        y += (linhas.length * 5) + 3;
                    } else { y += 3; }
                });

                const now = new Date();
                const pad = n => String(n).padStart(2, '0');
                const ts = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
                doc.save(`escala_ansiedade_${ts}.pdf`);
                mostrarToast('üì• PDF baixado!');
            }

            function exportarEscalaJSON() {
                const rows = document.querySelectorAll('#ansiedadeTableBody tr');
                const dataReferencia = document.getElementById('dataReferenciaEscala').value;
                const dados = Array.from(rows).map(r => ({
                    dia: r.querySelector('.ans-level').dataset.dia,
                    nivel: parseInt(r.querySelector('.ans-level').value || '0'),
                    notas: r.querySelector('.ans-notes').value || ''
                })).filter(d => d.nivel > 0 || d.notas);

                if (dados.length === 0) { mostrarToast('‚ö†Ô∏è Nenhum dado para exportar'); return; }

                const exportData = { exportadoEm: new Date().toISOString(), dataReferencia, dados };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `escala_ansiedade_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                mostrarToast('üì• JSON baixado!');
            }

            function exportarEscalaCSV() {
                const rows = document.querySelectorAll('#ansiedadeTableBody tr');
                const dataReferencia = document.getElementById('dataReferenciaEscala').value;
                const dados = Array.from(rows).map(r => ({
                    dia: r.querySelector('.ans-level').dataset.dia,
                    nivel: parseInt(r.querySelector('.ans-level').value || '0'),
                    notas: r.querySelector('.ans-notes').value || ''
                })).filter(d => d.nivel > 0 || d.notas);

                if (dados.length === 0) { mostrarToast('‚ö†Ô∏è Nenhum dado para exportar'); return; }

                let csv = 'Semana de Referencia,Dia da Semana,Nivel de Ansiedade (0-100),Gatilhos/Observacoes\n';
                dados.forEach(d => {
                    const notas = (d.notas || '').replace(/"/g, '""');
                    const dataRef = dataReferencia || '';
                    csv += `${dataRef},${d.dia},${d.nivel},"${notas}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `escala_ansiedade_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                mostrarToast('üì• CSV baixado!');
            }

            function exportarEscalaTexto() {
                const rows = document.querySelectorAll('#ansiedadeTableBody tr');
                const dataReferencia = document.getElementById('dataReferenciaEscala').value;
                const dados = Array.from(rows).map(r => ({
                    dia: r.querySelector('.ans-level').dataset.dia,
                    nivel: parseInt(r.querySelector('.ans-level').value || '0'),
                    notas: r.querySelector('.ans-notes').value || ''
                })).filter(d => d.nivel > 0 || d.notas);

                if (dados.length === 0) { mostrarToast('‚ö†Ô∏è Nenhum dado para exportar'); return; }

                let texto = 'ESCALA DE ANSIEDADE DIARIA\n';
                texto += '='.repeat(50) + '\n\n';
                texto += 'KEITE FABIOLA - PSICOLOGA 04/58498\n';
                texto += '@PSIKEITEFABIOLA | (31) 9 8681-4865\n';
                if (dataReferencia) {
                    const dataFormatada = new Date(dataReferencia + 'T00:00:00').toLocaleDateString('pt-BR');
                    texto += 'Semana de: ' + dataFormatada + '\n';
                }
                texto += 'Exportado em: ' + new Date().toLocaleString('pt-BR') + '\n';
                texto += '='.repeat(50) + '\n\n';
                texto += 'Escala: 0 (Nenhuma ansiedade) a 100 (Extremo/Insuportavel)\n\n';

                dados.forEach(d => {
                    texto += `${d.dia.toUpperCase()}\n`;
                    texto += `Nivel: ${d.nivel}/100\n`;
                    if (d.notas) {
                        texto += `Gatilhos/Observacoes: ${d.notas}\n`;
                    }
                    texto += '\n';
                });

                const blob = new Blob([texto], { type: 'text/plain;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `escala_ansiedade_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                mostrarToast('üì• Texto baixado!');
            }

            // render vazio ao abrir
            document.addEventListener('DOMContentLoaded', ()=>{
                // nada aqui ‚Äî a aba carrega via showTab
            });
        </script>
    </div>

    <!-- TAB: HIST√ìRICO -->
    <div id="historico" class="tab-content">
        <div id="headerSelecaoHistorico" style="margin-bottom: 12px; padding: 10px; background: var(--background-secondary); border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <div style="display:flex; gap:8px; align-items:center;">
                <label style="font-weight:600; margin-right:6px;">Filtro:</label>
                <select id="filtroPaciente" onchange="(function(v){try{localStorage.setItem('filtroPaciente', v.value);}catch(e){};carregarHistorico()})(this)" style="padding:6px; max-width:220px;"></select>
                <select id="filtroEmocao" onchange="carregarHistorico()" style="padding:6px;"></select>
                <select id="filtroMes" onchange="carregarHistorico()" style="padding:6px;"></select>
                <select id="filtroDia" onchange="carregarHistorico()" style="padding:6px;"></select>
                <select id="filtroAno" onchange="carregarHistorico()" style="padding:6px;"></select>
                <input id="filtroTexto" placeholder="Buscar texto..." oninput="carregarHistorico()" style="padding:6px; min-width:180px;" />
            </div>
            <div style="margin-left: auto; display:flex; gap:8px; align-items:center;">
                <button class="btn btn-secondary" onclick="selecionarTodos()" style="padding: 5px 12px; font-size: 13px;">‚úÖ Todos</button>
                <button class="btn btn-secondary" onclick="deselecionarTodos()" style="padding: 5px 12px; font-size: 13px;">‚ùå Nenhum</button>
                <span style="color: var(--text-secondary); font-size: 13px;" id="contadorSelecionados"></span>
            </div>
        </div>
        <div class="entries-list" id="entriesList"></div>
    </div>

    <!-- TAB: EXPORTAR -->
    <div id="exportar" class="tab-content">
        <div class="stats-grid" id="statsGrid"></div>

        <div class="export-section">
            <h3>üìä Exportar Dados</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Baixe seus registros para compartilhar com seu terapeuta ou fazer backup
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportarPDF()">üìÑ PDF</button>
                <button class="btn btn-primary" onclick="exportarJSON()">JSON</button>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="exportarCSV()">CSV</button>
                <button class="btn btn-primary" onclick="exportarTexto()">Texto</button>
            </div>
        </div>

        <div class="export-section">
            <h3>‚öôÔ∏è Configura√ß√µes</h3>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="limparTodosDados()">üóëÔ∏è Limpar Tudo</button>
            </div>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <!-- TAB: PERFIL -->
    <div id="perfil" class="tab-content">
        <div class="export-section">
            <h3>üë§ Meu Perfil</h3>

            <!-- Modo Visualiza√ß√£o -->
            <div class="profile-info" id="profileViewMode">
                <div class="profile-field">
                    <strong>Nome Completo:</strong>
                    <p id="profileName">Carregando...</p>
                </div>
                <div class="profile-field">
                    <strong>Email:</strong>
                    <p id="profileEmail">Carregando...</p>
                    <small style="color: var(--text-secondary); font-size: 11px;">O email n√£o pode ser alterado</small>
                </div>
                <div class="profile-field">
                    <strong>Perfil:</strong>
                    <p id="profileRole">Carregando...</p>
                </div>
                <div class="profile-field">
                    <strong>Data de Nascimento:</strong>
                    <p id="profileBirthdate">N√£o informado</p>
                </div>
                <div class="profile-field">
                    <strong>G√™nero:</strong>
                    <p id="profileGender">N√£o informado</p>
                </div>
                <div class="profile-field">
                    <strong>Membro desde:</strong>
                    <p id="profileSince">Carregando...</p>
                </div>
            </div>

            <!-- Modo Edi√ß√£o -->
            <div class="profile-edit" id="profileEditMode" style="display: none;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>Nome Completo:</strong></label>
                    <input type="text" id="editNomeCompleto" placeholder="Seu nome completo">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>Email:</strong></label>
                    <input type="email" id="editEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
                    <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">O email n√£o pode ser alterado</small>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>Data de Nascimento:</strong></label>
                    <input type="date" id="editDataNascimento">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label><strong>G√™nero:</strong></label>
                    <select id="editGenero">
                        <option value="">Selecione...</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                        <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                    </select>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" id="btnEditProfile" onclick="habilitarEdicaoPerfil()">‚úèÔ∏è Editar Perfil</button>
                <button class="btn btn-secondary" id="btnCancelEdit" onclick="cancelarEdicaoPerfil()" style="display: none;">‚ùå Cancelar</button>
                <button class="btn btn-primary" id="btnSaveProfile" onclick="salvarEdicaoPerfil()" style="display: none;">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="export-section" style="border: 2px solid var(--danger);">
            <h3 style="color: var(--danger);">‚ö†Ô∏è Zona de Perigo</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Ao excluir sua conta, todos os seus dados ser√£o permanentemente removidos e n√£o poder√£o ser recuperados.
            </p>
            <button class="btn" style="background: var(--danger); color: white;" onclick="confirmarExclusaoConta()">
                üóëÔ∏è Excluir Minha Conta
            </button>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <!-- TAB: ADMIN -->
        <!-- TAB: CONFIGURA√á√ïES (apenas admin) -->
        <div id="config" class="tab-content">
            <div class="export-section">
                <h3>‚öôÔ∏è Configura√ß√µes Gerais</h3>
                <div id="configMsg" style="color: var(--success); margin-bottom: 10px; display: none;"></div>
                <form id="configForm" onsubmit="salvarConfiguracaoSessao(event)">
                    <label for="sessionTimeoutInput"><strong>Tempo m√°ximo de sess√£o (minutos):</strong></label>
                    <input type="number" id="sessionTimeoutInput" min="5" max="240" step="1" style="width: 120px; margin: 10px 0;" required>
                    <button class="btn btn-primary" type="submit">Salvar</button>
                </form>
                <small style="color: var(--text-light);">O usu√°rio ser√° desconectado ap√≥s esse tempo de inatividade.</small>
            </div>
        </div>
    <div id="admin" class="tab-content">
        <!-- Dashboard com Estat√≠sticas -->
        <div class="export-section" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none;">
            <h3 style="color: white; margin-bottom: 20px;">üìä Dashboard Administrativo</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="totalUsuarios">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Total de Usu√°rios</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="usuariosAtivos">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Ativos (7 dias)</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="totalRegistros">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Total de Registros</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;" id="usuariosInativos">-</div>
                    <div style="font-size: 14px; opacity: 0.9;">Usu√°rios Inativos</div>
                </div>
            </div>
        </div>

        <div class="export-section">
            <h3>üîê Gerenciar Usu√°rios</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Gerencie usu√°rios cadastrados no sistema
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="carregarDashboardAdmin()">üìä Atualizar Dashboard</button>
                <button class="btn btn-primary" onclick="carregarListaUsuarios()">üîÑ Atualizar Lista</button>
                <button class="btn btn-primary" onclick="mostrarFormularioNovoUsuario()">‚ûï Criar Novo Usu√°rio</button>
            </div>
        </div>

        <!-- Formul√°rio para Criar Novo Usu√°rio -->
        <div class="export-section" id="novoUsuarioForm" style="display: none; border: 2px solid var(--primary);">
            <h3>‚ûï Criar Novo Usu√°rio</h3>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Nome Completo: *</strong></label>
                <input type="text" id="novoNomeCompleto" placeholder="Nome completo do usu√°rio">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Email: *</strong></label>
                <input type="email" id="novoEmail" placeholder="email@exemplo.com">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Senha Tempor√°ria: *</strong></label>
                <input type="password" id="novoSenha" placeholder="M√≠nimo 6 caracteres">
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    O usu√°rio poder√° alterar a senha ap√≥s o primeiro login
                </small>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Data de Nascimento:</strong></label>
                <input type="date" id="novoDataNascimento">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>G√™nero:</strong></label>
                <select id="novoGenero">
                    <option value="">Selecione...</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Permiss√£o: *</strong></label>
                <select id="novoRole">
                    <option value="user">Usu√°rio</option>
                    <option value="psicologo">Psic√≥logo</option>
                    <option value="admin">Administrador</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    Administradores podem gerenciar todos os usu√°rios. Psic√≥logos podem acessar registros dos pacientes.
                </small>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="ocultarFormularioNovoUsuario()">‚ùå Cancelar</button>
                <button class="btn btn-primary" onclick="criarNovoUsuario()">‚úÖ Criar Usu√°rio</button>
            </div>
        </div>

        <!-- Formul√°rio para Editar Usu√°rio Existente -->
        <div class="export-section" id="editarUsuarioForm" style="display: none; border: 2px solid var(--primary);">
            <h3>‚úèÔ∏è Editar Usu√°rio</h3>
            <input type="hidden" id="editarUsuarioUid">
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Nome Completo: *</strong></label>
                <input type="text" id="editarNomeCompleto" placeholder="Nome completo do usu√°rio">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Email:</strong></label>
                <input type="email" id="editarEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    O email n√£o pode ser alterado
                </small>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Data de Nascimento:</strong></label>
                <input type="date" id="editarDataNascimento">
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>G√™nero:</strong></label>
                <select id="editarGenero">
                    <option value="">Selecione...</option>
                    <option value="masculino">Masculino</option>
                    <option value="feminino">Feminino</option>
                    <option value="outro">Outro</option>
                    <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Permiss√£o: *</strong></label>
                <select id="editarRole">
                    <option value="user">Usu√°rio</option>
                    <option value="psicologo">Psic√≥logo</option>
                    <option value="admin">Administrador</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    Administradores podem gerenciar todos os usu√°rios. Psic√≥logos podem acessar registros dos pacientes.
                </small>
            </div>
            <div class="form-group" style="margin-bottom: 15px; text-align: left;">
                <label><strong>Status: *</strong></label>
                <select id="editarStatus">
                    <option value="ativo">‚úÖ Ativo</option>
                    <option value="inativo">üö´ Inativo</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 5px;">
                    Usu√°rios inativos n√£o podem fazer login
                </small>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="cancelarEdicaoUsuarioAdmin()">‚ùå Cancelar</button>
                <button class="btn btn-primary" onclick="salvarEdicaoUsuarioAdmin()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="export-section">
            <h3>üë• Usu√°rios Cadastrados</h3>
            <div id="usersList" style="text-align: left;">
                <p style="text-align: center; color: var(--text-secondary);">Clique em "Atualizar Lista" para carregar os usu√°rios</p>
            </div>
        </div>

        <div class="footer-info">
            <p><strong>KEITE FABIOLA ‚Äì PSIC√ìLOGA 04/58498</strong></p>
            <p>@PSIKEITEFABIOLA | (31) 9 8681-4865</p>
            <p>keitefabiola@outlook.com</p>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
                                                // Microintera√ß√£o: cor do thumb da barra de intensidade muda conforme valor
                                                document.addEventListener('DOMContentLoaded', function() {
                                                    var slider = document.querySelector('.intensity-slider');
                                                    if (slider) {
                                                        function updateThumbColor() {
                                                            var val = parseInt(slider.value);
                                                            var thumbColor = '#48bb78'; // verde
                                                            if (val >= 4 && val < 7) thumbColor = '#ecc94b'; // amarelo
                                                            if (val >= 7) thumbColor = '#f56565'; // vermelho
                                                            slider.style.setProperty('--thumb-color', thumbColor);
                                                        }
                                                        slider.addEventListener('input', updateThumbColor);
                                                        updateThumbColor();
                                                    }
                                                });
                                        // Exibir bottom nav apenas no mobile
                                        function updateBottomNavVisibility() {
                                            const nav = document.getElementById('bottomNav');
                                            if (window.innerWidth <= 700) {
                                                nav.style.display = 'flex';
                                            } else {
                                                nav.style.display = 'none';
                                            }
                                        }
                                        window.addEventListener('resize', updateBottomNavVisibility);
                                        window.addEventListener('DOMContentLoaded', updateBottomNavVisibility);

        // Sincronizar abas admin/config em todos os menus (tabs, lateral, bottom nav)
        function mostrarAbaConfigSeAdmin(perfil) {
            const configTab = document.getElementById('configTab');
            const adminTab = document.getElementById('adminTab');
            const configTabSide = document.getElementById('configTabSide');
            const adminTabSide = document.getElementById('adminTabSide');
            const navConfig = document.getElementById('navConfig');
            const navAdmin = document.getElementById('navAdmin');
            if (perfil && perfil.role === 'admin') {
                if (configTab) configTab.style.display = '';
                if (adminTab) adminTab.style.display = '';
                if (configTabSide) configTabSide.style.display = '';
                if (adminTabSide) adminTabSide.style.display = '';
                if (navConfig) navConfig.style.display = '';
                if (navAdmin) navAdmin.style.display = '';
                isAdminUser = true;
            } else {
                if (configTab) configTab.style.display = 'none';
                if (adminTab) adminTab.style.display = 'none';
                if (configTabSide) configTabSide.style.display = 'none';
                if (adminTabSide) adminTabSide.style.display = 'none';
                if (navConfig) navConfig.style.display = 'none';
                if (navAdmin) navAdmin.style.display = 'none';
                isAdminUser = false;
            }
        }

                                        // Destacar aba ativa no bottom nav
                                        function highlightBottomNav(tab) {
                                            if (window.innerWidth > 700) return;
                                            const ids = ['navNovo','navHistorico','navAnsiedade','navExportar','navPerfil','navAdmin','navConfig'];
                                            ids.forEach(id => {
                                                const btn = document.getElementById(id);
                                                if (btn) btn.classList.remove('active');
                                            });
                                            const map = {
                                                'novo': 'navNovo',
                                                'historico': 'navHistorico',
                                                'ansiedade': 'navAnsiedade',
                                                'exportar': 'navExportar',
                                                'perfil': 'navPerfil',
                                                'admin': 'navAdmin',
                                                'config': 'navConfig'
                                            };
                                            if (map[tab]) {
                                                const btn = document.getElementById(map[tab]);
                                                if (btn) btn.classList.add('active');
                                            }
                                        }
                                        // Adaptar showTab para destacar aba ativa no bottom nav
                                        const originalShowTab2 = window.showTab;
                                        window.showTab = function(tab, event) {
                                            if (typeof originalShowTab2 === 'function') originalShowTab2(tab, event);
                                            highlightBottomNav(tab);
                                        };
                                // Exibir bot√£o hamb√∫rguer apenas no mobile
                                function updateHamburgerVisibility() {
                                    const btn = document.getElementById('hamburgerBtn');
                                    if (window.innerWidth <= 700) {
                                        btn.style.display = 'block';
                                    } else {
                                        btn.style.display = 'none';
                                    }
                                }
                                window.addEventListener('resize', updateHamburgerVisibility);
                                window.addEventListener('DOMContentLoaded', updateHamburgerVisibility);

                                // Abrir/fechar menu lateral
                                const hamburgerBtn = document.getElementById('hamburgerBtn');
                                const sideMenu = document.getElementById('sideMenu');
                                const closeMenuBtn = document.getElementById('closeMenuBtn');
                                hamburgerBtn.addEventListener('click', () => {
                                    sideMenu.classList.add('open');
                                });
                                closeMenuBtn.addEventListener('click', () => {
                                    sideMenu.classList.remove('open');
                                });
                                // Fechar menu ao clicar fora
                                document.addEventListener('click', function(e) {
                                    if (window.innerWidth > 700) return;
                                    if (sideMenu.classList.contains('open') && !sideMenu.contains(e.target) && e.target !== hamburgerBtn) {
                                        sideMenu.classList.remove('open');
                                    }
                                });
                                // Fechar menu ao trocar aba
                                function closeSideMenuOnTab() {
                                    if (window.innerWidth <= 700) sideMenu.classList.remove('open');
                                }
                                // Adaptar showTab para fechar menu lateral
                                const originalShowTab = window.showTab;
                                window.showTab = function(tab, event) {
                                    if (typeof originalShowTab === 'function') originalShowTab(tab, event);
                                    closeSideMenuOnTab();
                                };
                                // Sincronizar visibilidade das abas admin/config no menu lateral
                                function mostrarAbaConfigSeAdmin(perfil) {
                                    if (perfil && perfil.role === 'admin') {
                                        document.getElementById('configTab').style.display = '';
                                        document.getElementById('configTabSide').style.display = '';
                                        document.getElementById('adminTab').style.display = '';
                                        document.getElementById('adminTabSide').style.display = '';
                                        isAdminUser = true;
                                    } else {
                                        document.getElementById('configTab').style.display = 'none';
                                        document.getElementById('configTabSide').style.display = 'none';
                                        document.getElementById('adminTab').style.display = 'none';
                                        document.getElementById('adminTabSide').style.display = 'none';
                                        isAdminUser = false;
                                    }
                                }
                        // --- Controle de tentativas de login ---
                        function getLoginAttempts(email) {
                            try {
                                const data = localStorage.getItem('loginAttempts_' + email);
                                return data ? JSON.parse(data) : { count: 0, lastFail: 0, blockedUntil: 0 };
                            } catch {
                                return { count: 0, lastFail: 0, blockedUntil: 0 };
                            }
                        }

                        function setLoginAttempts(email, obj) {
                            try {
                                localStorage.setItem('loginAttempts_' + email, JSON.stringify(obj));
                            } catch {}
                        }
                // --- Configura√ß√£o de sess√£o (admin) ---
                let sessionTimeout = 30 * 60 * 1000; // padr√£o: 30min
                let sessionTimer;
                let isAdminUser = false;

                // Mostra a aba de configura√ß√£o apenas se o usu√°rio for admin (usando perfil do Firestore)

                async function carregarConfiguracaoSessao() {
                    try {
                        const doc = await firebase.firestore().doc('config/sessao').get();
                        if (doc.exists && doc.data().timeoutMin) {
                            sessionTimeout = doc.data().timeoutMin * 60 * 1000;
                            document.getElementById('sessionTimeoutInput').value = doc.data().timeoutMin;
                        } else {
                            document.getElementById('sessionTimeoutInput').value = 30;
                        }
                    } catch (e) {
                        document.getElementById('sessionTimeoutInput').value = 30;
                    }
                    resetSessionTimer();
                }

                async function salvarConfiguracaoSessao(event) {
                    event.preventDefault();
                    const min = parseInt(document.getElementById('sessionTimeoutInput').value, 10);
                    if (isNaN(min) || min < 5 || min > 240) return;
                    try {
                        await firebase.firestore().doc('config/sessao').set({ timeoutMin: min }, { merge: true });
                        sessionTimeout = min * 60 * 1000;
                        document.getElementById('configMsg').textContent = 'Configura√ß√£o salva!';
                        document.getElementById('configMsg').style.display = '';
                        setTimeout(() => document.getElementById('configMsg').style.display = 'none', 2000);
                        resetSessionTimer();
                    } catch (e) {
                        document.getElementById('configMsg').textContent = 'Erro ao salvar.';
                        document.getElementById('configMsg').style.display = '';
                    }
                }

                function resetSessionTimer() {
                    clearTimeout(sessionTimer);
                    sessionTimer = setTimeout(() => {
                        alert('Sess√£o expirada por inatividade.');
                        handleLogout();
                    }, sessionTimeout);
                }

                ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt =>
                    document.addEventListener(evt, resetSessionTimer)
                );
        const emocoesCores = {
            'Raiva': '#E18AB8',
            'Tristeza': '#4A63A5',
            'Surpresa': '#70C1CF',
            'Alegria': '#AFD799',
            'Amor': '#E7E26B',
            'Medo': '#E88C5B'
        };

        const emocoesCoresEspecificas = {
            '√ìdio': '#E18AB8',
            'Hostilidade': '#E18AB8',
            'Agita√ß√£o': '#E18AB8',
            'Frustra√ß√£o': '#E18AB8',
            'Irrita√ß√£o': '#E18AB8',
            'Provoca√ß√£o': '#E18AB8',
            'Ci√∫mes': '#E18AB8',
            'Ressentimento': '#E18AB8',
            'Desespero': '#E18AB8',
            'Revoltado': '#E18AB8',
            'Agoniado': '#4A63A5',
            'Machucado': '#4A63A5',
            'Depress√£o': '#4A63A5',
            'Pesar': '#4A63A5',
            'Consternado': '#4A63A5',
            'Desagradado': '#4A63A5',
            'Arrependimento': '#4A63A5',
            'Culpa': '#4A63A5',
            'Isolamento': '#4A63A5',
            'Solit√°rio': '#4A63A5',
            'Luto': '#4A63A5',
            'Impot√™ncia': '#4A63A5',
            'Chocado': '#70C1CF',
            'Desiludido': '#70C1CF',
            'Perplexo': '#70C1CF',
            'At√¥nito': '#70C1CF',
            'Impressionado': '#70C1CF',
            'Sem palavras': '#70C1CF',
            'Espantado': '#70C1CF',
            'Estimulado': '#70C1CF',
            'Tocado': '#70C1CF',
            'Gozo': '#AFD799',
            'Saciado': '#AFD799',
            'Divertido': '#AFD799',
            'Deleite': '#AFD799',
            'Jovial': '#AFD799',
            'Aben√ßoado': '#AFD799',
            'Triunfante': '#AFD799',
            'Famoso': '#AFD799',
            'Esperan√ßoso': '#AFD799',
            'Ansioso': '#AFD799',
            'Excitado': '#AFD799',
            'Zelo': '#AFD799',
            'J√∫bilo': '#AFD799',
            'Euforia': '#AFD799',
            '√äxtase': '#AFD799',
            'Sedu√ß√£o': '#AFD799',
            'Pleno': '#E7E26B',
            'Liberdade': '#E7E26B',
            'Compaix√£o': '#E7E26B',
            'Cuidado': '#E7E26B',
            'Fasc√≠nio': '#E7E26B',
            'Paix√£o': '#E7E26B',
            'Atra√ß√£o': '#E7E26B',
            'Sens√≠vel': '#E7E26B',
            'Carinho': '#E7E26B',
            'Rom√¢ntico': '#E7E26B',
            'Pavor': '#E88C5B',
            'Mortificado': '#E88C5B',
            'Ansiedade': '#E88C5B',
            'Preocupa√ß√£o': '#E88C5B',
            'Inadequa√ß√£o': '#E88C5B',
            'Inferioridade': '#E88C5B',
            'Histeria': '#E88C5B',
            'P√¢nico': '#E88C5B',
            'Amedrontado': '#E88C5B',
            'Abandono': '#E88C5B'
        };

        const emocoesExplicacoes = {
            // Raiva
            '√ìdio': 'Avers√£o intensa e profunda, desejo de afastar ou eliminar algo/algu√©m',
            'Hostilidade': 'Atitude antagonista e agressiva, postura de oposi√ß√£o',
            'Agita√ß√£o': 'Estado de inquieta√ß√£o e perturba√ß√£o, dificuldade de se acalmar',
            'Frustra√ß√£o': 'Sentimento de desapontamento quando expectativas n√£o s√£o atendidas',
            'Irrita√ß√£o': 'Inc√¥modo e impaci√™ncia com situa√ß√µes ou pessoas',
            'Provoca√ß√£o': 'Sensa√ß√£o de estar sendo testado ou desafiado de forma negativa',
            'Ci√∫mes': 'Receio de perder algo/algu√©m para outro, possessividade',
            'Ressentimento': 'M√°goa guardada, sentimento de injusti√ßa n√£o resolvido',
            'Desespero': 'Perda de esperan√ßa, sensa√ß√£o de n√£o haver sa√≠da',
            'Revoltado': 'Indigna√ß√£o extrema, rebeldia contra uma situa√ß√£o',

            // Tristeza
            'Agoniado': 'Sofrimento intenso, ang√∫stia emocional profunda',
            'Machucado': 'Ferido emocionalmente, dor emocional por algo que aconteceu',
            'Depress√£o': 'Estado de profunda tristeza e falta de energia/motiva√ß√£o',
            'Pesar': 'Sentimento de lamento e peso no cora√ß√£o',
            'Consternado': 'Perplexidade dolorosa, choque com algo negativo',
            'Desagradado': 'Descontentamento, falta de satisfa√ß√£o com situa√ß√£o',
            'Arrependimento': 'Remorso por algo que fez ou deixou de fazer',
            'Culpa': 'Sensa√ß√£o de responsabilidade por algo negativo, autocr√≠tica',
            'Isolamento': 'Sensa√ß√£o de estar separado dos outros, desconex√£o',
            'Solit√°rio': 'Sentimento de solid√£o, falta de companhia',
            'Luto': 'Dor pela perda de algu√©m ou algo importante',
            'Impot√™ncia': 'Sensa√ß√£o de n√£o ter poder para mudar a situa√ß√£o',

            // Surpresa
            'Chocado': 'Impacto emocional forte, dificuldade de processar o inesperado',
            'Desiludido': 'Decep√ß√£o ao perceber que algo n√£o era como parecia',
            'Perplexo': 'Confus√£o e incerteza diante do inesperado',
            'At√¥nito': 'Paralisado pela surpresa, estupefato',
            'Impressionado': 'Marcado positivamente por algo inesperado',
            'Sem palavras': 'Incapacidade de expressar o que sente diante da surpresa',
            'Espantado': 'Surpreso de forma intensa, admirado',
            'Estimulado': 'Energizado e motivado por algo novo',
            'Tocado': 'Emocionalmente afetado de forma sens√≠vel',

            // Alegria
            'Gozo': 'Prazer intenso, satisfa√ß√£o plena',
            'Saciado': 'Plenamente satisfeito, necessidades atendidas',
            'Divertido': 'Entretenimento e alegria por algo engra√ßado ou prazeroso',
            'Deleite': 'Prazer refinado, aprecia√ß√£o profunda',
            'Jovial': 'Alegria leve e descontra√≠da, bom humor',
            'Aben√ßoado': 'Gratid√£o por se sentir agraciado, sortudo',
            'Triunfante': 'Vit√≥ria e conquista, sensa√ß√£o de sucesso',
            'Famoso': 'Reconhecimento social, sentir-se valorizado por muitos',
            'Esperan√ßoso': 'Otimismo sobre o futuro, expectativa positiva',
            'Ansioso': 'Expectativa intensa (positiva) por algo desejado',
            'Excitado': 'Energia alta com antecipa√ß√£o positiva',
            'Zelo': 'Entusiasmo fervoroso, dedica√ß√£o apaixonada',
            'J√∫bilo': 'Alegria exuberante, celebra√ß√£o intensa',
            'Euforia': 'Felicidade extrema, √™xtase de alegria',
            '√äxtase': 'Estado m√°ximo de prazer e alegria',
            'Sedu√ß√£o': 'Atra√ß√£o magn√©tica, charme e encantamento',

            // Amor
            'Pleno': 'Completude interior, paz e satisfa√ß√£o profunda',
            'Liberdade': 'Sensa√ß√£o de autonomia e aus√™ncia de restri√ß√µes',
            'Compaix√£o': 'Empatia ativa, desejo de aliviar o sofrimento alheio',
            'Cuidado': 'Aten√ß√£o dedicada ao bem-estar de algu√©m',
            'Fasc√≠nio': 'Encantamento intenso, absor√ß√£o total',
            'Paix√£o': 'Amor intenso e ardente, desejo profundo',
            'Atra√ß√£o': 'Interesse magn√©tico por algu√©m, desejo de proximidade',
            'Sens√≠vel': 'Delicadeza emocional, receptividade afetiva',
            'Carinho': 'Afeto terno e gentil, ternura',
            'Rom√¢ntico': 'Amor idealizado, valoriza√ß√£o da beleza do relacionamento',

            // Medo
            'Pavor': 'Terror extremo, medo paralisante',
            'Mortificado': 'Constrangimento profundo misturado com medo',
            'Ansiedade': 'Apreens√£o com o futuro, preocupa√ß√£o antecipada',
            'Preocupa√ß√£o': 'Inquieta√ß√£o com poss√≠veis problemas',
            'Inadequa√ß√£o': 'Sensa√ß√£o de n√£o ser bom o suficiente',
            'Inferioridade': 'Sentir-se menor ou pior que os outros',
            'Histeria': 'Rea√ß√£o de medo descontrolada, perda de controle emocional',
            'P√¢nico': 'Medo s√∫bito e avassalador, rea√ß√£o de fuga',
            'Amedrontado': 'Estado de medo persistente, intimida√ß√£o',
            'Abandono': 'Medo de ser deixado sozinho, rejei√ß√£o'
        };

        const emocoesHierarquia = {
            'Raiva': {
                emoji: 'üò†',
                intermediarias: {
                    'Furioso': ['√ìdio', 'Hostilidade'],
                    'Exasperado': ['Agita√ß√£o', 'Frustra√ß√£o'],
                    'Irritado': ['Irrita√ß√£o', 'Provoca√ß√£o'],
                    'Inveja': ['Ci√∫mes', 'Ressentimento'],
                    'Desgosto': ['Desespero', 'Revoltado']
                }
            },
            'Tristeza': {
                emoji: 'üò¢',
                intermediarias: {
                    'Sofrimento': ['Agoniado', 'Machucado'],
                    'Tristeza': ['Depress√£o', 'Pesar'],
                    'Desapontamento': ['Consternado', 'Desagradado'],
                    'Vergonha': ['Arrependimento', 'Culpa'],
                    'Neglig√™ncia': ['Isolamento', 'Solit√°rio'],
                    'Desespero': ['Luto', 'Impot√™ncia']
                }
            },
            'Surpresa': {
                emoji: 'üò≤',
                intermediarias: {
                    'Atordoamento': ['Chocado', 'Consternado'],
                    'Confus√£o': ['Desiludido', 'Perplexo'],
                    'Espanto': ['At√¥nito', 'Impressionado'],
                    'Supera√ß√£o': ['Sem palavras', 'Espantado'],
                    'Abalado': ['Estimulado', 'Tocado']
                }
            },
            'Alegria': {
                emoji: 'üòä',
                intermediarias: {
                    'Satisfeito': ['Gozo', 'Saciado'],
                    'Feliz': ['Divertido', 'Deleite'],
                    'Animado': ['Aben√ßoado', 'Jovial'],
                    'Orgulhoso': ['Famoso', 'Triunfante'],
                    'Otimista': ['Esperan√ßoso', 'Ansioso'],
                    'Entusiasmo': ['Zelo', 'Excitado'],
                    'Exaltado': ['J√∫bilo', 'Euforia'],
                    'Encantado': ['√äxtase', 'Sedu√ß√£o']
                }
            },
            'Amor': {
                emoji: 'ü•∞',
                intermediarias: {
                    'Pac√≠fico': ['Pleno', 'Liberdade'],
                    'Afetuoso': ['Compaix√£o', 'Cuidado'],
                    'Desejoso': ['Fasc√≠nio', 'Paix√£o'],
                    'Nost√°lgico': ['Atra√ß√£o', 'Sens√≠vel'],
                    'Encantado': ['Carinho', 'Rom√¢ntico']
                }
            },
            'Medo': {
                emoji: 'üò®',
                intermediarias: {
                    'Horrorizado': ['Pavor', 'Mortificado'],
                    'Nervoso': ['Ansiedade', 'Preocupa√ß√£o'],
                    'Inseguro': ['Inadequa√ß√£o', 'Inferioridade'],
                    'Aterrorizado': ['Histeria', 'P√¢nico'],
                    'Assustado': ['Amedrontado', 'Abandono']
                }
            }
        };

        let emocaoSelecionada = {
            central: '',
            intermediaria: '',
            especifica: ''
        };

        // Fun√ß√£o de sanitiza√ß√£o para prevenir XSS
        function sanitizarTexto(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }

        function desanitizarTexto(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            let prev = null;
            let curr = texto + '';
            // Decodifica entidades HTML repetidamente at√© estabilizar (evita double-encoded)
            for (let i = 0; i < 5; i++) {
                div.innerHTML = curr;
                const decoded = div.textContent;
                if (decoded === prev) break;
                prev = curr;
                curr = decoded;
            }
            return curr;
        }

        // Flag de produ√ß√£o - true para desabilitar logs
        const PRODUCTION_MODE = false; // Mude para true em produ√ß√£o

        // Wrapper para console.log que respeita modo de produ√ß√£o
        const debugLog = (...args) => {
            if (!PRODUCTION_MODE) {
                console.log(...args);
            }
        };

        function inicializarApp() {
            const agora = new Date();
            agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
            document.getElementById('dataHora').value = agora.toISOString().slice(0, 16);

            criarGridEmocoes();
            configurarSliderIntensidade();
            carregarHistorico();
            atualizarEstatisticas();

            // Verificar se usu√°rio √© admin e mostrar aba
            verificarAdminSilencioso();
            // Sincronizar registros pendentes quando ficar online
            window.addEventListener('online', () => {
                debugLog('üîî Online - tentando sincronizar registros pendentes');
                sincronizarPendentes();
            });
            // Tentar sincronizar no startup
            setTimeout(() => { if (navigator.onLine) sincronizarPendentes(); }, 1500);
            // ...passphrase removido...
        }

        function criarGridEmocoes() {
            const grid = document.getElementById('emotionsGrid');
            const emocoesCentrais = Object.keys(emocoesHierarquia);

            grid.innerHTML = emocoesCentrais.map(nome => {
                const cor = emocoesCores[nome];
                return `
                    <button class="emotion-btn" onclick="selecionarEmocaoCentral('${nome}', this)"
                            style="border-color: ${cor}20; background: ${cor}10;">
                        <span class="emoji">${emocoesHierarquia[nome].emoji}</span>
                        ${nome}
                    </button>
                `;
            }).join('');
        }

        function selecionarEmocaoCentral(nome, btn) {
            document.querySelectorAll('#emotionsGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.central = nome;
            emocaoSelecionada.intermediaria = '';
            emocaoSelecionada.especifica = '';

            // Mostrar emo√ß√µes intermedi√°rias
            const intermediariasDiv = document.getElementById('intermediariasDiv');
            const intermediarias = Object.keys(emocoesHierarquia[nome].intermediarias);
            const cor = emocoesCores[nome];

            intermediariasDiv.innerHTML = `
                <div class="form-group">
                    <label><span class="emoji">üéØ</span> Qual tipo de ${nome}? (opcional)</label>
                    <div class="emotions-grid" id="intermediariasGrid">
                        ${intermediarias.map(inter => `
                            <button class="emotion-btn" onclick="selecionarIntermediaria('${inter}', this)"
                                    style="border-color: ${cor}40; background: ${cor}15;">
                                ${inter}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            // Limpar emo√ß√µes espec√≠ficas
            document.getElementById('especificasDiv').innerHTML = '';
        }

        function selecionarIntermediaria(nome, btn) {
            document.querySelectorAll('#intermediariasGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.intermediaria = nome;
            emocaoSelecionada.especifica = '';

            // Mostrar emo√ß√µes espec√≠ficas
            const especificasDiv = document.getElementById('especificasDiv');
            const especificas = emocoesHierarquia[emocaoSelecionada.central].intermediarias[nome];
            const cor = emocoesCores[emocaoSelecionada.central];

            especificasDiv.innerHTML = `
                <div class="form-group">
                    <label><span class="emoji">üîç</span> Mais especificamente: (opcional)</label>
                    <div class="emotions-grid" id="especificasGrid">
                        ${especificas.map(esp => {
                            const corEspecifica = emocoesCoresEspecificas[esp] || cor;
                            const explicacao = emocoesExplicacoes[esp] || '';
                            return `
                                <button class="emotion-btn" onclick="selecionarEspecifica('${esp}', this)"
                                        style="border-color: ${corEspecifica}; background: ${corEspecifica}30;">
                                    <span class="emocao-nome">${esp}</span>
                                    <span class="emocao-explicacao">${explicacao}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function selecionarEspecifica(nome, btn) {
            document.querySelectorAll('#especificasGrid .emotion-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            emocaoSelecionada.especifica = nome;
        }

        function configurarSliderIntensidade() {
            const slider = document.getElementById('intensidade');
            const valor = document.getElementById('intensidadeValor');
            if (slider && valor) {
                slider.oninput = () => valor.textContent = slider.value;
            }
        }

        function atualizarSlidersIntensidade() {
            const intensidadesDiv = document.getElementById('intensidadesDiv');

            if (emocoesSelecionadas.length === 0) {
                intensidadesDiv.innerHTML = '';
                return;
            }

            intensidadesDiv.innerHTML = `
                <label><span class="emoji">üèöÔ∏è</span> Intensidade de cada emo√ß√£o (0-10)</label>
                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-bottom: 12px;">
                    üí° Ajuste a intensidade individualmente para cada emo√ß√£o selecionada
                </small>
                ${emocoesSelecionadas.map((emocao, index) => {
                    const cor = emocoesCores[emocao.central] || '#667eea';
                    const emoji = emocoesHierarquia[emocao.central]?.emoji || '‚ù§Ô∏è';
                    return `
                        <div style="margin-bottom: 15px; padding: 12px; background: ${cor}10; border-left: 4px solid ${cor}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: ${cor};"><span style="font-size: 18px;">${emoji}</span> ${emocao.central}</span>
                                <span style="font-weight: bold; font-size: 18px; color: ${cor};" id="intensidadeValor${index}">${emocao.intensidade || 5}</span>
                            </div>
                            <input type="range" min="0" max="10" value="${emocao.intensidade || 5}"
                                   class="intensity-slider"
                                   style="width: 100%;"
                                   oninput="atualizarIntensidadeEmocao(${index}, this.value)">
                        </div>
                    `;
                }).join('')}
            `;
        }

        function atualizarIntensidadeEmocao(index, valor) {
            if (emocoesSelecionadas[index]) {
                emocoesSelecionadas[index].intensidade = parseInt(valor);
                document.getElementById(`intensidadeValor${index}`).textContent = valor;
            }
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Se n√£o houver event, procurar a tab pelo onclick
                document.querySelectorAll('.tab').forEach(t => {
                    if (t.getAttribute('onclick')?.includes(tabName)) {
                        t.classList.add('active');
                    }
                });
            }

            document.getElementById(tabName).classList.add('active');

            if (tabName === 'historico') carregarHistorico();
            if (tabName === 'exportar') atualizarEstatisticas();
            if (tabName === 'perfil') carregarPerfilUsuarioNaTela();
            if (tabName === 'admin') verificarAdmin();
            if (tabName === 'ansiedade') {
                try { 
                    inicializarDataReferencia();
                    carregarEscala(); 
                } catch(e) {}
            }
        }

        function salvarRegistro() {
            const dataHora = document.getElementById('dataHora').value;
            // Impedir registro com data/hora futura
            const dataHoraDate = new Date(dataHora);
            const agoraCheck = new Date();
            if (isNaN(dataHoraDate.getTime())) {
                mostrarToast('‚ö†Ô∏è Data/Hora inv√°lida');
                return;
            }
            if (dataHoraDate > agoraCheck) {
                mostrarToast('‚ö†Ô∏è A data/hora do registro n√£o pode ser no futuro');
                return;
            }
            const situacaoRaw = document.getElementById('situacao').value.trim();
            const pensamentoRaw = document.getElementById('pensamento').value.trim();
            const intensidade = parseInt(document.getElementById('intensidade').value, 10);
            const comportamentoRaw = document.getElementById('comportamento').value.trim();

            if (!dataHora || !situacaoRaw || !pensamentoRaw || !emocaoSelecionada.central || !comportamentoRaw) {
                mostrarToast('‚ö†Ô∏è Preencha todos os campos e selecione uma emo√ß√£o!');
                return;
            }

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado para salvar!');
                return;
            }

            // Sanitizar todos os inputs de texto
            const situacao = sanitizarTexto(situacaoRaw);
            const pensamento = sanitizarTexto(pensamentoRaw);
            const comportamento = sanitizarTexto(comportamentoRaw);

            const registro = {
                id: Date.now(),
                dataHora,
                situacao,
                pensamento,
                emocaoCentral: emocaoSelecionada.central,
                emocaoIntermediaria: emocaoSelecionada.intermediaria || '',
                emocaoEspecifica: emocaoSelecionada.especifica || '',
                intensidade,
                comportamento
            };

            // Tentar salvar no Firebase; se falhar, salvar offline e sincronizar depois
            debugLog('‚òÅÔ∏è Tentando salvar registro no Firebase...');
            (async () => {
                try {
                    let toSave = registro;

                    const firebaseId = await salvarRegistroFirebase(toSave);
                    if (firebaseId) {
                        registro.firebaseId = firebaseId;
                        if (toSave.encrypted) {
                            // armazenar representa√ß√£o segura na mem√≥ria
                            registrosEmMemoria.push({
                                id: registro.id,
                                firebaseId,
                                dataHora: registro.dataHora,
                                emocaoCentral: registro.emocaoCentral,
                                intensidade: registro.intensidade,
                                encrypted: true
                            });
                        } else {
                            registrosEmMemoria.push(registro);
                        }
                        debugLog('‚úÖ Registro salvo com sucesso! Firebase ID:', firebaseId);
                        document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                        mostrarToast('‚úÖ Registro salvo com sucesso!');
                    } else {
                        // Salvar offline
                        await salvarRegistroOffline(toSave);
                        mostrarToast('‚úÖ Registro salvo offline; ser√° sincronizado quando online');
                    }

                    limparFormulario();
                    setTimeout(() => showTab('historico'), 1500);
                } catch (err) {
                    console.error('‚ùå Erro ao salvar:', err);
                    // Salvar em pendentes locais
                    await salvarRegistroOffline(registro);
                    mostrarToast('‚úÖ Registro salvo offline; ser√° sincronizado quando online');
                    document.getElementById('syncStatus').textContent = '‚ö† Erro na sincroniza√ß√£o';
                    limparFormulario();
                    setTimeout(() => showTab('historico'), 1500);
                }
            })();
        }

        function limparFormulario() {
            document.getElementById('situacao').value = '';
            document.getElementById('pensamento').value = '';
            document.getElementById('comportamento').value = '';
            document.getElementById('intensidade').value = 5;
            document.getElementById('intensidadeValor').textContent = '5';
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            emocaoSelecionada = {
                central: '',
                intermediaria: '',
                especifica: ''
            };
            emocoesSelecionadas = [];
            document.getElementById('intermediariasDiv').innerHTML = '';
            document.getElementById('especificasDiv').innerHTML = '';

            const agora = new Date();
            agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
            document.getElementById('dataHora').value = agora.toISOString().slice(0, 16);
        }

        // Armazena registros em mem√≥ria (carregados do Firebase)
        let registrosEmMemoria = [];
        // ...fun√ß√µes de passphrase removidas...

        // Retorna todos os registros se for psic√≥logo/admin, ou s√≥ os pr√≥prios se for usu√°rio
        function getRegistros() {
            if (window.perfilAtual && (window.perfilAtual.role === 'psicologo' || window.perfilAtual.role === 'admin')) {
                return registrosEmMemoria.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            } else if (window.perfilAtual && window.perfilAtual.role === 'user') {
                return registrosEmMemoria.filter(r => r.uid === currentUser.uid).sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            } else {
                return registrosEmMemoria.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            }
        }

        function getRegistrosSelecionados() {
            const checkboxes = document.querySelectorAll('.registro-checkbox:checked');
            const idsSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            return registrosEmMemoria
                .filter(r => idsSelecionados.includes(r.id))
                .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
        }

        function carregarHistorico() {

            let registros = getRegistros().sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            const lista = document.getElementById('entriesList');
            // N√£o criar/remover header dinamicamente aqui ‚Äî o header de filtros existe no HTML.
            // Popular e aplicar filtro por paciente (apenas para psic√≥logo/admin)
            try {
                const filtroPacienteElem = document.getElementById('filtroPaciente');
                const storedFiltroPaciente = localStorage.getItem('filtroPaciente') || ((typeof currentUser !== 'undefined' && currentUser && currentUser.uid) ? currentUser.uid : '');
                if (filtroPacienteElem) {
                    if (window.perfilAtual && (window.perfilAtual.role === 'psicologo' || window.perfilAtual.role === 'admin')) {
                        // lista de pacientes (UIDs) a partir dos registros dispon√≠veis
                        const pacientesUnicos = Array.from(new Set(registros.map(r => r.uid))).filter(Boolean);
                        if (!window.pacientesNomes) window.pacientesNomes = {};
                        const esc = s => (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;');
                        const pacienteOptions = ['<option value="">Todos os pacientes</option>']
                            .concat(pacientesUnicos.map(uid => {
                                const nome = window.pacientesNomes[uid] || uid;
                                return `<option value="${uid}" ${uid===storedFiltroPaciente? 'selected' : ''}>${esc(nome)}</option>`;
                            })).join('');
                        filtroPacienteElem.innerHTML = pacienteOptions;
                        try { if (storedFiltroPaciente) filtroPacienteElem.value = storedFiltroPaciente; } catch(e) { /* ignore */ }
                        // aplicar filtro sele√ß√£o
                        const filtroPacienteAtual = (filtroPacienteElem && filtroPacienteElem.value) || storedFiltroPaciente || '';
                        if (filtroPacienteAtual) registros = registros.filter(r => r.uid === filtroPacienteAtual);
                        // tentar resolver nomes ausentes assincronamente
                        pacientesUnicos.forEach(async uid => {
                            if (!window.pacientesNomes[uid]) {
                                try {
                                    const doc = await db.collection('usuarios').doc(uid).get();
                                    if (doc.exists) {
                                        window.pacientesNomes[uid] = doc.data().nomeCompleto || doc.data().nome || uid;
                                        // atualizar op√ß√£o se ainda presente
                                        const opt = filtroPacienteElem.querySelector(`option[value="${uid}"]`);
                                        if (opt) opt.textContent = window.pacientesNomes[uid];
                                    }
                                } catch (e) { /* ignore */ }
                            }
                        });
                    } else {
                        // esconder select para usu√°rios comuns
                        filtroPacienteElem.style.display = 'none';
                    }
                }
            } catch (e) { console.warn('Erro ao popular filtroPaciente', e); }

            if (registros.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üìù</div>
                        <p>Nenhum registro ainda.<br>Comece fazendo seu primeiro registro!</p>
                    </div>
                `;
                return;
            }

            // Ler valores atuais dos filtros (preservar sele√ß√£o entre renderiza√ß√µes)
            const storedFiltroEmocao = localStorage.getItem('filtroEmocao') || '';
            const storedFiltroMes = localStorage.getItem('filtroMes') || '';
            const storedFiltroDia = localStorage.getItem('filtroDia') || '';
            const storedFiltroAno = localStorage.getItem('filtroAno') || '';
            const storedFiltroTexto = localStorage.getItem('filtroTexto') || '';

            const filtroEmocaoAtual = (document.getElementById('filtroEmocao') && document.getElementById('filtroEmocao').value) || storedFiltroEmocao || '';
            const filtroMesAtual = (document.getElementById('filtroMes') && document.getElementById('filtroMes').value) || storedFiltroMes || '';
            const filtroDiaAtual = (document.getElementById('filtroDia') && document.getElementById('filtroDia').value) || storedFiltroDia || '';
            const filtroAnoAtual = (document.getElementById('filtroAno') && document.getElementById('filtroAno').value) || storedFiltroAno || '';
            const filtroTextoAtual = (document.getElementById('filtroTexto') && document.getElementById('filtroTexto').value) || storedFiltroTexto || '';

            // Construir op√ß√µes din√¢micas para filtros a partir dos registros
            const emocoesUnicas = Array.from(new Set(registros.map(r => (r.emocaoCentral || r.emocao || 'N√£o especificada'))));
            const anosUnicos = Array.from(new Set(registros.map(r => new Date(r.dataHora).getFullYear()))).sort((a,b) => b-a);
            const mesesUnicos = Array.from(new Set(registros.map(r => new Date(r.dataHora).getMonth()+1))).sort((a,b) => a-b);
            const diasUnicos = Array.from(new Set(registros.map(r => new Date(r.dataHora).getDate()))).sort((a,b) => a-b);

            const escapeHtml = (s) => (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;');

            const emocaoOptions = ['<option value="">Todas</option>'].concat(emocoesUnicas.map(e => `<option value="${escapeHtml(e)}" ${e===filtroEmocaoAtual? 'selected': ''}>${escapeHtml(e)}</option>`)).join('');
            const mesOptions = ['<option value="">Todos</option>'].concat(mesesUnicos.map(m => `<option value="${m}" ${m.toString()===filtroMesAtual? 'selected': ''}>${m.toString().padStart(2,'0')}</option>`)).join('');
            const diaOptions = ['<option value="">Todos</option>'].concat(diasUnicos.map(d => `<option value="${d}" ${d.toString()===filtroDiaAtual? 'selected': ''}>${d.toString().padStart(2,'0')}</option>`)).join('');
            const anoOptions = ['<option value="">Todos</option>'].concat(anosUnicos.map(y => `<option value="${y}" ${y.toString()===filtroAnoAtual? 'selected': ''}>${y}</option>`)).join('');

            // Popular os selects/inputs do header existente (se estiver presente no DOM)
            try {
                const elEmocao = document.getElementById('filtroEmocao');
                const elMes = document.getElementById('filtroMes');
                const elDia = document.getElementById('filtroDia');
                const elAno = document.getElementById('filtroAno');
                const elTexto = document.getElementById('filtroTexto');
                if (elEmocao) elEmocao.innerHTML = emocaoOptions;
                if (elMes) elMes.innerHTML = mesOptions;
                if (elDia) elDia.innerHTML = diaOptions;
                if (elAno) elAno.innerHTML = anoOptions;
                if (elTexto) elTexto.value = filtroTextoAtual || '';
            } catch (e) {
                console.warn('Erro ao popular filtros:', e);
            }

            // Aplicar filtros selecionados
            const filtroEmocao = filtroEmocaoAtual || '';
            const filtroMes = filtroMesAtual || '';
            const filtroDia = filtroDiaAtual || '';
            const filtroAno = filtroAnoAtual || '';
            const filtroTexto = (filtroTextoAtual && filtroTextoAtual.toLowerCase()) || '';

            const registrosFiltrados = registros.filter(r => {
                const emocao = (r.emocaoCentral || r.emocao || 'N√£o especificada');
                const data = new Date(r.dataHora);
                const mes = (data.getMonth()+1).toString();
                const dia = data.getDate().toString();
                const ano = data.getFullYear().toString();

                if (filtroEmocao && emocao !== filtroEmocao) return false;
                if (filtroMes && mes !== filtroMes) return false;
                if (filtroDia && dia !== filtroDia) return false;
                if (filtroAno && ano !== filtroAno) return false;

                if (filtroTexto) {
                    const s = (desanitizarTexto(r.situacao) || '').toLowerCase();
                    const p = (desanitizarTexto(r.pensamento) || '').toLowerCase();
                    const c = (desanitizarTexto(r.comportamento) || '').toLowerCase();
                    const e = (emocao || '').toLowerCase();
                    if (!(s.includes(filtroTexto) || p.includes(filtroTexto) || c.includes(filtroTexto) || e.includes(filtroTexto))) return false;
                }

                return true;
            });

            // Persistir sele√ß√£o de filtros no localStorage para pr√≥xima visita
            try {
                localStorage.setItem('filtroEmocao', filtroEmocao);
                localStorage.setItem('filtroMes', filtroMes);
                localStorage.setItem('filtroDia', filtroDia);
                localStorage.setItem('filtroAno', filtroAno);
                localStorage.setItem('filtroTexto', filtroTexto || '');
            } catch (e) {
                // Ignorar falhas de storage em ambientes restritos
            }

            lista.innerHTML = registrosFiltrados.map(r => {
                const data = new Date(r.dataHora);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                const horaFormatada = data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

                const emocao = r.emocaoCentral || r.emocao || 'N√£o especificada';
                const cor = emocoesCores[emocao] || '#667eea';
                const emojiEmocao = emocoesHierarquia[emocao]?.emoji || '‚ù§Ô∏è';

                // Desanitizar para exibi√ß√£o
                let situacaoExibir = desanitizarTexto(r.situacao);
                let pensamentoExibir = desanitizarTexto(r.pensamento);
                let comportamentoExibir = desanitizarTexto(r.comportamento);

                const pacienteNome = (window.pacientesNomes && r.uid && window.pacientesNomes[r.uid]) ? window.pacientesNomes[r.uid] : (r.uid || 'Desconhecido');
                const mostrarPaciente = (window.perfilAtual && (window.perfilAtual.role === 'psicologo' || window.perfilAtual.role === 'admin')) && (r.uid && r.uid !== (currentUser && currentUser.uid));
                return `
                    <div class="entry-card" data-id="${r.id}">
                        <div class="entry-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="registro-checkbox" data-id="${r.id}" checked style="width: 20px; height: 20px; cursor: pointer;">
                                <div class="entry-date">üìÖ ${dataFormatada} √†s ${horaFormatada}${mostrarPaciente ? ` <a href="#" onclick="mostrarPerfilPaciente('${r.uid}'); return false;" style="text-decoration:none;color:inherit;font-weight:700;margin-left:6px;">‚Äî ${escapeHtml(pacienteNome)}</a>` : ''}</div>
                            </div>
                            <div class="entry-actions">
                                <button class="icon-btn" onclick="deletarRegistro(${r.id})">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="entry-field">
                            <strong>Situa√ß√£o</strong>
                            <p>${situacaoExibir}</p>
                        </div>

                        <div class="entry-field">
                            <strong>Pensamento Autom√°tico</strong>
                            <p>${pensamentoExibir}</p>
                        </div>

                        <div class="entry-field">
                            <strong>Emo√ß√£o</strong>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <div style="background: ${cor}15; border: 2px solid ${cor}40; display: inline-flex; padding: 8px 12px; border-radius: 20px; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${emojiEmocao}</span>
                                    <span style="font-weight: bold; color: ${cor};">${emocao}</span>
                                    ${r.emocaoIntermediaria ? `<span>‚Üí ${r.emocaoIntermediaria}</span>` : ''}
                                    ${r.emocaoEspecifica ? `<span>‚Üí ${r.emocaoEspecifica}</span>` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-weight: bold; color: var(--primary); font-size: 18px;">
                                Intensidade: ${r.intensidade}/10
                            </div>
                        </div>

                        <div class="entry-field">
                            <strong>Comportamento</strong>
                            <p>${comportamentoExibir}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Atualizar contador ao carregar e ao mudar checkboxes
            atualizarContadorSelecionados();
            document.querySelectorAll('.registro-checkbox').forEach(cb => {
                cb.addEventListener('change', atualizarContadorSelecionados);
            });
        }

        function selecionarTodos() {
            document.querySelectorAll('.registro-checkbox').forEach(cb => cb.checked = true);
            atualizarContadorSelecionados();
        }

        function deselecionarTodos() {
            document.querySelectorAll('.registro-checkbox').forEach(cb => cb.checked = false);
            atualizarContadorSelecionados();
        }

        function atualizarContadorSelecionados() {
            const total = document.querySelectorAll('.registro-checkbox').length;
            const selecionados = document.querySelectorAll('.registro-checkbox:checked').length;
            const contador = document.getElementById('contadorSelecionados');
            if (contador) {
                contador.textContent = `${selecionados} de ${total} selecionados`;
            }
        }

        function deletarRegistro(id) {
            if (!confirm('Tem certeza que deseja deletar este registro?')) return;

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            // Encontrar o registro para pegar o firebaseId
            const registro = registrosEmMemoria.find(r => r.id === id);
            const firebaseId = registro?.firebaseId;

            if (!firebaseId) {
                mostrarToast('‚ö†Ô∏è Erro: registro sem ID do Firebase');
                return;
            }

            // Deletar APENAS do Firebase
            debugLog('‚òÅÔ∏è Excluindo registro do Firebase...', firebaseId);
            excluirRegistroFirebase(firebaseId).then(() => {
                // Remover da mem√≥ria
                registrosEmMemoria = registrosEmMemoria.filter(r => r.id !== id);
                debugLog('‚úÖ Registro exclu√≠do do Firebase!');
                carregarHistorico();
                atualizarEstatisticas();
                mostrarToast('üóëÔ∏è Registro deletado');
            }).catch(err => {
                console.error('‚ùå Erro ao excluir do Firebase:', err);
                mostrarToast('‚ùå Erro ao excluir');
            });
        }

        function atualizarEstatisticas() {
            let registros = getRegistros();
            try {
                const filtroPacienteElem = document.getElementById('filtroPaciente');
                const storedFiltroPaciente = localStorage.getItem('filtroPaciente') || '';
                const filtroPacienteAtual = (filtroPacienteElem && filtroPacienteElem.value) || storedFiltroPaciente || '';
                if (filtroPacienteAtual) registros = registros.filter(r => r.uid === filtroPacienteAtual);
            } catch (e) { /* ignore and fall back to full list */ }
            const total = registros.length;

            let somaIntensidade = 0;
            const contagemEmocoes = {};

            registros.forEach(r => {
                somaIntensidade += parseInt(r.intensidade);
                const emocao = r.emocaoCentral || r.emocao || 'N√£o especificada';
                contagemEmocoes[emocao] = (contagemEmocoes[emocao] || 0) + 1;
            });

            const mediaIntensidade = total > 0 ? (somaIntensidade / total).toFixed(1) : 0;
            const emocaoMaisFrequente = total > 0
                ? Object.keys(contagemEmocoes).reduce((a, b) => contagemEmocoes[a] > contagemEmocoes[b] ? a : b)
                : 'N/A';

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">REGISTROS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${mediaIntensidade}</div>
                    <div class="stat-label">INTENSIDADE M√âDIA</div>
                </div>
                <div class="stat-card" style="grid-column: 1 / -1;">
                    <div class="stat-value">${emocaoMaisFrequente}</div>
                    <div class="stat-label">EMO√á√ÉO MAIS FREQUENTE</div>
                </div>
            `;
        }

        function exportarPDF() {
            const registros = getRegistrosSelecionados();
            if (registros.length === 0) {
                mostrarToast('‚ö†Ô∏è Nenhum registro selecionado para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;
            const margemEsquerda = 15;
            const larguraPagina = 180;
            const alturaPagina = 280;

            // Cabe√ßalho simples
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('DIARIO EMOCIONAL - TCC', margemEsquerda, y);

            y += 8;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('KEITE FABIOLA - PSICOLOGA 04/58498', margemEsquerda, y);
            y += 5;
            doc.text('@PSIKEITEFABIOLA | (31) 9 8681-4865', margemEsquerda, y);
            y += 5;
            doc.text('Exportado em: ' + new Date().toLocaleString('pt-BR'), margemEsquerda, y);
            y += 10;

            doc.setLineWidth(0.5);
            doc.line(margemEsquerda, y, margemEsquerda + larguraPagina, y);
            y += 10;

            // Registros
            registros.forEach((reg, index) => {
                // Verificar se precisa de nova p√°gina
                if (y > alturaPagina - 40) {
                    doc.addPage();
                    y = 20;
                }

                // N√∫mero do registro
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Registro #' + (index + 1), margemEsquerda, y);
                y += 8;

                // Data/Hora
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Data/Hora:', margemEsquerda, y);
                doc.setFont('helvetica', 'normal');
                doc.text(new Date(reg.dataHora).toLocaleString('pt-BR'), margemEsquerda + 30, y);
                y += 7;

                // Situa√ß√£o
                doc.setFont('helvetica', 'bold');
                doc.text('Situacao:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                const situacaoText = desanitizarTexto(reg.situacao || '');
                const linhasSituacao = doc.splitTextToSize(situacaoText, larguraPagina);
                doc.text(linhasSituacao, margemEsquerda, y);
                y += (linhasSituacao.length * 5) + 2;

                // Pensamento
                if (y > alturaPagina - 30) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Pensamento Automatico:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                const pensamentoText = desanitizarTexto(reg.pensamento || '');
                const linhasPensamento = doc.splitTextToSize(pensamentoText, larguraPagina);
                doc.text(linhasPensamento, margemEsquerda, y);
                y += (linhasPensamento.length * 5) + 2;

                // Emo√ß√£o
                if (y > alturaPagina - 25) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Emocao:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                let textoEmocao = desanitizarTexto(reg.emocaoCentral || 'Nao especificada');
                if (reg.emocaoIntermediaria) textoEmocao += ' > ' + desanitizarTexto(reg.emocaoIntermediaria);
                if (reg.emocaoEspecifica) textoEmocao += ' > ' + desanitizarTexto(reg.emocaoEspecifica);
                doc.text(textoEmocao, margemEsquerda, y);
                y += 7;

                // Intensidade
                doc.setFont('helvetica', 'bold');
                doc.text('Intensidade:', margemEsquerda, y);
                doc.setFont('helvetica', 'normal');
                doc.text(reg.intensidade + '/10', margemEsquerda + 30, y);
                y += 7;

                // Comportamento
                if (y > alturaPagina - 25) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text('Comportamento:', margemEsquerda, y);
                y += 5;
                doc.setFont('helvetica', 'normal');
                const comportamentoText = desanitizarTexto(reg.comportamento || '');
                const linhasComportamento = doc.splitTextToSize(comportamentoText, larguraPagina);
                doc.text(linhasComportamento, margemEsquerda, y);
                y += (linhasComportamento.length * 5) + 8;

                // Linha separadora
                if (index < registros.length - 1) {
                    if (y > alturaPagina - 15) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setLineWidth(0.3);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margemEsquerda, y, margemEsquerda + larguraPagina, y);
                    y += 10;
                }
            });

            // Salvar PDF com timestamp no nome (YYYYMMDD_HHMMSS)
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const ts = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            const nomeArquivo = `registro_emocao_${ts}.pdf`;
            doc.save(nomeArquivo);
            mostrarToast('PDF baixado com sucesso!');
        }

        function exportarJSON() {
            const registros = getRegistrosSelecionados();
            if (registros.length === 0) {
                mostrarToast('‚ö†Ô∏è Nenhum registro selecionado');
                return;
            }
            const exportData = registros.map(r => ({
                ...r,
                situacao: desanitizarTexto(r.situacao || ''),
                pensamento: desanitizarTexto(r.pensamento || ''),
                comportamento: desanitizarTexto(r.comportamento || ''),
                emocaoCentral: desanitizarTexto(r.emocaoCentral || ''),
                emocaoIntermediaria: desanitizarTexto(r.emocaoIntermediaria || ''),
                emocaoEspecifica: desanitizarTexto(r.emocaoEspecifica || '')
            }));
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.json`);
            mostrarToast('üì• JSON baixado!');
        }

        function exportarCSV() {
            const registros = getRegistrosSelecionados();
            if (registros.length === 0) {
                mostrarToast('‚ö†Ô∏è Nenhum registro selecionado');
                return;
            }
            let csv = 'Data,Hora,Situa√ß√£o,Pensamento,Emo√ß√£o,Intensidade,Comportamento\n';

            registros.forEach(r => {
                const data = new Date(r.dataHora);
                let emocaoTexto = desanitizarTexto(r.emocaoCentral || '');
                if (r.emocaoIntermediaria) emocaoTexto += ' > ' + desanitizarTexto(r.emocaoIntermediaria);
                if (r.emocaoEspecifica) emocaoTexto += ' > ' + desanitizarTexto(r.emocaoEspecifica);

                const situacao = desanitizarTexto(r.situacao || '').replace(/"/g, '""');
                const pensamento = desanitizarTexto(r.pensamento || '').replace(/"/g, '""');
                const comportamento = desanitizarTexto(r.comportamento || '').replace(/"/g, '""');

                const linha = [
                    data.toLocaleDateString('pt-BR'),
                    data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                    `"${situacao}"`,
                    `"${pensamento}"`,
                    `"${emocaoTexto}"`,
                    r.intensidade,
                    `"${comportamento}"`
                ].join(',');
                csv += linha + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.csv`);
            mostrarToast('üì• CSV baixado!');
        }

        function exportarTexto() {
            const registros = getRegistrosSelecionados();
            if (registros.length === 0) {
                mostrarToast('‚ö†Ô∏è Nenhum registro selecionado');
                return;
            }
            let texto = 'DI√ÅRIO EMOCIONAL - REGISTRO TCC\n';
            texto += '='.repeat(50) + '\n\n';

            registros.forEach((r, i) => {
                const data = new Date(r.dataHora);
                texto += `REGISTRO ${i + 1}\n`;
                texto += `Data: ${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}\n\n`;
                texto += `SITUA√á√ÉO:\n${desanitizarTexto(r.situacao || '')}\n\n`;
                texto += `PENSAMENTO AUTOM√ÅTICO:\n${desanitizarTexto(r.pensamento || '')}\n\n`;
                texto += `EMO√á√ÉO:\n${desanitizarTexto(r.emocaoCentral || 'N√£o especificada')}`;
                if (r.emocaoIntermediaria) texto += ` ‚Üí ${r.emocaoIntermediaria}`;
                if (r.emocaoEspecifica) texto += ` ‚Üí ${r.emocaoEspecifica}`;
                texto += `\n\nINTENSIDADE: ${r.intensidade}/10\n\n`;
                texto += `COMPORTAMENTO:\n${desanitizarTexto(r.comportamento || '')}\n\n`;
                texto += '-'.repeat(50) + '\n\n';
            });

            const blob = new Blob([texto], { type: 'text/plain;charset=utf-8;' });
            baixarArquivo(blob, `diario-emocional-${new Date().toISOString().split('T')[0]}.txt`);
            mostrarToast('üì• TXT baixado!');
        }

        function baixarArquivo(blob, nomeArquivo) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function limparTodosDados() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai apagar TODOS os seus registros permanentemente do Firebase. Tem certeza?')) return;
            if (!confirm('√öltima confirma√ß√£o: Todos os dados ser√£o perdidos. Continuar?')) return;

            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                // Deletar todos do Firebase
                const batch = db.batch();
                const snapshot = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').get();

                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                registrosEmMemoria = [];

                carregarHistorico();
                atualizarEstatisticas();
                mostrarToast('üóëÔ∏è Todos os dados foram apagados');
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                mostrarToast('‚ùå Erro ao apagar dados');
            }
        }

        function mostrarToast(mensagem) {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.classList.add('show');

            // Remover toast anterior se existir
            clearTimeout(window.toastTimeout);

            // Agendar remo√ß√£o do toast ap√≥s 3 segundos
            window.toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ===== CONFIGURA√á√ÉO DO FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyDFAWCKSsA6zNY1zOieKtdqilwWjyj1Clo",
            authDomain: "diario-emocional-2c464.firebaseapp.com",
            projectId: "diario-emocional-2c464",
            storageBucket: "diario-emocional-2c464.firebasestorage.app",
            messagingSenderId: "306504477100",
            appId: "1:306504477100:web:655191303f79a95e13f209"
        };

        // Inicializar Firebase
        let app, auth, db;
        let isLoginMode = true;
        let currentUser = null;

        // Mostrar tela de login imediatamente se der erro
        function showLoginFallback() {
            debugLog('üîì Mostrando tela de login');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Tentar inicializar Firebase
        try {
            debugLog('üîÑ Tentando inicializar Firebase...');

            if (typeof firebase === 'undefined') {
                console.error('‚ùå Firebase n√£o dispon√≠vel');
                showLoginFallback();
            } else {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                debugLog('‚úÖ Firebase inicializado com sucesso');

                // Verificar autentica√ß√£o - onAuthStateChanged √© chamado imediatamente
                auth.onAuthStateChanged(async user => {
                    debugLog('üë§ Estado de autentica√ß√£o:', user ? 'Logado' : 'Deslogado');

                    // Garantir que esconde o loading
                    const loadingEl = document.getElementById('loadingScreen');
                    if (loadingEl) loadingEl.classList.add('hidden');

                    if (user) {
                        debugLog('‚úÖ Usu√°rio autenticado:', user.email);
                        currentUser = user;

                        // Carregar perfil do usu√°rio
                        let perfil = await carregarPerfilUsuario(user.uid);
                        window.perfilAtual = perfil;

                        // Se o perfil n√£o existir, criar um perfil b√°sico
                        if (!perfil) {
                            debugLog('‚ö†Ô∏è Perfil n√£o encontrado, criando perfil b√°sico...');
                            const perfilBasico = {
                                email: user.email,
                                nomeCompleto: user.displayName || user.email.split('@')[0],
                                role: 'user',
                                status: 'ativo',
                                criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                                ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            try {
                                await db.collection('usuarios').doc(user.uid).set(perfilBasico);
                                perfil = perfilBasico;
                                window.perfilAtual = perfil;
                                debugLog('‚úÖ Perfil b√°sico criado');
                            } catch (error) {
                                console.error('‚ùå Erro ao criar perfil b√°sico:', error);
                            }
                        } else {
                            // Atualizar √∫ltima atividade
                            try {
                                await db.collection('usuarios').doc(user.uid).update({
                                    ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                debugLog('‚úÖ √öltima atividade atualizada');
                                // Garantir que o perfil carregado esteja dispon√≠vel globalmente
                                window.perfilAtual = perfil;
                            } catch (error) {
                                console.error('‚ö†Ô∏è Erro ao atualizar √∫ltima atividade:', error);
                            }
                        }

                        // Monitorar mudan√ßas de permiss√£o em tempo real
                        let lastRole = perfil.role;
                        let lastStatus = perfil.status;
                        if (window.monitorUnsub) { window.monitorUnsub(); window.monitorUnsub = null; }
                        window.monitorUnsub = db.collection('usuarios').doc(user.uid)
                            .onSnapshot(function(doc) {
                                const perfilAtual = doc.data();
                                if (!perfilAtual) return;
                                // Se perdeu admin
                                if (lastRole === 'admin' && perfilAtual.role !== 'admin') {
                                    auth.signOut();
                                    showError('‚ùå Sua permiss√£o de administrador foi removida. Voc√™ foi desconectado.');
                                }
                                // Se status mudou para inativo
                                if (lastStatus !== 'inativo' && perfilAtual.status === 'inativo') {
                                    auth.signOut();
                                    showError('‚ùå Seu acesso foi desativado. Voc√™ foi desconectado.');
                                }
                                lastRole = perfilAtual.role;
                                lastStatus = perfilAtual.status;
                            });

                        // Atualizar informa√ß√µes do usu√°rio
                        const userName = document.getElementById('userName');
                        const userEmail = document.getElementById('userEmail');

                        if (perfil && perfil.nomeCompleto) {
                            if (userName) userName.textContent = perfil.nomeCompleto;
                        } else if (user.displayName) {
                            if (userName) userName.textContent = user.displayName;
                        } else {
                            if (userName) userName.textContent = user.email.split('@')[0];
                        }

                        if (userEmail) userEmail.textContent = user.email;

                        // Mostrar app imediatamente e carregar dados em background
                        setTimeout(() => {
                            if (!perfil || perfil.role !== 'admin') {
                                var navAdmin = document.getElementById('navAdmin');
                                var navConfig = document.getElementById('navConfig');
                                if (navAdmin) navAdmin.style.display = 'none';
                                if (navConfig) navConfig.style.display = 'none';
                            }
                        }, 100);
                        if (perfil && perfil.role === 'admin') {
                            var navAdmin = document.getElementById('navAdmin');
                            var navConfig = document.getElementById('navConfig');
                            if (navAdmin) { navAdmin.style.display = ''; navAdmin.style.visibility = 'visible'; }
                            if (navConfig) { navConfig.style.display = ''; navConfig.style.visibility = 'visible'; }
                        }
                        function tryShowAdminTabs() {
                            const navAdmin = document.getElementById('navAdmin');
                            const navConfig = document.getElementById('navConfig');
                            const adminTab = document.getElementById('adminTab');
                            const configTab = document.getElementById('configTab');
                            if (navAdmin && navConfig && adminTab && configTab) {
                                mostrarAbaConfigSeAdmin(perfil);
                                return true;
                            }
                            return false;
                        }
                        if (!tryShowAdminTabs()) {
                            const obs = new MutationObserver(() => {
                                if (tryShowAdminTabs()) {
                                    obs.disconnect();
                                }
                            });
                            obs.observe(document.body, { childList: true, subtree: true });
                        }
                        setTimeout(() => { mostrarAbaConfigSeAdmin(perfil); }, 500);
                        showApp();
                        carregarDadosFirebase().catch(err => console.warn('Erro ao carregar dados:', err));
                    } else {
                        debugLog('‚ùå Usu√°rio n√£o autenticado');
                        if (window.monitorUnsub) { window.monitorUnsub(); window.monitorUnsub = null; }
                        showLogin();
                    }
                });
            }
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Firebase:', error);
            showLoginFallback();
        }

        // Carregar perfil do usu√°rio do Firestore
        async function carregarPerfilUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const perfil = doc.data();
                    return perfil;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualizar sauda√ß√£o com nome do usu√°rio e per√≠odo do dia
        async function atualizarSaudacao() {
            const hora = new Date().getHours();
            let saudacao;

            if (hora >= 5 && hora < 12) {
                saudacao = 'üåÖ Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = '‚òÄÔ∏è Boa tarde';
            } else {
                saudacao = 'üåô Boa noite';
            }

            let nomeUsuario = 'Usu√°rio';

            // Tentar pegar o nome do perfil
            if (currentUser) {
                const perfil = await carregarPerfilUsuario(currentUser.uid);
                if (perfil && perfil.nomeCompleto) {
                    nomeUsuario = perfil.nomeCompleto.split(' ')[0]; // Primeiro nome
                } else if (currentUser.displayName) {
                    nomeUsuario = currentUser.displayName.split(' ')[0];
                } else if (currentUser.email) {
                    nomeUsuario = currentUser.email.split('@')[0];
                }
            }

            document.getElementById('greetingMessage').textContent = `${saudacao}, ${nomeUsuario}!`;
        }

        // Atualizar o badge/label de role no header e no perfil
        async function atualizarUserHeader() {
            try {
                const userRoleEl = document.getElementById('userRole');
                const profileRoleEl = document.getElementById('profileRole');
                const roleLabel = (r) => {
                    if (!r) return 'Usu√°rio';
                    if (r === 'admin') return 'Administrador';
                    if (r === 'psicologo' || r === 'psic√≥logo') return 'Psic√≥logo';
                    return 'Usu√°rio';
                };

                let role = (window.perfilAtual && window.perfilAtual.role) ? window.perfilAtual.role : null;
                if (!role && currentUser) {
                    const perfil = await carregarPerfilUsuario(currentUser.uid);
                    if (perfil) {
                        role = perfil.role;
                        window.perfilAtual = perfil;
                    }
                }
                if (userRoleEl) userRoleEl.textContent = `Perfil: ${roleLabel(role)}`;
                if (profileRoleEl) profileRoleEl.textContent = roleLabel(role);
            } catch (e) {
                console.warn('Erro ao atualizar header de usu√°rio:', e);
            }
        }

        // Atualizar data e hora em tempo real
        function atualizarDataHora() {
                // Primeiro tentar carregar do Firestore se usu√°rio autenticado
                if (typeof currentUser !== 'undefined' && currentUser && currentUser.uid && typeof db !== 'undefined') {
                    const uid = currentUser.uid;
                    db.collection('usuarios').doc(uid).collection('escalas').doc('ansiedadeWeekly').get()
                        .then(doc => {
                            if (doc.exists) {
                                const obj = doc.data();
                                (obj.dados || []).forEach(item => {
                                    const el = document.querySelector(`.ans-level[data-dia="${item.dia}"]`);
                                    const note = document.querySelector(`.ans-notes[data-dia="${item.dia}"]`);
                                    if (el) el.value = item.nivel;
                                    if (note) note.value = item.notas;
                                });
                                try { mostrarToast('‚úÖ Escala carregada do Firebase'); } catch(e) {}
                                return;
                            }
                            // Se n√£o existir no Firestore, tentar localStorage
                            const raw = localStorage.getItem(_escalaKey());
                            if (!raw) { try { mostrarToast('‚ÑπÔ∏è Nenhum dado salvo'); } catch(e) {} ; return; }
                            try { const obj = JSON.parse(raw); (obj.dados || []).forEach(item => { const el = document.querySelector(`.ans-level[data-dia="${item.dia}"]`); const note = document.querySelector(`.ans-notes[data-dia="${item.dia}"]`); if (el) el.value = item.nivel; if (note) note.value = item.notas; }); try { mostrarToast('‚úÖ Escala carregada localmente'); } catch(e) {} } catch(e){console.error(e);}
                        })
                        .catch(err => { console.error('Erro ao carregar escala do Firebase', err); try { mostrarToast('‚ùå Erro ao carregar do Firebase'); } catch(e) {}; });
                    return;
                }

                // Fallback localStorage
                const raw = localStorage.getItem(_escalaKey());
                if (!raw) { try { mostrarToast('‚ÑπÔ∏è Nenhum dado salvo'); } catch(e) {} ; return; }
                try {
                    const obj = JSON.parse(raw);
                    (obj.dados || []).forEach(item => {
                        const el = document.querySelector(`.ans-level[data-dia="${item.dia}"]`);
                        const note = document.querySelector(`.ans-notes[data-dia="${item.dia}"]`);
                        if (el) el.value = item.nivel;
                        if (note) note.value = item.notas;
                    });
                    try { mostrarToast('‚úÖ Escala carregada'); } catch(e) {}
                } catch (e) { console.error(e); }
            const themeIcon = document.getElementById('themeIcon');

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                if (themeIcon) themeIcon.textContent = 'üåô';
            }
        }

        function showApp() {
            if (isAdminUser) carregarConfiguracaoSessao();
            clearTimeout(sessionTimer);
            debugLog('üì± Mostrando app...');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('active');

            // IMPORTANTE: Esconder aba admin por padr√£o (s√≥ mostra se for admin)
            document.getElementById('adminTab').style.display = 'none';

            // N√£o limpar `window.perfilAtual` aqui; manter perfil carregado na autentica√ß√£o

            // Inicializar app imediatamente
            inicializarApp();
            atualizarSaudacao();
            atualizarDataHora();
            // Atualizar exibi√ß√£o do role no header/perfil
            atualizarUserHeader();
            debugLog('‚úÖ App inicializado!');
        }

        function showLogin() {
            debugLog('üîê Mostrando tela de login...');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('active');
        }

        function showError(message) {
            let toast = document.getElementById('toastMsg');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastMsg';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            toast.innerHTML = '<span class="material-icons">error_outline</span>' + message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const buttonText = document.getElementById('authButtonText');
            const toggleText = document.getElementById('toggleText');
            const toggleLink = document.getElementById('toggleLink');
            const signupFields = document.getElementById('signupFields');
            const termsCheckbox = document.getElementById('termsCheckbox');

            if (isLoginMode) {
                buttonText.textContent = 'Entrar';
                toggleText.textContent = 'N√£o tem conta?';
                toggleLink.textContent = 'Criar conta';
                signupFields.classList.add('hidden');
                termsCheckbox.classList.add('hidden');
            } else {
                buttonText.textContent = 'Criar Conta';
                toggleText.textContent = 'J√° tem conta?';
                toggleLink.textContent = 'Fazer login';
                signupFields.classList.remove('hidden');
                termsCheckbox.classList.remove('hidden');
            }
        }

        async function handleEmailAuth() {

            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            // Limite de tentativas de login
            if (isLoginMode) {
                const attempts = getLoginAttempts(email);
                const now = Date.now();
                if (attempts.blockedUntil && now < attempts.blockedUntil) {
                    const min = Math.ceil((attempts.blockedUntil - now) / 60000);
                    showError(`Muitas tentativas. Tente novamente em ${min} min.`);
                    return;
                }
            }

            debugLog('üîë Tentando autenticar...', { email, mode: isLoginMode ? 'login' : 'criar' });

            if (!email || !password) {
                showError('Preencha email e senha');
                return;
            }

            if (password.length < 6) {
                showError('Senha deve ter no m√≠nimo 6 caracteres');
                return;
            }

            // Se for cadastro, validar campos extras
            if (!isLoginMode) {
                const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
                const acceptTerms = document.getElementById('acceptTerms').checked;

                if (!nomeCompleto) {
                    showError('Preencha seu nome completo');
                    return;
                }

                if (!acceptTerms) {
                    showError('Voc√™ precisa aceitar os termos de uso');
                    return;
                }
            }

            try {
                // Garantir persist√™ncia LOCAL antes de fazer login
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                debugLog('üîí Persist√™ncia LOCAL ativada');

                if (isLoginMode) {
                    debugLog('üìß Fazendo login...');
                    const result = await auth.signInWithEmailAndPassword(email, password);
                    debugLog('‚úÖ Login realizado:', result.user.email);

                    // Resetar tentativas ao logar com sucesso
                    setLoginAttempts(email, { count: 0, lastFail: 0, blockedUntil: 0 });

                    // Verificar se usu√°rio est√° ativo
                    const perfilDoc = await db.collection('usuarios').doc(result.user.uid).get();
                    if (perfilDoc.exists) {
                        const perfil = perfilDoc.data();
                        if (perfil.status === 'inativo') {
                            // Fazer logout imediatamente
                            await auth.signOut();
                            showError('‚ùå Sua conta est√° inativa. Entre em contato com o administrador.');
                            return;
                        }
                    }
                } else {
                    debugLog('üìù Criando conta...');
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    debugLog('‚úÖ Conta criada:', result.user.email);

                    // Salvar informa√ß√µes adicionais do usu√°rio
                    await salvarPerfilUsuario(result.user.uid);
                }

                // onAuthStateChanged vai chamar showApp() automaticamente
            } catch (error) {
                // Limitar tentativas de login
                if (isLoginMode) {
                    let attempts = getLoginAttempts(email);
                    attempts.count = (attempts.count || 0) + 1;
                    attempts.lastFail = Date.now();
                    if (attempts.count >= MAX_LOGIN_ATTEMPTS) {
                        attempts.blockedUntil = Date.now() + LOGIN_BLOCK_MINUTES * 60000;
                    }
                    setLoginAttempts(email, attempts);
                }
                console.error('‚ùå Erro completo:', error);
                console.error('C√≥digo:', error.code);
                console.error('Mensagem:', error.message);

                const messages = {
                    'auth/email-already-in-use': 'Email j√° cadastrado',
                    'auth/invalid-email': 'Email inv√°lido',
                    'auth/user-not-found': 'Usu√°rio n√£o encontrado',
                    'auth/wrong-password': 'Senha incorreta',
                    'auth/weak-password': 'Senha muito fraca',
                    'auth/network-request-failed': 'Erro de conex√£o',
                    'auth/operation-not-allowed': '‚ö†Ô∏è Configure Authentication no Firebase Console',
                    'auth/unauthorized-domain': '‚ö†Ô∏è Adicione "localhost" nos dom√≠nios autorizados do Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains'
                };

                let errorMsg = messages[error.code] || error.message || 'Erro ao autenticar';

                // Se for 400, pode ser dom√≠nio n√£o autorizado
                if (!error.code && error.message && error.message.includes('400')) {
                    errorMsg = '‚ö†Ô∏è ERRO 400: Verifique no Firebase Console:\n' +
                               '1. Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí Adicione "localhost"\n' +
                               '2. Ou teste usando o authDomain: diario-emocional-2c464.firebaseapp.com';
                    console.error('üí° Solu√ß√£o: Adicione localhost nos dom√≠nios autorizados ou teste via Firebase Hosting');
                }

                showError(errorMsg);
            }
        }

        async function handleGoogleAuth() {
            try {
                // Garantir persist√™ncia LOCAL antes de fazer login
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                debugLog('üîí Persist√™ncia LOCAL ativada (Google)');

                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Erro Google:', error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showError('Erro ao fazer login com Google');
                }
            }
        }

        // Salvar perfil do usu√°rio no Firestore
        async function salvarPerfilUsuario(uid) {
            try {
                const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
                const dataNascimento = document.getElementById('dataNascimento').value;
                const genero = document.getElementById('genero').value;

                const perfil = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    email: currentUser?.email || auth.currentUser?.email,
                    role: 'user', // Novo usu√°rio sempre come√ßa como 'user'
                    status: 'ativo',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimaAtividade: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('usuarios').doc(uid).set(perfil);

                // Atualizar displayName no Authentication
                if (auth.currentUser) {
                    await auth.currentUser.updateProfile({
                        displayName: nomeCompleto
                    });
                }

                debugLog('‚úÖ Perfil do usu√°rio salvo com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao salvar perfil:', error);
                // N√£o bloquear o cadastro por falha ao salvar perfil
            }
        }

        // Carregar perfil do usu√°rio do Firestore
        async function carregarPerfilUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    const perfil = doc.data();
                    return perfil;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualizar sauda√ß√£o com nome do usu√°rio e per√≠odo do dia
        async function atualizarSaudacao() {
            const hora = new Date().getHours();
            let saudacao;

            if (hora >= 5 && hora < 12) {
                saudacao = 'üåÖ Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = '‚òÄÔ∏è Boa tarde';
            } else {
                saudacao = 'üåô Boa noite';
            }

            let nomeUsuario = 'Usu√°rio';

            // Tentar pegar o nome do perfil
            if (currentUser) {
                const perfil = await carregarPerfilUsuario(currentUser.uid);
                if (perfil && perfil.nomeCompleto) {
                    nomeUsuario = perfil.nomeCompleto.split(' ')[0]; // Primeiro nome
                } else if (currentUser.displayName) {
                    nomeUsuario = currentUser.displayName.split(' ')[0];
                } else if (currentUser.email) {
                    nomeUsuario = currentUser.email.split('@')[0];
                }
            }

            document.getElementById('greetingMessage').textContent = `${saudacao}, ${nomeUsuario}!`;
        }

        // Atualizar data e hora em tempo real
        function atualizarDataHora() {
            const atualizar = () => {
                const agora = new Date();
                const opcoes = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dataFormatada = agora.toLocaleDateString('pt-BR', opcoes);
                document.getElementById('currentDateTime').textContent = dataFormatada;
            };

            atualizar();
            // Atualizar a cada minuto
            setInterval(atualizar, 60000);
        }

        // Mostrar termos de uso
        function mostrarTermos() {
            alert('TERMOS DE USO\n\n' +
                '1. Este aplicativo √© um di√°rio pessoal para registros emocionais.\n' +
                '2. Seus dados s√£o privados e armazenados apenas na sua conta.\n' +
                '3. Apenas voc√™ tem acesso aos seus registros.\n' +
                '4. N√£o compartilhamos seus dados com terceiros.\n' +
                '5. Voc√™ pode excluir sua conta e dados a qualquer momento.\n' +
                '6. Este app n√£o substitui tratamento psicol√≥gico profissional.');
        }

        function mostrarPrivacidade() {
            alert('POL√çTICA DE PRIVACIDADE\n\n' +
                '1. Coletamos: email, nome e dados emocionais que voc√™ registra.\n' +
                '2. Uso: Apenas para funcionamento do aplicativo.\n' +
                '3. Armazenamento: Firebase (Google Cloud).\n' +
                '4. Compartilhamento: N√£o compartilhamos com terceiros.\n' +
                '5. Seus direitos: Acesso, corre√ß√£o e exclus√£o dos seus dados.\n' +
                '6. Seguran√ßa: Autentica√ß√£o, regras de seguran√ßa e isolamento de dados.\n' +
                '7. Contato: Para d√∫vidas sobre privacidade, entre em contato.');
        }

        async function handleLogout() {
            if (!confirm('Deseja realmente sair?')) return;

            try {
                debugLog('üö™ Fazendo logout...');

                if (auth) {
                    await auth.signOut();
                    debugLog('‚úÖ Logout realizado com sucesso');
                }

                // Limpar dados da mem√≥ria por seguran√ßa
                registrosEmMemoria = [];
                currentUser = null;
                window.perfilAtual = null;

                // Esconder aba admin
                document.getElementById('adminTab').style.display = 'none';

                showLogin();

            } catch (error) {
                console.error('‚ùå Erro ao sair:', error);
                registrosEmMemoria = [];
                currentUser = null;
                window.perfilAtual = null;
                document.getElementById('adminTab').style.display = 'none';
                showLogin();
            }
        }

        // ===== FUN√á√ïES DE PERFIL =====

        // Carregar perfil do usu√°rio na tela
        async function carregarPerfilUsuarioNaTela() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const perfil = await carregarPerfilUsuario(currentUser.uid);

                document.getElementById('profileName').textContent = perfil?.nomeCompleto || currentUser.displayName || 'N√£o informado';
                document.getElementById('profileEmail').textContent = currentUser.email || 'N√£o informado';

                if (perfil?.dataNascimento) {
                    // Converter data sem problemas de timezone
                    const [ano, mes, dia] = perfil.dataNascimento.split('-');
                    const data = new Date(ano, mes - 1, dia);
                    document.getElementById('profileBirthdate').textContent = data.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById('profileBirthdate').textContent = 'N√£o informado';
                }

                const generos = {
                    'masculino': 'Masculino',
                    'feminino': 'Feminino',
                    'outro': 'Outro',
                    'prefiro-nao-dizer': 'Prefiro n√£o dizer'
                };
                document.getElementById('profileGender').textContent = generos[perfil?.genero] || 'N√£o informado';

                if (currentUser.metadata?.creationTime) {
                    const dataCriacao = new Date(currentUser.metadata.creationTime);
                    document.getElementById('profileSince').textContent = dataCriacao.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById('profileSince').textContent = 'N√£o dispon√≠vel';
                }

                // Armazenar dados do perfil para edi√ß√£o COM O UID DO USU√ÅRIO
                window.perfilAtual = {
                    ...perfil,
                    uid: currentUser.uid,
                    email: currentUser.email
                };

                // Atualizar header/profile com role
                atualizarUserHeader();

                debugLog('‚úÖ Perfil carregado para usu√°rio:', currentUser.email, 'UID:', currentUser.uid);
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                mostrarToast('‚ùå Erro ao carregar perfil');
            }
        }

        // Habilitar modo de edi√ß√£o do perfil
        function habilitarEdicaoPerfil() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            debugLog('üîç Tentando editar perfil. CurrentUser:', currentUser.email, currentUser.uid);
            debugLog('üîç PerfilAtual:', window.perfilAtual);

            // Validar que o perfilAtual pertence ao usu√°rio logado
            if (window.perfilAtual && window.perfilAtual.uid && window.perfilAtual.uid !== currentUser.uid) {
                console.error('‚ö†Ô∏è SEGURAN√áA: Tentativa de editar perfil de outro usu√°rio!');
                console.error('   CurrentUser UID:', currentUser.uid);
                console.error('   PerfilAtual UID:', window.perfilAtual.uid);
                mostrarToast('‚ùå Erro de seguran√ßa detectado. Recarregando perfil...');
                window.perfilAtual = null; // Limpar dados incorretos
                carregarPerfilUsuarioNaTela(); // Recarregar perfil correto
                return;
            }

            // Se n√£o tem perfilAtual ou n√£o tem UID, recarregar
            if (!window.perfilAtual || !window.perfilAtual.uid) {
                console.warn('‚ö†Ô∏è PerfilAtual inv√°lido ou sem UID. Recarregando...');
                carregarPerfilUsuarioNaTela();
                return;
            }

            // Preencher campos de edi√ß√£o com dados atuais DO USU√ÅRIO LOGADO
            const perfil = window.perfilAtual || {};

            document.getElementById('editNomeCompleto').value = perfil.nomeCompleto || currentUser?.displayName || '';
            document.getElementById('editEmail').value = currentUser?.email || '';
            document.getElementById('editDataNascimento').value = perfil.dataNascimento || '';
            document.getElementById('editGenero').value = perfil.genero || '';

            debugLog('‚úÖ Modo de edi√ß√£o habilitado para:', currentUser.email);

            // Alternar visualiza√ß√£o
            document.getElementById('profileViewMode').style.display = 'none';
            document.getElementById('profileEditMode').style.display = 'block';

            // Alternar bot√µes
            document.getElementById('btnEditProfile').style.display = 'none';
            document.getElementById('btnCancelEdit').style.display = 'inline-block';
            document.getElementById('btnSaveProfile').style.display = 'inline-block';
        }

        // Mostrar perfil de outro paciente (apenas visualiza√ß√£o)
        async function mostrarPerfilPaciente(uid) {
            try {
                const perfil = await carregarPerfilUsuario(uid);
                if (!perfil) {
                    mostrarToast('‚ö†Ô∏è Perfil n√£o encontrado');
                    return;
                }
                // Popular visualiza√ß√£o do perfil com dados do paciente
                document.getElementById('profileName').textContent = perfil.nomeCompleto || perfil.nome || 'N√£o informado';
                document.getElementById('profileEmail').textContent = perfil.email || 'N√£o informado';
                if (perfil.dataNascimento) {
                    const [ano, mes, dia] = perfil.dataNascimento.split('-');
                    const data = new Date(ano, mes - 1, dia);
                    document.getElementById('profileBirthdate').textContent = data.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById('profileBirthdate').textContent = 'N√£o informado';
                }
                const generos = {
                    'masculino': 'Masculino', 'feminino': 'Feminino', 'outro': 'Outro', 'prefiro-nao-dizer': 'Prefiro n√£o dizer'
                };
                document.getElementById('profileGender').textContent = generos[perfil.genero] || 'N√£o informado';
                document.getElementById('profileSince').textContent = perfil.criadoEm ? (perfil.criadoEm.toDate().toLocaleDateString('pt-BR')) : 'N√£o dispon√≠vel';

                // Definir perfilVisualizado (n√£o sobrescrever perfilAtual do usu√°rio logado)
                window.perfilVisualizado = { ...perfil, uid };
                // Ocultar bot√µes de edi√ß√£o quando visualizando outro usu√°rio
                const btnEdit = document.getElementById('btnEditProfile');
                if (btnEdit) btnEdit.style.display = 'none';

                // Atualizar campo de role no perfil visualizado
                const profileRoleEl = document.getElementById('profileRole');
                if (profileRoleEl) profileRoleEl.textContent = perfil.role ? (perfil.role === 'admin' ? 'Administrador' : (perfil.role === 'psicologo' ? 'Psic√≥logo' : 'Usu√°rio')) : 'Usu√°rio';

                // Mostrar aba de perfil em modo visualiza√ß√£o
                document.getElementById('profileViewMode').style.display = 'block';
                document.getElementById('profileEditMode').style.display = 'none';
                showTab('perfil');
            } catch (e) {
                console.error('Erro ao mostrar perfil do paciente', e);
                mostrarToast('‚ùå Erro ao carregar perfil');
            }
        }

        // Cancelar edi√ß√£o do perfil
        function cancelarEdicaoPerfil() {
            // Voltar para modo visualiza√ß√£o
            document.getElementById('profileViewMode').style.display = 'block';
            document.getElementById('profileEditMode').style.display = 'none';

            // Alternar bot√µes
            document.getElementById('btnEditProfile').style.display = 'inline-block';
            document.getElementById('btnCancelEdit').style.display = 'none';
            document.getElementById('btnSaveProfile').style.display = 'none';
        }

        // Salvar edi√ß√µes do perfil
        async function salvarEdicaoPerfil() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const nomeCompleto = document.getElementById('editNomeCompleto').value.trim();
                const dataNascimento = document.getElementById('editDataNascimento').value;
                const genero = document.getElementById('editGenero').value;

                // Valida√ß√£o
                if (!nomeCompleto) {
                    mostrarToast('‚ö†Ô∏è O nome completo √© obrigat√≥rio');
                    return;
                }

                debugLog('üìù Atualizando perfil...');

                // Carregar perfil atual para preservar o role
                const perfilAtual = await carregarPerfilUsuario(currentUser.uid);

                // Atualizar no Firestore (usando set com merge para criar se n√£o existir)
                const perfilAtualizado = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    email: currentUser.email,
                    role: perfilAtual?.role || 'user', // Preservar role existente ou usar 'user' como padr√£o
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Usar set com merge para criar o documento se n√£o existir
                await db.collection('usuarios').doc(currentUser.uid).set(perfilAtualizado, { merge: true });

                // Atualizar displayName no Authentication
                if (currentUser) {
                    await currentUser.updateProfile({
                        displayName: nomeCompleto
                    });
                }

                debugLog('‚úÖ Perfil atualizado com sucesso');
                mostrarToast('‚úÖ Perfil atualizado com sucesso!');

                // Recarregar perfil na tela
                await carregarPerfilUsuarioNaTela();

                // Voltar para modo visualiza√ß√£o
                cancelarEdicaoPerfil();

                // Atualizar sauda√ß√£o se o nome mudou
                atualizarSaudacao();

            } catch (error) {
                console.error('‚ùå Erro ao atualizar perfil:', error);
                mostrarToast('‚ùå Erro ao atualizar perfil: ' + error.message);
            }
        }

        // Confirmar exclus√£o da conta
        function confirmarExclusaoConta() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o √© IRREVERS√çVEL!\n\nTodos os seus dados (perfil e registros emocionais) ser√£o permanentemente exclu√≠dos.\n\nDeseja realmente excluir sua conta?')) {
                if (confirm('√öltima confirma√ß√£o: Tem certeza absoluta?')) {
                    excluirMinhaConta();
                }
            }
        }

        // Excluir conta do usu√°rio
        async function excluirMinhaConta() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                debugLog('üóëÔ∏è Excluindo conta...');
                const uid = currentUser.uid;

                // 1. Deletar todos os registros do usu√°rio
                const registrosRef = db.collection('usuarios').doc(uid).collection('registros');
                const snapshot = await registrosRef.get();

                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                debugLog('‚úÖ Registros exclu√≠dos');

                // 2. Deletar perfil do usu√°rio
                await db.collection('usuarios').doc(uid).delete();
                debugLog('‚úÖ Perfil exclu√≠do');

                // 3. Deletar conta do Firebase Auth
                await currentUser.delete();
                debugLog('‚úÖ Conta exclu√≠da do Firebase Auth');

                // Limpar dados locais
                registrosEmMemoria = [];
                currentUser = null;

                alert('‚úÖ Sua conta foi exclu√≠da com sucesso. Sentiremos sua falta!');
                showLogin();

            } catch (error) {
                console.error('‚ùå Erro ao excluir conta:', error);

                if (error.code === 'auth/requires-recent-login') {
                    alert('‚ö†Ô∏è Por seguran√ßa, voc√™ precisa fazer login novamente antes de excluir sua conta.\n\nFa√ßa logout e login novamente, depois tente excluir.');
                } else {
                    mostrarToast('‚ùå Erro ao excluir conta: ' + error.message);
                }
            }
        }

        // ===== FUN√á√ïES ADMINISTRATIVAS =====

        // Verificar se usu√°rio √© admin
        async function verificarAdmin() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                // Buscar role do usu√°rio no Firestore
                const doc = await db.collection('usuarios').doc(currentUser.uid).get();

                if (!doc.exists) {
                    mostrarToast('‚ö†Ô∏è Perfil n√£o encontrado');
                    showTab('novo', null);
                    return;
                }

                const perfil = doc.data();
                const isAdmin = perfil.role === 'admin';

                if (isAdmin) {
                    document.getElementById('adminTab').style.display = 'block';
                } else {
                    mostrarToast('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o de administrador');
                    showTab('novo', null);
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar admin:', error);
            }
        }

        // Verificar se usu√°rio √© admin (sem mensagem de erro)
        async function verificarAdminSilencioso() {
            if (!currentUser) return;

            try {
                // Buscar role do usu√°rio no Firestore
                const doc = await db.collection('usuarios').doc(currentUser.uid).get();

                if (!doc.exists) return;

                const perfil = doc.data();
                const isAdmin = perfil.role === 'admin';

                if (isAdmin) {
                    document.getElementById('adminTab').style.display = 'block';
                    // Carregar dashboard automaticamente
                    carregarDashboardAdmin();
                    debugLog('‚úÖ Usu√°rio √© admin - aba administrativa habilitada');
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar admin:', error);
            }
        }

        // ===== DASHBOARD ADMINISTRATIVO =====

        // Carregar estat√≠sticas do dashboard
        async function carregarDashboardAdmin() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                debugLog('üìä Carregando dashboard administrativo...');

                // Buscar todos os usu√°rios
                const usuariosSnapshot = await db.collection('usuarios').get();
                const totalUsuarios = usuariosSnapshot.size;

                // Calcular usu√°rios ativos (√∫ltimos 7 dias)
                const seteDiasAtras = new Date();
                seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);

                let usuariosAtivos = 0;
                let usuariosInativos = 0;
                let totalRegistros = 0;

                // Processar cada usu√°rio
                for (const userDoc of usuariosSnapshot.docs) {
                    const userData = userDoc.data();

                    // Verificar status
                    if (userData.status === 'inativo') {
                        usuariosInativos++;
                    }

                    // Verificar √∫ltima atividade
                    if (userData.ultimaAtividade) {
                        const ultimaAtividade = userData.ultimaAtividade.toDate();
                        if (ultimaAtividade >= seteDiasAtras) {
                            usuariosAtivos++;
                        }
                    }

                    // Contar registros do usu√°rio
                    const registrosSnapshot = await db.collection('usuarios')
                        .doc(userDoc.id)
                        .collection('registros')
                        .get();
                    totalRegistros += registrosSnapshot.size;
                }

                // Atualizar interface
                document.getElementById('totalUsuarios').textContent = totalUsuarios;
                document.getElementById('usuariosAtivos').textContent = usuariosAtivos;
                document.getElementById('totalRegistros').textContent = totalRegistros;
                document.getElementById('usuariosInativos').textContent = usuariosInativos;

                debugLog('‚úÖ Dashboard carregado:', {
                    total: totalUsuarios,
                    ativos: usuariosAtivos,
                    registros: totalRegistros,
                    inativos: usuariosInativos
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                mostrarToast('‚ùå Erro ao carregar estat√≠sticas');
            }
        }

        // Carregar lista de usu√°rios (admin)
        async function carregarListaUsuarios() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                debugLog('üìã Carregando lista de usu√°rios...');
                const usuariosRef = db.collection('usuarios');
                const snapshot = await usuariosRef.get();

                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';

                if (snapshot.empty) {
                    usersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum usu√°rio cadastrado</p>';
                    return;
                }

                const usuarios = [];

                // Buscar usu√°rios e contar seus registros
                for (const doc of snapshot.docs) {
                    const userData = doc.data();

                    // Contar registros do usu√°rio
                    const registrosSnapshot = await db.collection('usuarios')
                        .doc(doc.id)
                        .collection('registros')
                        .get();

                    usuarios.push({
                        uid: doc.id,
                        ...userData,
                        totalRegistros: registrosSnapshot.size
                    });
                }

                // Ordenar por data de cria√ß√£o (mais recentes primeiro)
                usuarios.sort((a, b) => {
                    const dateA = a.criadoEm?.toDate() || new Date(0);
                    const dateB = b.criadoEm?.toDate() || new Date(0);
                    return dateB - dateA;
                });

                usuarios.forEach(usuario => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';

                    const dataCriacao = usuario.criadoEm?.toDate()
                        ? usuario.criadoEm.toDate().toLocaleDateString('pt-BR')
                        : 'Data desconhecida';

                    // Formatar √∫ltima atividade
                    let ultimaAtividadeTexto = 'Nunca';
                    if (usuario.ultimaAtividade) {
                        const dataAtividade = usuario.ultimaAtividade.toDate();
                        const diasAtras = Math.floor((new Date() - dataAtividade) / (1000 * 60 * 60 * 24));
                        if (diasAtras === 0) {
                            ultimaAtividadeTexto = 'Hoje';
                        } else if (diasAtras === 1) {
                            ultimaAtividadeTexto = 'Ontem';
                        } else if (diasAtras < 7) {
                            ultimaAtividadeTexto = `${diasAtras} dias atr√°s`;
                        } else if (diasAtras < 30) {
                            ultimaAtividadeTexto = `${Math.floor(diasAtras / 7)} semanas atr√°s`;
                        } else {
                            ultimaAtividadeTexto = dataAtividade.toLocaleDateString('pt-BR');
                        }
                    }

                    // Badge de role
                    const roleBadge = usuario.role === 'admin'
                        ? '<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">üîê ADMIN</span>'
                        : '';

                    // Badge de status
                    const statusBadge = usuario.status === 'inativo'
                        ? '<span style="background: #e74c3c; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">üö´ INATIVO</span>'
                        : '<span style="background: #27ae60; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">‚úÖ ATIVO</span>';

                    userItem.innerHTML = `
                        <div class="user-item-info">
                            <div class="user-item-name">
                                ${usuario.nomeCompleto || 'Nome n√£o informado'}
                                ${roleBadge}
                                ${statusBadge}
                            </div>
                            <div class="user-item-email">${usuario.email || 'Email n√£o informado'}</div>
                            <div class="user-item-email">
                                üìÖ Membro desde: ${dataCriacao} |
                                üïí √öltima atividade: ${ultimaAtividadeTexto} |
                                üìù ${usuario.totalRegistros} registro(s)
                            </div>
                        </div>
                        <div class="user-item-actions">
                            <button class="btn-delete-user" style="background: var(--primary);" onclick="editarUsuarioAdmin('${usuario.uid}')">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn-delete-user" onclick="excluirUsuarioAdmin('${usuario.uid}', '${usuario.email}')">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    `;

                    usersList.appendChild(userItem);
                });

                mostrarToast(`‚úÖ ${usuarios.length} usu√°rio(s) carregado(s)`);

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                mostrarToast('‚ùå Erro ao carregar usu√°rios');
            }
        }

        // Excluir usu√°rio (admin)
        async function excluirUsuarioAdmin(uid, email) {
            if (!confirm(`‚ö†Ô∏è Deseja realmente excluir o usu√°rio:\n\n${email}\n\nTodos os dados ser√£o permanentemente removidos!`)) {
                return;
            }

            try {
                debugLog('üóëÔ∏è Excluindo usu√°rio:', uid);

                // 1. Deletar todos os registros do usu√°rio
                const registrosRef = db.collection('usuarios').doc(uid).collection('registros');
                const snapshot = await registrosRef.get();

                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                debugLog('‚úÖ Registros do usu√°rio exclu√≠dos');

                // 2. Deletar perfil do usu√°rio
                await db.collection('usuarios').doc(uid).delete();
                debugLog('‚úÖ Perfil do usu√°rio exclu√≠do');

                // NOTA: N√£o podemos deletar a conta do Firebase Auth pelo lado do cliente
                // Isso requer Firebase Admin SDK no servidor
                debugLog('‚ö†Ô∏è IMPORTANTE: A conta no Firebase Auth n√£o foi removida.');
                debugLog('   Para remover completamente, use o Console do Firebase ou Admin SDK');

                mostrarToast('‚úÖ Dados do usu√°rio exclu√≠dos do Firestore');

                // Recarregar lista
                carregarListaUsuarios();

            } catch (error) {
                console.error('‚ùå Erro ao excluir usu√°rio:', error);
                mostrarToast('‚ùå Erro ao excluir usu√°rio');
            }
        }

        // Mostrar formul√°rio de novo usu√°rio
        function mostrarFormularioNovoUsuario() {
            document.getElementById('novoUsuarioForm').style.display = 'block';
            // Limpar campos
            document.getElementById('novoNomeCompleto').value = '';
            document.getElementById('novoEmail').value = '';
            document.getElementById('novoSenha').value = '';
            document.getElementById('novoDataNascimento').value = '';
            document.getElementById('novoGenero').value = '';

            // Scroll at√© o formul√°rio
            document.getElementById('novoUsuarioForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Ocultar formul√°rio de novo usu√°rio
        function ocultarFormularioNovoUsuario() {
            document.getElementById('novoUsuarioForm').style.display = 'none';
        }

        // Criar novo usu√°rio (admin)
        async function criarNovoUsuario() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const nomeCompleto = document.getElementById('novoNomeCompleto').value.trim();
                const email = document.getElementById('novoEmail').value.trim();
                const senha = document.getElementById('novoSenha').value;
                const dataNascimento = document.getElementById('novoDataNascimento').value;
                const genero = document.getElementById('novoGenero').value;
                const role = document.getElementById('novoRole').value;

                // Valida√ß√£o
                if (!nomeCompleto || !email || !senha) {
                    mostrarToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios (Nome, Email e Senha)');
                    return;
                }

                if (senha.length < 6) {
                    mostrarToast('‚ö†Ô∏è A senha deve ter no m√≠nimo 6 caracteres');
                    return;
                }

                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    mostrarToast('‚ö†Ô∏è Email inv√°lido');
                    return;
                }

                debugLog('üë§ Criando novo usu√°rio...');

                // IMPORTANTE: Como admin n√£o pode criar usu√°rios diretamente no Firebase Auth do lado do cliente,
                // vamos criar apenas o perfil no Firestore
                // O usu√°rio ter√° que se registrar normalmente na primeira vez

                // Gerar um ID √∫nico para o novo usu√°rio (tempor√°rio at√© ele se registrar)
                const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                const perfil = {
                    nomeCompleto,
                    email,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    role: role || 'user',
                    status: 'ativo',
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    criadoPorAdmin: true,
                    senhaTemporaria: senha, // Apenas para refer√™ncia do admin
                    aguardandoPrimeiroLogin: true
                };

                await db.collection('usuarios').doc(tempUserId).set(perfil);

                debugLog('‚úÖ Perfil criado com sucesso');

                alert(`‚úÖ Usu√°rio criado com sucesso!\n\nInforme ao usu√°rio:\n\nEmail: ${email}\nSenha: ${senha}\n\nO usu√°rio deve fazer o cadastro normal usando esses dados.`);

                // Limpar formul√°rio e ocultar
                ocultarFormularioNovoUsuario();

                // Recarregar lista
                carregarListaUsuarios();

            } catch (error) {
                console.error('‚ùå Erro ao criar usu√°rio:', error);
                mostrarToast('‚ùå Erro ao criar usu√°rio: ' + error.message);
            }
        }

        // Editar usu√°rio existente (admin)
        async function editarUsuarioAdmin(uid) {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                debugLog('üìù Carregando dados do usu√°rio:', uid);

                // Carregar dados do usu√°rio
                const doc = await db.collection('usuarios').doc(uid).get();

                if (!doc.exists) {
                    mostrarToast('‚ùå Usu√°rio n√£o encontrado');
                    return;
                }

                const usuario = doc.data();

                // Preencher formul√°rio
                document.getElementById('editarUsuarioUid').value = uid;
                document.getElementById('editarNomeCompleto').value = usuario.nomeCompleto || '';
                document.getElementById('editarEmail').value = usuario.email || '';
                document.getElementById('editarDataNascimento').value = usuario.dataNascimento || '';
                document.getElementById('editarGenero').value = usuario.genero || '';
                document.getElementById('editarRole').value = usuario.role || 'user';
                document.getElementById('editarStatus').value = usuario.status || 'ativo';

                // Mostrar formul√°rio e esconder outros
                document.getElementById('editarUsuarioForm').style.display = 'block';
                document.getElementById('novoUsuarioForm').style.display = 'none';

                // Scroll at√© o formul√°rio
                document.getElementById('editarUsuarioForm').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rio:', error);
                mostrarToast('‚ùå Erro ao carregar usu√°rio');
            }
        }

        // Cancelar edi√ß√£o de usu√°rio (admin)
        function cancelarEdicaoUsuarioAdmin() {
            document.getElementById('editarUsuarioForm').style.display = 'none';
        }

        // Salvar edi√ß√£o de usu√°rio (admin)
        async function salvarEdicaoUsuarioAdmin() {
            if (!currentUser) {
                mostrarToast('‚ö†Ô∏è Voc√™ precisa estar logado!');
                return;
            }

            try {
                const uid = document.getElementById('editarUsuarioUid').value;
                const nomeCompleto = document.getElementById('editarNomeCompleto').value.trim();
                const dataNascimento = document.getElementById('editarDataNascimento').value;
                const genero = document.getElementById('editarGenero').value;
                const role = document.getElementById('editarRole').value;
                const status = document.getElementById('editarStatus').value;

                // Valida√ß√£o
                if (!nomeCompleto) {
                    mostrarToast('‚ö†Ô∏è O nome completo √© obrigat√≥rio');
                    return;
                }

                debugLog('üíæ Salvando altera√ß√µes do usu√°rio:', uid);

                // Atualizar no Firestore
                const perfilAtualizado = {
                    nomeCompleto,
                    dataNascimento: dataNascimento || null,
                    genero: genero || null,
                    role: role || 'user',
                    status: status || 'ativo',
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    atualizadoPorAdmin: currentUser.email
                };

                await db.collection('usuarios').doc(uid).update(perfilAtualizado);

                debugLog('‚úÖ Usu√°rio atualizado com sucesso');
                mostrarToast('‚úÖ Usu√°rio atualizado com sucesso!');

                // Ocultar formul√°rio
                cancelarEdicaoUsuarioAdmin();

                // Recarregar lista e dashboard
                carregarListaUsuarios();
                carregarDashboardAdmin();

            } catch (error) {
                console.error('‚ùå Erro ao atualizar usu√°rio:', error);
                mostrarToast('‚ùå Erro ao atualizar usu√°rio: ' + error.message);
            }
        }

        // Salvar registro no Firestore (com valida√ß√£o de seguran√ßa)
        async function salvarRegistroFirebase(registro) {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de salvar sem autentica√ß√£o');
                return null;
            }

            try {
                // SEGURAN√áA: Salvar apenas na cole√ß√£o do usu√°rio autenticado
                const docRef = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').add({
                        ...registro,
                        criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                        // SEGURAN√áA: Adicionar UID do propriet√°rio
                        proprietario: currentUser.uid
                    });

                debugLog('‚úÖ Registro salvo no Firebase com ID:', docRef.id);
                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                document.getElementById('syncStatus').style.color = 'var(--success)';

                return docRef.id; // Retornar ID do documento
            } catch (error) {
                console.error('Erro ao salvar:', error);
                document.getElementById('syncStatus').textContent = '‚ö† Erro na sincroniza√ß√£o';
                document.getElementById('syncStatus').style.color = 'var(--danger)';
                return null;
            }
        }

        // Carregar registros do Firestore (com valida√ß√£o de seguran√ßa)
        async function carregarDadosFirebase() {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de carregar dados sem autentica√ß√£o');
                registrosEmMemoria = [];
                return;
            }

            // Se for psic√≥logo ou admin, carregar todos os registros de todos os usu√°rios
            if (window.perfilAtual && (window.perfilAtual.role === 'psicologo' || window.perfilAtual.role === 'admin')) {
                try {
                    debugLog('üì• Carregando TODOS os registros de TODOS os usu√°rios (psic√≥logo/admin)...');
                    const usuariosSnapshot = await db.collection('usuarios').get();
                    const registrosFirebase = [];
                    for (const usuarioDoc of usuariosSnapshot.docs) {
                        const usuarioId = usuarioDoc.id;
                        // Cache do nome do paciente para exibi√ß√£o no hist√≥rico
                        if (!window.pacientesNomes) window.pacientesNomes = {};
                        try {
                            const ud = usuarioDoc.data();
                            window.pacientesNomes[usuarioId] = ud?.nomeCompleto || ud?.nome || ud?.email || usuarioId;
                        } catch (e) {
                            window.pacientesNomes[usuarioId] = usuarioId;
                        }
                        const registrosSnapshot = await db.collection('usuarios').doc(usuarioId).collection('registros').get();
                        for (const doc of registrosSnapshot.docs) {
                            const data = doc.data();
                            if (!data) continue;
                            registrosFirebase.push({
                                id: data.id,
                                firebaseId: doc.id,
                                dataHora: data.dataHora,
                                situacao: data.situacao,
                                pensamento: data.pensamento,
                                emocaoCentral: data.emocaoCentral,
                                emocaoIntermediaria: data.emocaoIntermediaria,
                                emocaoEspecifica: data.emocaoEspecifica,
                                intensidade: data.intensidade,
                                comportamento: data.comportamento,
                                uid: usuarioId // Importante para filtrar por usu√°rio se necess√°rio
                            });
                        }
                    }
                    const registrosValidos = registrosFirebase.filter(r => r !== null);
                    debugLog(`‚úÖ ${registrosValidos.length} registros carregados de todos os usu√°rios`);
                    registrosEmMemoria = registrosValidos;
                    if (document.getElementById('historico').classList.contains('active')) {
                        carregarHistorico();
                    }
                    atualizarEstatisticas();
                    document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                } catch (error) {
                        console.error('‚ùå Erro ao carregar todos os registros:', error);
                        // Informa√ß√£o adicional para debug
                        console.error('Firestore error code:', error && error.code, 'message:', error && error.message);
                        document.getElementById('syncStatus').textContent = '‚ö† Erro ao sincronizar';
                        if (error && (error.code === 'permission-denied' || (error.message && error.message.includes('Missing or insufficient permissions')))) {
                            mostrarToast('‚ùå Permiss√£o negada ao carregar registros. Verifique as regras do Firestore (deploy das regras).');
                        } else {
                            mostrarToast('‚ùå Erro ao carregar registros: ' + (error && error.message || 'desconhecido'));
                        }
                }
                return;
            }

            // Usu√°rio comum: carregar apenas seus pr√≥prios registros
            try {
                debugLog('üì• Carregando dados do Firebase...');
                const snapshot = await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros')
                    .orderBy('criadoEm', 'desc')
                    .get();

                const registrosFirebase = [];
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    if (data.proprietario && data.proprietario !== currentUser.uid) {
                        console.error('‚ùå SEGURAN√áA: Registro n√£o pertence ao usu√°rio atual');
                        continue;
                    }
                    registrosFirebase.push({
                        id: data.id,
                        firebaseId: doc.id,
                        dataHora: data.dataHora,
                        situacao: data.situacao,
                        pensamento: data.pensamento,
                        emocaoCentral: data.emocaoCentral,
                        emocaoIntermediaria: data.emocaoIntermediaria,
                        emocaoEspecifica: data.emocaoEspecifica,
                        intensidade: data.intensidade,
                        comportamento: data.comportamento,
                        uid: currentUser.uid
                    });
                }
                const registrosValidos = registrosFirebase.filter(r => r !== null);
                debugLog(`‚úÖ ${registrosValidos.length} registros carregados do Firebase`);
                registrosEmMemoria = registrosValidos;
                if (document.getElementById('historico').classList.contains('active')) {
                    carregarHistorico();
                }
                atualizarEstatisticas();
                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do Firebase:', error);
                document.getElementById('syncStatus').textContent = '‚ö† Erro ao sincronizar';
            }
        }

        // Excluir registro do Firestore (com valida√ß√£o de seguran√ßa)
        async function excluirRegistroFirebase(registroId) {
            // SEGURAN√áA: Verificar se usu√°rio est√° autenticado
            if (!currentUser || !currentUser.uid) {
                console.error('‚ùå SEGURAN√áA: Tentativa de excluir sem autentica√ß√£o');
                throw new Error('N√£o autorizado');
            }

            // SEGURAN√áA: Validar formato do ID
            if (!registroId || typeof registroId !== 'string') {
                console.error('‚ùå SEGURAN√áA: ID de registro inv√°lido');
                throw new Error('ID inv√°lido');
            }

            try {
                // SEGURAN√áA: Excluir apenas da cole√ß√£o do usu√°rio autenticado
                await db.collection('usuarios').doc(currentUser.uid)
                    .collection('registros').doc(registroId).delete();

                document.getElementById('syncStatus').textContent = '‚úì Exclu√≠do';
            } catch (error) {
                console.error('Erro ao excluir:', error);
                throw error;
            }
        }

        // ---------- Offline queue and synchronization ----------
        const PENDENTES_KEY = 'diario_pendentes_v1';

        function _lerPendentes() {
            try {
                const raw = localStorage.getItem(PENDENTES_KEY) || '[]';
                return JSON.parse(raw);
            } catch (e) {
                console.error('Erro lendo pendentes:', e);
                return [];
            }
        }

        function _gravarPendentes(lista) {
            try {
                localStorage.setItem(PENDENTES_KEY, JSON.stringify(lista));
            } catch (e) {
                console.error('Erro gravando pendentes:', e);
            }
        }

        async function salvarRegistroOffline(registro) {
            const pendentes = _lerPendentes();
            const localId = 'local_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const item = {
                localId,
                registro,
                criadoEm: new Date().toISOString(),
                tentativas: 0
            };
            pendentes.push(item);
            _gravarPendentes(pendentes);

            // Colocar tamb√©m na mem√≥ria para aparecer no hist√≥rico imediatamente
            registro.localId = localId;
            registrosEmMemoria.unshift(registro);
            carregarHistorico();
            return localId;
        }

        async function sincronizarPendentes() {
            if (!navigator.onLine) {
                debugLog('üîå Offline ‚Äî n√£o sincroniza pendentes agora');
                return;
            }

            const pendentes = _lerPendentes();
            if (!pendentes || pendentes.length === 0) {
                debugLog('üîî Nenhum registro pendente para sincronizar');
                return;
            }

            debugLog(`üîî Iniciando sincroniza√ß√£o de ${pendentes.length} pendentes`);

            const restantes = [];
            for (const item of pendentes) {
                try {
                    item.tentativas = (item.tentativas || 0) + 1;
                    const firebaseId = await salvarRegistroFirebase(item.registro);
                    if (firebaseId) {
                        debugLog('‚úÖ Sincronizado localId', item.localId, '-> firebaseId', firebaseId);
                        // Atualizar mem√≥ria local: substituir localId por firebaseId
                        const idx = registrosEmMemoria.findIndex(r => r.localId === item.localId);
                        if (idx !== -1) {
                            registrosEmMemoria[idx].firebaseId = firebaseId;
                            delete registrosEmMemoria[idx].localId;
                        }
                    } else {
                        debugLog('‚ö†Ô∏è Falha ao sincronizar, manter em pendentes:', item.localId);
                        restantes.push(item);
                    }
                } catch (err) {
                    console.error('Erro ao sincronizar item', item.localId, err);
                    // Se muitas tentativas, manter para tentar depois
                    restantes.push(item);
                }
            }

            _gravarPendentes(restantes);
            debugLog(`üîî Sincroniza√ß√£o finalizada. Restantes: ${restantes.length}`);

            // Atualizar hist√≥rico e UI
            carregarHistorico();
            if (restantes.length === 0) {
                mostrarToast('‚úÖ Todos os registros pendentes foram sincronizados');
                document.getElementById('syncStatus').textContent = '‚úì Sincronizado';
                document.getElementById('syncStatus').style.color = 'var(--success)';
            } else {
                mostrarToast(`‚ö†Ô∏è ${restantes.length} registros ainda n√£o sincronizados`);
                document.getElementById('syncStatus').textContent = '‚ö† Pendentes';
                document.getElementById('syncStatus').style.color = 'var(--danger)';
            }
        }

        // Permitir Enter para fazer login
        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleEmailAuth();
                });
            }
        });
    </script>

    </div>
</body>
</html>